<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2563eb">
<title>Ginesysone Finance Task Board</title>
<link rel="manifest" href="data:application/json,{%22name%22:%22Ginesysone+Finance+Task+Board%22,%22short_name%22:%22Ginesysone%22,%22display%22:%22standalone%22,%22background_color%22:%22%232563eb%22,%22theme_color%22:%22%232563eb%22}">
<link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,400&family=Bricolage+Grotesque:opsz,wght@12..96,400;12..96,500;12..96,600;12..96,700;12..96,800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* ═══ PREMIUM THEME VARIABLES ═══ */
:root {
  --white: #ffffff; --bg: #f4f6fa; --bg2: #eaecf4;
  --surface: #ffffff; --surface2: #f8f9fc; --surface3: #eef0f7;
  --border: #e2e5f0; --border2: #c8cde0;
  --ink: #0a0f1e; --ink2: #1a2340; --ink-mid: #52607a; --ink-dim: #8892a8;
  --accent: #2056d8; --accent-light: #edf2ff; --accent-mid: #b3c6fa;
  --accent2: #6d28d9;
  --green: #0a9060; --green-bg: #eafaf3; --green-border: #8de3bc;
  --red: #d92020; --red-bg: #fff1f1; --red-border: #fbb; 
  --amber: #c97300; --amber-bg: #fff8e6; --amber-border: #f5d080;
  --blue: #2056d8; --blue-bg: #edf2ff; --blue-border: #b3c6fa;
  --purple: #6d28d9; --purple-bg: #f3eeff; --purple-border: #d0b8f8;
  --radius-sm: 8px; --radius: 12px; --radius-lg: 16px; --radius-xl: 22px;
  --shadow-xs: 0 1px 4px rgba(10,15,30,.06);
  --shadow-sm: 0 2px 8px rgba(10,15,30,.08),0 1px 2px rgba(10,15,30,.04);
  --shadow: 0 4px 16px rgba(10,15,30,.09),0 2px 4px rgba(10,15,30,.04);
  --shadow-md: 0 8px 24px rgba(10,15,30,.10),0 4px 8px rgba(10,15,30,.05);
  --shadow-lg: 0 16px 40px rgba(10,15,30,.12),0 6px 12px rgba(10,15,30,.06);
  --shadow-xl: 0 32px 64px rgba(10,15,30,.16),0 8px 16px rgba(10,15,30,.08);
  --sidebar-w: 216px; --header-h: 58px;
  --grad-accent: linear-gradient(135deg,#2056d8 0%,#6d28d9 100%);
  --grad-green: linear-gradient(135deg,#0a9060,#059669);
}
[data-theme="dark"] {
  --white: #171e30; --bg: #0f1320; --bg2: #141a2c;
  --surface: #171e30; --surface2: #1c243a; --surface3: #222d48;
  --border: #263048; --border2: #334060;
  --ink: #e4ecf8; --ink2: #bfcce0; --ink-mid: #7a90b4; --ink-dim: #4e6082;
  --accent-light: #162040; --accent-mid: #2a407a;
  --green-bg: #0a2418; --green-border: #155c38;
  --red-bg: #2a1010; --red-border: #602020;
  --amber-bg: #261c08; --amber-border: #5c3c10;
  --blue-bg: #162040; --blue-border: #2a407a;
  --purple-bg: #1c1230; --purple-border: #44206a;
  --shadow-xs: 0 1px 4px rgba(0,0,0,.3);
  --shadow-sm: 0 2px 8px rgba(0,0,0,.4),0 1px 2px rgba(0,0,0,.3);
  --shadow: 0 4px 16px rgba(0,0,0,.4),0 2px 4px rgba(0,0,0,.3);
  --shadow-md: 0 8px 24px rgba(0,0,0,.45),0 4px 8px rgba(0,0,0,.3);
  --shadow-lg: 0 16px 40px rgba(0,0,0,.5),0 6px 12px rgba(0,0,0,.35);
  --shadow-xl: 0 32px 64px rgba(0,0,0,.6);
}

*{box-sizing:border-box;margin:0;padding:0}
html{transition:background .3s,color .3s}
body{font-family:'Figtree',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;font-size:14.5px;-webkit-font-smoothing:antialiased;letter-spacing:-.01em;transition:background .25s,color .25s}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px}
::-webkit-scrollbar-thumb:hover{background:var(--ink-dim)}

/* ═══ WELCOME MODAL ═══ */
.welcome-step{display:flex;align-items:flex-start;gap:12px;padding:10px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius);transition:all .15s}
.welcome-step:hover{border-color:var(--accent-mid);background:var(--accent-light)}
.welcome-step-num{width:24px;height:24px;border-radius:50%;background:var(--grad-accent);color:#fff;font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.welcome-step-title{font-size:.84rem;font-weight:700;color:var(--ink);font-family:'Bricolage Grotesque',sans-serif;letter-spacing:-.02em}
.welcome-step-sub{font-size:.73rem;color:var(--ink-dim);margin-top:2px;line-height:1.4}


.temp-card{background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius);padding:10px 12px;box-shadow:var(--shadow-xs);transition:all .15s;position:relative}
.temp-card:hover{border-color:var(--border2);box-shadow:var(--shadow-sm);transform:translateY(-1px)}
.temp-card.done-card{background:var(--green-bg);border-color:var(--green-border);opacity:.8}
.temp-card-title{font-size:.85rem;font-weight:600;color:var(--ink);line-height:1.4;padding-right:52px}
.temp-card.done-card .temp-card-title{text-decoration:line-through;color:var(--ink-dim)}
.temp-card-actions{position:absolute;top:8px;right:8px;display:flex;gap:3px}
.temp-card-btn{width:22px;height:22px;border:none;background:none;cursor:pointer;border-radius:4px;font-size:.7rem;display:flex;align-items:center;justify-content:center;color:var(--ink-dim);transition:all .13s}
.temp-card-btn:hover{background:var(--bg2);color:var(--ink)}
.temp-card-priority{display:inline-flex;align-items:center;gap:3px;font-size:.65rem;font-weight:600;font-family:'JetBrains Mono',monospace;padding:1px 6px;border-radius:99px;margin-top:5px}
#tempBoardPanel{transition:transform .25s cubic-bezier(.4,0,.2,1)}


.note-fmt-btn{padding:4px 9px;border:none;background:none;cursor:pointer;font-size:.78rem;font-weight:600;color:var(--ink-mid);border-radius:4px;transition:all .14s;font-family:'Figtree',sans-serif}
.note-fmt-btn:hover{background:var(--white);color:var(--accent)}
.note-item{padding:10px 12px;border-radius:var(--radius-sm);cursor:pointer;border:1.5px solid transparent;transition:all .14s;background:none}
.note-item:hover{background:var(--bg);border-color:var(--border)}
.note-item.active{background:var(--accent-light);border-color:var(--accent-mid)}
.note-item-title{font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:.84rem;color:var(--ink);letter-spacing:-.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.note-item-preview{font-size:.72rem;color:var(--ink-dim);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.4}
.note-item-meta{font-size:.64rem;color:var(--ink-dim);margin-top:4px;font-family:'JetBrains Mono',monospace;display:flex;gap:6px;align-items:center}
.nb-btn{width:100%;display:flex;align-items:center;gap:7px;padding:6px 8px;border:none;background:none;cursor:pointer;font-family:'Figtree',sans-serif;font-size:.79rem;color:var(--ink-mid);text-align:left;border-radius:var(--radius-sm);transition:all .14s;font-weight:500}
.nb-btn:hover{background:var(--bg);color:var(--ink)}
.nb-btn.active{background:var(--green-bg);color:var(--green);font-weight:600}
#noteBody h1{font-family:'Bricolage Grotesque',sans-serif;font-size:1.3rem;font-weight:800;margin:12px 0 6px;letter-spacing:-.03em}
#noteBody h2{font-family:'Bricolage Grotesque',sans-serif;font-size:1.1rem;font-weight:700;margin:10px 0 4px;letter-spacing:-.02em}
#noteBody h3{font-family:'Bricolage Grotesque',sans-serif;font-size:.95rem;font-weight:700;margin:8px 0 4px}
#noteBody ul,#noteBody ol{padding-left:22px;margin:4px 0}
#noteBody li{margin:3px 0}
#noteBody code{font-family:'JetBrains Mono',monospace;background:var(--bg2);padding:1px 5px;border-radius:4px;font-size:.83rem}
#noteBody pre{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;margin:8px 0;font-family:'JetBrains Mono',monospace;font-size:.8rem;overflow-x:auto}
#noteBody hr{border:none;border-top:1.5px solid var(--border);margin:14px 0}
#noteBody input[type=checkbox]{margin-right:6px;accent-color:var(--accent);width:14px;height:14px;cursor:pointer}
.note-tag-chip{padding:2px 9px;border-radius:99px;font-size:.68rem;font-weight:600;font-family:'JetBrains Mono',monospace;cursor:pointer;border:1.5px solid var(--green-border);background:var(--green-bg);color:var(--green);transition:all .13s;display:flex;align-items:center;gap:4px}
.note-tag-chip:hover{opacity:.75}
.note-tag-filter{padding:2px 9px;border-radius:99px;font-size:.68rem;font-weight:600;font-family:'JetBrains Mono',monospace;cursor:pointer;border:1.5px solid var(--border);background:var(--bg);color:var(--ink-mid);transition:all .13s}
.note-tag-filter.active{border-color:var(--accent-mid);background:var(--accent-light);color:var(--accent)}


#authScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;overflow:hidden;background:linear-gradient(135deg,#f0f4ff 0%,#faf5ff 40%,#f0fdf9 100%)}
[data-theme="dark"] #authScreen{background:linear-gradient(135deg,#0d1525 0%,#160d2e 40%,#0d2518 100%)}
#authScreen::before{content:'';position:absolute;width:900px;height:900px;background:radial-gradient(circle,rgba(37,99,235,.06) 0%,transparent 65%);top:-300px;right:-200px;pointer-events:none}
#authScreen::after{content:'';position:absolute;width:600px;height:600px;background:radial-gradient(circle,rgba(124,58,237,.05) 0%,transparent 65%);bottom:-200px;left:-100px;pointer-events:none}
.auth-wrapper{display:flex;align-items:center;gap:80px;max-width:960px;width:100%;position:relative;z-index:1}
.auth-hero{flex:1;display:none}
@media(min-width:800px){.auth-hero{display:block}}
.auth-hero-label{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--accent);text-transform:uppercase;letter-spacing:2px;font-weight:500;margin-bottom:16px}
.auth-hero-title{font-family:'Bricolage Grotesque',sans-serif;font-size:2.4rem;font-weight:800;line-height:1.15;color:var(--ink);letter-spacing:-.03em;margin-bottom:16px}
.auth-hero-title span{background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.auth-hero-sub{font-size:.9rem;color:var(--ink-mid);line-height:1.7;margin-bottom:28px}
.auth-features{display:flex;flex-direction:column;gap:10px}
.auth-feat{display:flex;align-items:center;gap:10px;font-size:.83rem;color:var(--ink-mid)}
.auth-feat-icon{width:28px;height:28px;background:var(--accent-light);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0}
.auth-box{background:var(--white);border:1px solid var(--border);border-radius:var(--radius-xl);padding:40px 36px;width:100%;max-width:400px;box-shadow:var(--shadow-xl)}
.auth-logo{display:flex;align-items:center;gap:10px;margin-bottom:28px}
.auth-logo-mark{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Bricolage Grotesque',sans-serif;font-weight:800;font-size:13px;color:#fff;background:var(--grad-accent);box-shadow:0 4px 16px rgba(32,86,216,.38)}
.auth-logo-text{font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:1.1rem;color:var(--ink);letter-spacing:-.02em}
.auth-logo-text span{background:var(--grad-accent);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.auth-title{font-family:'Bricolage Grotesque',sans-serif;font-size:1.5rem;font-weight:700;margin-bottom:5px;letter-spacing:-.03em}
.auth-sub{font-size:.83rem;color:var(--ink-mid);margin-bottom:22px}
.auth-tabs{display:flex;background:var(--bg);border-radius:var(--radius-sm);padding:3px;margin-bottom:20px;border:1px solid var(--border);gap:2px}
.auth-tab{flex:1;padding:7px;border:none;background:none;border-radius:5px;cursor:pointer;font-family:'Figtree',sans-serif;font-size:.82rem;font-weight:600;color:var(--ink-mid);transition:all .15s}
.auth-tab.active{background:var(--white);color:var(--ink);box-shadow:var(--shadow-sm)}
.fg{display:flex;flex-direction:column;gap:5px;margin-bottom:12px}
.fg label{font-size:.7rem;font-weight:600;color:var(--ink-mid);letter-spacing:.06em;text-transform:uppercase}
.input{width:100%;padding:10px 13px;background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:'Figtree',sans-serif;font-size:.88rem;color:var(--ink);outline:none;transition:all .18s;letter-spacing:-.01em}
.input::placeholder{color:var(--ink-dim)}
.input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(32,86,216,.12);background:var(--white)}
select.input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239099ae' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;background-color:var(--white);padding-right:32px}
select option{background:var(--white);color:var(--ink)}
.btn{padding:10px 18px;border:none;border-radius:var(--radius-sm);cursor:pointer;font-family:'Figtree',sans-serif;font-weight:600;font-size:.86rem;transition:all .18s;display:inline-flex;align-items:center;justify-content:center;gap:6px;width:100%;letter-spacing:-.01em}
.btn-primary{background:var(--grad-accent);color:#fff;box-shadow:0 3px 12px rgba(32,86,216,.35),0 1px 2px rgba(32,86,216,.2)}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(32,86,216,.45),0 2px 4px rgba(32,86,216,.2)}
.btn-ghost{background:var(--white);border:1.5px solid var(--border);color:var(--ink-mid);width:auto;}
.btn-ghost:hover{border-color:var(--accent-mid);color:var(--ink);background:var(--accent-light)}
.btn-danger{background:var(--white);border:1.5px solid var(--red-border);color:var(--red);width:auto}
.btn-danger:hover{background:var(--red-bg)}
.btn-sm{padding:7px 13px;font-size:.78rem;width:auto}
.btn-xs{padding:4px 9px;font-size:.72rem;width:auto}
.btn-icon{width:30px;height:30px;padding:0;border-radius:var(--radius-sm);background:none;border:1.5px solid var(--border);color:var(--ink-mid);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-size:.85rem;transition:all .15s}
.btn-icon:hover{background:var(--bg);color:var(--ink)}
.auth-err{color:var(--red);font-size:.78rem;margin-bottom:10px;display:none;background:var(--red-bg);padding:9px 12px;border-radius:var(--radius-sm);border:1px solid var(--red-border)}
.auth-info{font-size:.72rem;color:var(--ink-dim);margin-top:16px;text-align:center;line-height:1.7}
.auth-info strong{color:var(--ink-mid);font-weight:600}

/* ═══ LAYOUT ═══ */
#app{display:none}
.header{display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:var(--header-h);background:rgba(255,255,255,.97);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;gap:12px;box-shadow:0 1px 0 var(--border),0 4px 20px rgba(10,15,30,.06)}
[data-theme="dark"] .header{background:rgba(15,19,32,.97)}
.logo{display:flex;align-items:center;gap:9px;text-decoration:none}
.logo-mark{width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Bricolage Grotesque',sans-serif;font-weight:800;font-size:12px;color:#fff;background:var(--grad-accent);box-shadow:0 3px 12px rgba(32,86,216,.35)}
.logo-text{font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:1rem;color:var(--ink);letter-spacing:-.02em}
.logo-text span{background:var(--grad-accent);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.global-search-wrap{position:relative;flex:1;max-width:300px}
.global-search-input{width:100%;padding:8px 12px 8px 34px;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius);font-family:'Figtree',sans-serif;font-size:.83rem;color:var(--ink);outline:none;transition:all .18s;letter-spacing:-.01em}
.global-search-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(32,86,216,.12);background:var(--white)}
.global-search-input::placeholder{color:var(--ink-dim)}
.global-search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:.8rem;opacity:.4}
.global-search-results{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-lg);z-index:500;max-height:320px;overflow-y:auto;display:none}
.gsr-item{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .12s}
.gsr-item:last-child{border-bottom:none}
.gsr-item:hover{background:var(--bg)}
.gsr-title{font-family:'Bricolage Grotesque',sans-serif;font-size:.84rem;font-weight:500;color:var(--ink);letter-spacing:-.02em}
.gsr-meta{font-size:.72rem;color:var(--ink-dim);margin-top:1px}
.header-right{display:flex;gap:5px;align-items:center}
.nav-tabs{display:flex;gap:2px;background:var(--bg2);padding:3px;border-radius:var(--radius-sm);border:1px solid var(--border)}
.tab{padding:5px 14px;border:none;background:none;cursor:pointer;font-family:'Figtree',sans-serif;font-size:.8rem;font-weight:600;color:var(--ink-mid);border-radius:6px;transition:all .15s;letter-spacing:-.01em}
.tab:hover{color:var(--ink);background:rgba(255,255,255,.8)}
.tab.active{background:var(--white);color:var(--accent);box-shadow:var(--shadow-sm);font-weight:600}
.user-chip{display:flex;align-items:center;gap:7px;background:var(--white);border:1.5px solid var(--border);border-radius:99px;padding:4px 12px 4px 4px;font-size:.79rem;font-weight:600;color:var(--ink-mid)}
.role-badge{font-size:.58rem;padding:2px 7px;border-radius:99px;font-family:'JetBrains Mono',monospace;font-weight:600;text-transform:uppercase;letter-spacing:.8px}
.role-admin{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border)}
.role-member{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-border)}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--green);flex-shrink:0;animation:pulse 2.5s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(5,150,105,.4)}70%{box-shadow:0 0 0 5px rgba(5,150,105,0)}100%{box-shadow:0 0 0 0 rgba(5,150,105,0)}}
.sync-label{font-size:.7rem;color:var(--green);font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:5px;font-weight:500}
.h-divider{width:1px;height:18px;background:var(--border);margin:0 2px}
.app-body{display:flex;height:calc(100vh - var(--header-h));overflow:hidden}

/* ═══ SIDEBAR ═══ */
.sidebar{width:var(--sidebar-w);background:var(--white);border-right:1px solid var(--border);overflow-y:auto;flex-shrink:0;padding:16px 12px;transition:width .25s cubic-bezier(.4,0,.2,1),padding .25s;position:relative}
.sidebar.collapsed{width:0;padding:0;overflow:hidden}
.sidebar-toggle{position:absolute;right:-13px;top:20px;width:26px;height:26px;background:var(--white);border:1.5px solid var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.7rem;color:var(--ink-dim);z-index:10;box-shadow:var(--shadow-sm);transition:all .18s}
.sidebar-toggle:hover{color:var(--ink);border-color:var(--border2)}
.sidebar-section{margin-bottom:20px}
.sidebar-label{font-family:'JetBrains Mono',monospace;font-size:.56rem;color:var(--ink-dim);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;padding:0 6px;font-weight:500}
.filter-btn{width:100%;display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:var(--radius-sm);border:none;background:none;cursor:pointer;font-family:'Figtree',sans-serif;font-size:.8rem;color:var(--ink-mid);text-align:left;transition:all .14s;margin-bottom:1px;font-weight:500;letter-spacing:-.01em}
.filter-btn:hover{background:var(--bg);color:var(--ink)}
.filter-btn.active{background:var(--accent-light);color:var(--accent);font-weight:600;border-radius:var(--radius-sm)}
.fdot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.fcount{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:.6rem;background:var(--bg2);padding:1px 6px;border-radius:99px;color:var(--ink-dim)}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.stat-card{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius);padding:11px 12px;cursor:pointer;transition:all .18s;box-shadow:none}
.stat-card:hover{border-color:var(--accent);background:var(--accent-light);transform:translateY(-2px);box-shadow:var(--shadow)}
.stat-num{font-family:'Bricolage Grotesque',sans-serif;font-size:1.5rem;font-weight:700;line-height:1;letter-spacing:-.04em;color:var(--ink)}
.stat-lbl{font-size:.55rem;color:var(--ink-dim);margin-top:4px;text-transform:uppercase;letter-spacing:1px;font-family:'JetBrains Mono',monospace;font-weight:500}
.due-filter-btn{width:100%;display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:var(--radius-sm);border:none;background:none;cursor:pointer;font-family:'Figtree',sans-serif;font-size:.79rem;color:var(--ink-mid);text-align:left;transition:all .14s;font-weight:500;margin-bottom:1px}
.due-filter-btn:hover{background:var(--bg);color:var(--ink)}
.due-filter-btn.active{background:var(--amber-bg);color:var(--amber);font-weight:600}

/* ═══ MAIN ═══ */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
.dash-switcher{display:flex;gap:8px;background:var(--white);border-bottom:1px solid var(--border);padding:10px 20px;align-items:center}
.dash-tab{display:flex;align-items:center;gap:7px;padding:7px 16px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-family:'Figtree',sans-serif;font-size:.83rem;font-weight:600;color:var(--ink-mid);border-radius:99px;transition:all .18s;white-space:nowrap;box-shadow:none;letter-spacing:-.01em}
.dash-tab:hover{border-color:var(--border2);color:var(--ink)}
.dash-tab.active{border-color:transparent;color:#fff;background:var(--grad-accent);box-shadow:0 4px 14px rgba(32,86,216,.35);font-weight:600}
.dash-tab.active.team{background:linear-gradient(135deg,var(--accent2),#4c1d95);box-shadow:0 4px 14px rgba(109,40,217,.35)}
.dash-badge{font-family:'JetBrains Mono',monospace;font-size:.6rem;padding:1px 7px;border-radius:99px;font-weight:600;background:rgba(255,255,255,.2);color:inherit;border:1px solid rgba(255,255,255,.25)}
.dash-tab:not(.active) .dash-badge{background:var(--bg2);color:var(--ink-mid);border-color:var(--border)}
.toolbar{display:flex;align-items:center;gap:8px;padding:10px 20px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;background:var(--white)}
.view-toggle{display:flex;gap:1px;background:var(--bg2);padding:2px;border-radius:var(--radius-sm);border:1px solid var(--border)}
.view-btn{padding:5px 10px;border:none;background:none;cursor:pointer;font-size:.78rem;font-weight:600;color:var(--ink-mid);border-radius:4px;transition:all .14s;display:flex;align-items:center;gap:4px}
.view-btn.active{background:var(--white);color:var(--accent);box-shadow:var(--shadow-sm);font-weight:700}
.view-btn:hover:not(.active){color:var(--ink)}
.search-wrap{position:relative;flex:1;min-width:140px;max-width:240px}
.search-input{width:100%;padding:8px 12px 8px 32px;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius);font-family:'Figtree',sans-serif;font-size:.82rem;color:var(--ink);outline:none;transition:all .18s;letter-spacing:-.01em}
.search-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(32,86,216,.12);background:var(--white)}
.search-input::placeholder{color:var(--ink-dim)}
.si{position:absolute;left:9px;top:50%;transform:translateY(-50%);font-size:.78rem;opacity:.4}
.tc{font-size:.72rem;color:var(--ink-dim);font-family:'JetBrains Mono',monospace;margin-left:auto;white-space:nowrap}
.btn-new-task{background:var(--grad-accent);color:#fff;padding:8px 18px;border:none;border-radius:var(--radius-sm);cursor:pointer;font-family:'Figtree',sans-serif;font-weight:600;font-size:.84rem;display:inline-flex;align-items:center;gap:6px;box-shadow:0 3px 14px rgba(32,86,216,.38);transition:all .18s;white-space:nowrap;letter-spacing:-.01em}
.btn-new-task:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(32,86,216,.48)}
/* Bulk select toolbar */
.bulk-toolbar{display:none;align-items:center;gap:8px;padding:8px 18px;background:var(--accent-light);border-bottom:1px solid var(--accent-mid);flex-shrink:0}
.bulk-toolbar.visible{display:flex}
.bulk-count{font-size:.82rem;font-weight:700;color:var(--accent)}

/* ═══ GRID ═══ */
.grid-wrap{flex:1;overflow:auto;padding:14px 18px;background:var(--bg)}

/* ═══ KANBAN ═══ */
.board-view{display:flex;gap:14px;align-items:flex-start;min-width:max-content;height:100%}
.kanban-col{width:280px;flex-shrink:0;display:flex;flex-direction:column;background:var(--bg2);border:1.5px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;max-height:100%}
.kanban-col-header{display:flex;align-items:center;gap:8px;padding:11px 14px;background:var(--white);border-bottom:1px solid var(--border);flex-shrink:0}
.kanban-col-title{font-family:'Bricolage Grotesque',sans-serif;font-size:.88rem;font-weight:700;letter-spacing:-.01em;flex:1}
.kanban-col-count{font-family:'JetBrains Mono',monospace;font-size:.62rem;padding:2px 8px;border-radius:99px;font-weight:600}
.kanban-col-toggle{font-size:.7rem;color:var(--ink-dim);border:none;background:none;cursor:pointer;padding:3px;border-radius:4px;transition:all .12s}
.kanban-col-toggle:hover{background:var(--bg2);color:var(--ink)}
.kanban-cards{display:flex;flex-direction:column;gap:8px;padding:10px;overflow-y:auto;flex:1;min-height:80px;transition:background .15s}
.kanban-cards.drag-over{background:var(--accent-light);border-radius:var(--radius)}
.kanban-empty{padding:24px 12px;text-align:center}
.kanban-empty-icon{font-size:1.8rem;margin-bottom:6px}
.kanban-empty-text{font-size:.75rem;color:var(--ink-dim);font-weight:500}

/* ═══ TASK CARDS ═══ */
.task-card{background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius);padding:13px 14px;cursor:pointer;transition:all .2s;animation:cardIn .22s ease forwards;position:relative;box-shadow:var(--shadow-xs)}
.task-card:hover{border-color:var(--accent-mid);box-shadow:var(--shadow-md);transform:translateY(-2px)}
.task-card.dragging{opacity:.5;transform:scale(.98)}
.task-card.selected{border-color:var(--accent);background:var(--accent-light);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
@keyframes cardIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
.ct{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;align-items:center}
.card-title{font-family:'Bricolage Grotesque',sans-serif;font-weight:500;font-size:.87rem;line-height:1.4;margin-bottom:5px;color:var(--ink);letter-spacing:-.02em}
.card-title.done-title{text-decoration:line-through;color:var(--ink-dim);opacity:.5;font-weight:400}
.card-desc{font-size:.75rem;color:var(--ink-mid);overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;margin-bottom:10px;line-height:1.55}
.cb{display:flex;align-items:center;justify-content:space-between;gap:6px}
.card-progress{margin-bottom:9px}
.card-progress-bar{height:4px;background:var(--bg2);border-radius:99px;overflow:hidden}
.card-progress-fill{height:100%;border-radius:99px;background:var(--green);transition:width .3s}
.card-progress-label{font-size:.62rem;color:var(--ink-dim);font-family:'JetBrains Mono',monospace;margin-bottom:3px}
.card-menu-btn{position:absolute;top:9px;right:9px;width:24px;height:24px;border-radius:5px;border:none;background:none;cursor:pointer;color:var(--ink-dim);font-size:.75rem;display:flex;align-items:center;justify-content:center;opacity:0;transition:all .14s}
.task-card:hover .card-menu-btn{opacity:1}
.card-menu-btn:hover{background:var(--bg2);color:var(--ink)}
.card-select-btn{position:absolute;top:7px;right:30px;width:16px;height:16px;border-radius:4px;border:2px solid var(--border2);background:var(--white);cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:all .14s;flex-shrink:0;z-index:3}
.task-card:hover .card-select-btn,.task-card.selected .card-select-btn{opacity:1}
.task-card.selected .card-select-btn{background:var(--accent);border-color:var(--accent)}
.task-card.selected .card-select-btn::after{content:'✓';color:#fff;font-size:.5rem;font-weight:800}
.card-dropdown{position:absolute;right:9px;top:34px;background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-lg);z-index:50;min-width:160px;overflow:hidden;display:none}
.card-dropdown.open{display:block;animation:dropIn .15s ease}
@keyframes dropIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:none}}
.card-menu-item{display:flex;align-items:center;gap:8px;padding:9px 13px;font-size:.8rem;font-weight:500;color:var(--ink-mid);cursor:pointer;border:none;background:none;width:100%;text-align:left;transition:background .12s}
.card-menu-item:hover{background:var(--bg);color:var(--ink)}
.card-menu-item.danger{color:var(--red)}
.card-menu-item.danger:hover{background:var(--red-bg)}
.badge{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:99px;font-size:.63rem;font-weight:700;font-family:'JetBrains Mono',monospace;white-space:nowrap;letter-spacing:.02em;border:1px solid transparent}
.avatar{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;flex-shrink:0;font-family:'Figtree',sans-serif;letter-spacing:-.03em}
.tag{display:inline-flex;align-items:center;gap:2px;padding:2px 7px;border-radius:99px;font-size:.62rem;font-weight:600;font-family:'JetBrains Mono',monospace;border:1px solid;cursor:pointer}
.card-tags{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:7px}
.card-meta-icons{display:flex;align-items:center;gap:6px}
.meta-icon{font-size:.68rem;color:var(--ink-dim);display:flex;align-items:center;gap:2px;font-weight:500}
.checkbox-btn{width:20px;height:20px;border-radius:6px;border:2px solid var(--border2);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.checkbox-btn:hover{border-color:var(--green);background:var(--green-bg);}
.checkbox-btn.checked{background:var(--green);border-color:var(--green)}
.checkbox-btn.checked::after{content:'✓';color:#fff;font-size:.65rem;font-weight:800}
/* Time tracking badge */
.time-badge{font-size:.62rem;color:var(--ink-dim);font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:3px}
.time-badge.active{color:var(--accent);animation:blink 1.4s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.5}}

/* ═══ LIST VIEW ═══ */
.list-view-table{width:100%;border-collapse:collapse;background:var(--white);border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-sm);border:1.5px solid var(--border)}
.list-view-table thead th{background:var(--bg);color:var(--ink-mid);padding:10px 14px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:.6rem;text-transform:uppercase;letter-spacing:.8px;white-space:nowrap;border-bottom:1.5px solid var(--border);font-weight:600}
.list-view-table tbody td{padding:11px 14px;border-bottom:1px solid var(--border);vertical-align:middle}
.list-view-table tbody tr:last-child td{border-bottom:none}
.list-view-table tbody tr{cursor:pointer;transition:background .12s}
.list-view-table tbody tr:hover{background:var(--bg)}
.list-view-table tbody tr.done-row td .lv-title{text-decoration:line-through;color:var(--ink-dim)}
.lv-title{font-family:'Bricolage Grotesque',sans-serif;font-weight:500;font-size:.86rem;color:var(--ink);letter-spacing:-.02em}
.lv-desc{font-size:.73rem;color:var(--ink-mid);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px}

/* ═══ CALENDAR ═══ */
.calendar-wrap{padding:14px 18px;flex:1;overflow:auto}
.cal-header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.cal-nav{border:1.5px solid var(--border);border-radius:var(--radius-sm);background:var(--white);padding:6px 12px;cursor:pointer;font-size:.8rem;font-weight:600;color:var(--ink-mid);transition:all .15s}
.cal-nav:hover{border-color:var(--border2);color:var(--ink)}
.cal-month-title{font-family:'Bricolage Grotesque',sans-serif;font-size:1.3rem;font-weight:700;letter-spacing:-.02em}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-day-label{text-align:center;font-family:'JetBrains Mono',monospace;font-size:.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--ink-dim);padding:6px}
.cal-day{min-height:90px;border:1.5px solid var(--border);border-radius:var(--radius);background:var(--white);padding:8px;box-shadow:var(--shadow-xs);transition:border-color .15s}
.cal-day:hover{border-color:var(--accent-mid)}
.cal-day.other-month{background:var(--bg);opacity:.6}
.cal-day.today{border-color:var(--accent);background:var(--accent-light)}
.cal-date{font-size:.72rem;font-weight:700;color:var(--ink-mid);margin-bottom:4px}
.cal-day.today .cal-date{color:var(--accent)}
.cal-task-chip{display:block;padding:2px 6px;border-radius:4px;font-size:.62rem;font-weight:600;margin-bottom:2px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* ═══ WORKLOAD VIEW ═══ */
.workload-wrap{padding:14px 18px;flex:1;overflow:auto}
.workload-row{display:flex;align-items:center;gap:14px;padding:12px 16px;background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius);margin-bottom:8px;box-shadow:var(--shadow-xs)}
.workload-bar-wrap{flex:1;background:var(--bg2);border-radius:99px;height:10px;overflow:hidden}
.workload-bar{height:100%;border-radius:99px;transition:width .6s cubic-bezier(.4,0,.2,1)}
.workload-label{font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:600;min-width:30px;text-align:right}

/* ═══ EMPTY STATE ═══ */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;min-height:260px;gap:10px;color:var(--ink-dim)}
.empty-icon{font-size:3rem;margin-bottom:4px}
.empty-title{font-size:1rem;font-weight:700;color:var(--ink-mid)}
.empty-sub{font-size:.8rem;color:var(--ink-dim);text-align:center;max-width:260px;line-height:1.5}
.ei{font-size:2.5rem}

/* ═══ MODAL ═══ */
.overlay{position:fixed;inset:0;background:rgba(15,22,35,.38);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:200;padding:16px}
.modal{background:var(--white);border-radius:var(--radius-lg);border:1px solid var(--border);box-shadow:var(--shadow-xl);width:100%;max-width:520px;max-height:92vh;overflow-y:auto;animation:modalIn .22s cubic-bezier(.34,1.56,.64,1)}
.modal-lg{max-width:700px}
@keyframes modalIn{from{opacity:0;transform:scale(.94) translateY(10px)}to{opacity:1;transform:none}}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 22px 0}
.modal-title{font-family:'Bricolage Grotesque',sans-serif;font-size:1.15rem;font-weight:700;letter-spacing:-.02em;color:var(--ink)}
.icon-btn{background:none;border:none;cursor:pointer;color:var(--ink-dim);font-size:.9rem;padding:5px 8px;border-radius:5px;line-height:1;transition:all .14s}
.icon-btn:hover{background:var(--bg2);color:var(--ink)}
.form-body{padding:18px 22px 22px;display:flex;flex-direction:column;gap:13px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form-actions{display:flex;justify-content:flex-end;gap:8px;padding-top:4px}

/* Subtasks */
.subtask-list{display:flex;flex-direction:column;gap:5px;margin-top:4px}
.subtask-item{display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm)}
.subtask-item input[type=checkbox]{accent-color:var(--green);cursor:pointer;flex-shrink:0}
.subtask-text{font-size:.8rem;flex:1;color:var(--ink)}
.subtask-text.done{text-decoration:line-through;color:var(--ink-dim)}
.subtask-del{border:none;background:none;cursor:pointer;color:var(--ink-dim);font-size:.72rem;padding:2px 4px;border-radius:3px;transition:all .12s}
.subtask-del:hover{background:var(--red-bg);color:var(--red)}
.subtask-add{display:flex;gap:6px;margin-top:6px}
.subtask-input{flex:1;padding:6px 10px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:'Figtree',sans-serif;font-size:.8rem;color:var(--ink);outline:none;background:var(--white)}
.subtask-input:focus{border-color:var(--accent)}
/* Tag editor */
.tag-editor{display:flex;flex-wrap:wrap;gap:4px;padding:6px;border:1.5px solid var(--border);border-radius:var(--radius-sm);min-height:36px;cursor:text;background:var(--white)}
.tag-editor:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.tag-editor-input{border:none;outline:none;font-family:'Figtree',sans-serif;font-size:.82rem;flex:1;min-width:80px;background:transparent;color:var(--ink)}
.tag-badge{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:99px;font-size:.7rem;font-weight:600}
.tag-badge button{border:none;background:none;cursor:pointer;opacity:.7;font-size:.65rem;line-height:1;padding:0}
/* Rich text toolbar */
.richtext-toolbar{display:flex;gap:4px;padding:5px 8px;border:1.5px solid var(--border);border-top:none;background:var(--bg);border-radius:0 0 var(--radius-sm) var(--radius-sm)}
.rt-btn{padding:3px 7px;border:none;border-radius:4px;background:none;cursor:pointer;font-size:.78rem;color:var(--ink-mid);transition:all .12s;font-weight:600}
.rt-btn:hover{background:var(--border);color:var(--ink)}
.rt-btn.active{background:var(--accent-light);color:var(--accent)}
.richtext-area{border:1.5px solid var(--border);border-bottom:none;border-radius:var(--radius-sm) var(--radius-sm) 0 0;padding:10px 13px;min-height:80px;font-family:'Figtree',sans-serif;font-size:.88rem;color:var(--ink);outline:none;background:var(--white);resize:vertical}
.richtext-area:focus{border-color:var(--accent)}
/* Recurring */
.recur-opts{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.recur-btn{padding:5px 12px;border:1.5px solid var(--border);border-radius:99px;background:var(--white);cursor:pointer;font-size:.75rem;font-weight:600;color:var(--ink-mid);transition:all .15s}
.recur-btn.active{border-color:var(--accent);background:var(--accent-light);color:var(--accent)}

/* ═══ COMPLIANCE ═══ */
.compliance-page{flex:1;overflow:hidden;display:flex;flex-direction:column;height:100%;min-height:0}
.c-sticky-header{background:var(--bg);border-bottom:1.5px solid var(--border);padding:12px 20px;flex-shrink:0;display:flex;flex-direction:column;gap:10px;z-index:10}
.c-content-scroll{flex:1;overflow:hidden;padding:16px 20px;display:flex;flex-direction:column;min-height:0}

.compliance-filters{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap}
.compliance-table-wrap{background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius-lg);overflow:auto;flex:1;min-height:200px}
.compliance-table{width:100%;border-collapse:collapse}
.compliance-table thead{position:sticky;top:0;z-index:2}
.compliance-table thead tr{background:var(--bg);border-bottom:2px solid var(--border)}
.compliance-table th{padding:10px 14px;text-align:left;font-size:.62rem;text-transform:uppercase;letter-spacing:1.5px;font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--ink-dim);white-space:nowrap}
.compliance-table tbody tr{border-bottom:1px solid var(--border);transition:background .12s;cursor:pointer}
.compliance-table tbody tr:last-child{border-bottom:none}
.compliance-table tbody tr:hover{background:var(--bg)}
.compliance-table td{padding:12px 14px;font-size:.83rem;color:var(--ink);vertical-align:middle}
.compliance-table td.td-name{font-weight:500;color:var(--ink);font-family:'Bricolage Grotesque',sans-serif;font-size:.9rem;letter-spacing:-.02em}
.compliance-table td.td-type span{display:inline-block;padding:3px 9px;border-radius:99px;font-size:.7rem;font-weight:700;font-family:'JetBrains Mono',monospace}
.compliance-table td.td-task a{color:var(--accent);text-decoration:none;font-weight:600;font-size:.8rem;cursor:pointer}
.compliance-table td.td-task a:hover{text-decoration:underline}
.compliance-table td.td-remarks{color:var(--ink-mid);font-size:.79rem;max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cs-status{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:99px;font-size:.7rem;font-weight:700;white-space:nowrap}
.cs-status.pending{background:var(--amber-bg);color:var(--amber);border:1px solid var(--amber-border)}
.cs-status.in_progress{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-border)}
.cs-status.completed{background:var(--green-bg);color:var(--green);border:1px solid var(--green-border)}
.cs-status.overdue{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border)}
.compliance-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;gap:12px;color:var(--ink-dim)}
.compliance-empty-icon{font-size:2.5rem;opacity:.4}
.compliance-empty-title{font-family:'Bricolage Grotesque',sans-serif;font-size:1.1rem;font-weight:700;color:var(--ink-mid)}
.compliance-empty-sub{font-size:.82rem;text-align:center;max-width:280px;line-height:1.6}
.compliance-row-actions{display:flex;gap:5px;opacity:0;transition:opacity .14s}
.compliance-table tbody tr:hover .compliance-row-actions{opacity:1}

/* compliance view toggle */
.c-view-toggle{display:flex;gap:1px;background:var(--bg2);padding:2px;border-radius:var(--radius-sm);border:1px solid var(--border)}
.c-view-btn{padding:5px 11px;border:none;background:none;cursor:pointer;font-size:.78rem;font-weight:600;color:var(--ink-mid);border-radius:4px;transition:all .14s;display:flex;align-items:center;gap:4px}
.c-view-btn.active{background:var(--white);color:var(--accent);box-shadow:var(--shadow-sm)}
.c-view-btn:hover:not(.active){color:var(--ink)}
/* compliance board */
.c-board{display:flex;gap:12px;align-items:flex-start;overflow-x:auto;flex:1;padding-bottom:8px;min-height:0}
.c-col{width:262px;flex-shrink:0;background:var(--bg2);border:1.5px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;display:flex;flex-direction:column;max-height:100%}
.c-col-header{display:flex;align-items:center;gap:8px;padding:10px 13px;background:var(--white);border-bottom:1px solid var(--border);flex-shrink:0}
.c-col-title{font-family:'Bricolage Grotesque',sans-serif;font-size:.85rem;font-weight:700;flex:1;letter-spacing:-.01em}
.c-col-count{font-family:'JetBrains Mono',monospace;font-size:.62rem;padding:2px 7px;border-radius:99px;font-weight:600}
.c-col-cards{display:flex;flex-direction:column;gap:8px;padding:10px;overflow-y:auto;flex:1;min-height:50px}
.c-card{background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius);padding:12px 13px;cursor:pointer;transition:all .18s}
.c-card:hover{border-color:var(--accent-mid);box-shadow:var(--shadow-md);transform:translateY(-1px)}
.c-card-title{font-weight:500;font-size:.84rem;color:var(--ink);margin-bottom:6px;line-height:1.35;font-family:'Bricolage Grotesque',sans-serif;letter-spacing:-.02em}
.c-card-meta{display:flex;flex-wrap:wrap;gap:5px;align-items:center;margin-bottom:6px}
.c-card-type{display:inline-block;padding:2px 8px;border-radius:99px;font-size:.65rem;font-weight:700;font-family:'JetBrains Mono',monospace}
.c-card-due{font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--ink-mid)}
.c-card-due.overdue{color:var(--red);font-weight:700}
.c-card-month{font-size:.7rem;color:var(--ink-dim)}
.c-card-footer{display:flex;align-items:center;justify-content:space-between;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
.c-card-actions{display:flex;gap:4px;opacity:0;transition:opacity .14s}
.c-card:hover .c-card-actions{opacity:1}
.c-col-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px 10px;color:var(--ink-dim);font-size:.76rem;text-align:center;opacity:.55}
/* compliance list */
.c-list{display:flex;flex-direction:column;gap:6px;flex:1;overflow-y:auto;min-height:0}
.c-list-item{background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius);padding:11px 16px;cursor:pointer;transition:all .16s;display:grid;grid-template-columns:1fr auto auto auto auto;gap:12px;align-items:center}
.c-list-item:hover{border-color:var(--accent-mid);box-shadow:var(--shadow-sm);transform:translateX(2px)}
.c-list-name{font-weight:500;font-size:.86rem;color:var(--ink);font-family:'Bricolage Grotesque',sans-serif;letter-spacing:-.02em}
.c-list-sub{font-size:.72rem;color:var(--ink-dim);margin-top:2px}
.c-list-actions{display:flex;gap:4px;opacity:0;transition:opacity .14s}
.c-list-item:hover .c-list-actions{opacity:1}
.c-view-wrap{flex:1;overflow:hidden;display:flex;flex-direction:column;min-height:0;height:100%}
.c-task-panel{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius);padding:12px 14px;margin-top:8px;display:none;flex-direction:column;gap:10px}
.c-task-panel.open{display:flex}
.c-task-mode-tabs{display:flex;gap:4px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:3px}
.c-task-mode-tab{flex:1;padding:6px;border:none;background:none;border-radius:4px;cursor:pointer;font-family:"Figtree",sans-serif;font-size:.79rem;font-weight:600;color:var(--ink-mid);transition:all .14s;text-align:center}
.c-task-mode-tab.active{background:var(--white);color:var(--ink);box-shadow:var(--shadow-sm)}
.c-recur-opts{display:flex;gap:6px;flex-wrap:wrap;padding:4px 0}
.c-recur-btn{padding:5px 13px;border:1.5px solid var(--border);border-radius:99px;background:var(--white);cursor:pointer;font-size:.75rem;font-weight:600;color:var(--ink-mid);transition:all .15s;font-family:"Figtree",sans-serif}
.c-recur-btn.active{border-color:var(--accent);background:var(--accent-light);color:var(--accent)}
.recur-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:99px;font-size:.67rem;font-weight:700;font-family:"JetBrains Mono",monospace;background:var(--accent-light);color:var(--accent);border:1px solid var(--accent-mid)}

.detail-panel{width:400px;flex-shrink:0;background:var(--white);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;animation:panelIn .22s cubic-bezier(.4,0,.2,1)}
@keyframes panelIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:none}}
.dh{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--bg)}
.db{flex:1;overflow-y:auto;padding:18px}
.detail-title{font-family:'Bricolage Grotesque',sans-serif;font-size:1.18rem;font-weight:500;line-height:1.35;margin-bottom:10px;letter-spacing:-.03em;color:var(--ink)}
.meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:14px;margin-bottom:16px}
.mi{display:flex;flex-direction:column;gap:4px}
.ml{font-size:.57rem;text-transform:uppercase;letter-spacing:1px;color:var(--ink-dim);font-family:'JetBrains Mono',monospace}
.ms{border:none;background:none;font-family:'Figtree',sans-serif;font-size:.83rem;font-weight:600;color:var(--ink);cursor:pointer;padding:0;outline:none;width:100%}
.detail-desc{font-size:.83rem;color:var(--ink-mid);line-height:1.65;margin-bottom:16px}
.stitle{font-size:.57rem;text-transform:uppercase;letter-spacing:1px;color:var(--ink-dim);font-family:'JetBrains Mono',monospace;margin-bottom:10px;font-weight:500}
.comments-list{display:flex;flex-direction:column;gap:11px;margin-bottom:14px}
.cmt{display:flex;gap:9px}.cmtb{flex:1}
.cmth{display:flex;align-items:center;gap:6px;margin-bottom:3px}
.ca{font-weight:600;font-size:.8rem;color:var(--ink)}
.ct2{font-size:.63rem;color:var(--ink-dim);font-family:'JetBrains Mono',monospace}
.cdel{margin-left:auto;font-size:.63rem;color:var(--red);border:none;background:none;cursor:pointer;font-family:'Figtree',sans-serif;font-weight:600}
.cmtt{font-size:.81rem;color:var(--ink-mid);line-height:1.6}
.cmt-reactions{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}
.reaction-btn{padding:2px 7px;border:1px solid var(--border);border-radius:99px;background:var(--bg);cursor:pointer;font-size:.72rem;transition:all .13s;display:flex;align-items:center;gap:2px}
.reaction-btn:hover,.reaction-btn.active{border-color:var(--accent-mid);background:var(--accent-light)}
.cform{display:flex;gap:9px;align-items:flex-start;margin-bottom:14px}
.cwrap{flex:1;display:flex;flex-direction:column;gap:6px}
.alist{display:flex;flex-direction:column;gap:8px}
.ait{display:flex;align-items:baseline;gap:8px}
.adot{width:6px;height:6px;background:var(--border2);border-radius:50%;flex-shrink:0}
.atxt{font-size:.78rem;color:var(--ink-mid);flex:1;line-height:1.45}
.atime{font-size:.63rem;color:var(--ink-dim);font-family:'JetBrains Mono',monospace;white-space:nowrap}
.detail-progress{margin-bottom:16px}
.detail-progress-bar{height:6px;background:var(--bg2);border-radius:99px;overflow:hidden}
.detail-progress-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--accent),var(--green));transition:width .4s}
.detail-progress-label{font-size:.7rem;color:var(--ink-mid);margin-bottom:5px;display:flex;justify-content:space-between}
/* Time tracker in detail */
.time-tracker{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:14px;margin-bottom:14px;display:flex;align-items:center;gap:12px}
.timer-display{font-family:'JetBrains Mono',monospace;font-size:1.15rem;font-weight:600;color:var(--ink);letter-spacing:.04em}
.timer-display.running{color:var(--accent);animation:timerPulse 1.5s ease-in-out infinite}
@keyframes timerPulse{0%,100%{opacity:1}50%{opacity:.7}}
/* Watcher */
.watchers-row{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}

/* ═══ FEED ═══ */
.feed-page{flex:1;overflow-y:auto;padding:26px;max-width:680px}
.pg-title{font-family:'Bricolage Grotesque',sans-serif;font-size:1.45rem;font-weight:700;margin-bottom:4px;letter-spacing:-.03em}
.pg-sub{font-size:.84rem;color:var(--ink-dim);margin-bottom:22px;font-weight:400}
.feed-item{display:flex;align-items:baseline;gap:12px;padding:13px 0;border-bottom:1px solid var(--border)}
.fc{flex:1;font-size:.83rem;line-height:1.55}
.fact{font-weight:700;color:var(--ink)}.fac{color:var(--ink-mid)}
.ftl{font-family:'Bricolage Grotesque',sans-serif;color:var(--accent);cursor:pointer;border:none;background:none;font-size:.84rem;padding:0;font-weight:500;letter-spacing:-.02em;transition:color .14s;text-decoration:none}
.ftl:hover{color:#1d4ed8}
.ftime{font-size:.64rem;color:var(--ink-dim);font-family:'JetBrains Mono',monospace;white-space:nowrap}

/* ═══ TEAM ═══ */
.team-page{flex:1;overflow-y:auto;padding:26px}
.team-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px;margin-top:16px}
.mc{background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:18px;display:flex;align-items:center;gap:13px;transition:all .2s;box-shadow:none}
.mc:hover{border-color:var(--accent);box-shadow:var(--shadow-md);transform:translateY(-2px)}
.mn{font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:.9rem;display:flex;align-items:center;gap:7px;color:var(--ink);letter-spacing:-.02em}
.me{font-size:.74rem;color:var(--ink-dim);margin-top:2px}
.ms2{font-size:.72rem;color:var(--ink-mid);margin-top:3px;font-weight:500}

/* ═══ REPORT ═══ */
.report-page{flex:1;overflow-y:auto;padding:26px;display:flex;flex-direction:column;gap:16px;height:100%}
.report-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
.report-summary{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.rs-card{background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:18px;text-align:center;box-shadow:none;transition:all .2s}
.rs-card:hover{border-color:var(--accent);box-shadow:var(--shadow-md);transform:translateY(-2px)}
.rs-num{font-family:'Bricolage Grotesque',sans-serif;font-size:2rem;font-weight:700;line-height:1;letter-spacing:-.04em}
.rs-lbl{font-size:.58rem;color:var(--ink-dim);margin-top:5px;text-transform:uppercase;letter-spacing:1px;font-family:'JetBrains Mono',monospace;font-weight:600}
.report-filters{display:flex;gap:9px;flex-wrap:wrap;align-items:flex-end;background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius);padding:14px 16px;box-shadow:var(--shadow-sm)}
.report-table-wrap{flex:1;overflow:auto;border:1.5px solid var(--border);border-radius:var(--radius);background:var(--white);box-shadow:var(--shadow-sm)}
.report-table{width:100%;border-collapse:collapse;font-size:.82rem}
.report-table thead{position:sticky;top:0;z-index:2}
.report-table th{background:var(--bg);color:var(--ink-mid);padding:11px 14px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:.58rem;text-transform:uppercase;letter-spacing:1px;white-space:nowrap;border-bottom:1.5px solid var(--border);font-weight:600}
.report-table td{padding:10px 14px;border-bottom:1px solid var(--border);vertical-align:middle}
.report-table tbody tr:hover{background:var(--bg)}
.report-table tbody tr:last-child td{border-bottom:none}
.rt-sno{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--ink-dim)}
.rt-name{font-family:'Bricolage Grotesque',sans-serif;display:flex;align-items:center;gap:8px;font-weight:700;font-size:.84rem;letter-spacing:-.02em}
.rt-task{font-family:'Bricolage Grotesque',sans-serif;font-weight:500;font-size:.85rem;max-width:200px;letter-spacing:-.02em}
.rt-date{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--ink-mid);white-space:nowrap}
.rt-delay-ok{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--green);font-weight:600}
.rt-delay-warn{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--amber);font-weight:600}
.rt-delay-bad{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--red);font-weight:600}
.rt-delay-na{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--ink-dim)}
/* Charts section in report */
.charts-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.chart-card{background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:20px;box-shadow:none;transition:box-shadow .2s}
.chart-card:hover{box-shadow:var(--shadow-md)}
.chart-title{font-family:'Bricolage Grotesque',sans-serif;font-size:.97rem;font-weight:700;margin-bottom:16px;letter-spacing:-.02em}

/* ═══ TOAST ═══ */
.toast-wrap{position:fixed;bottom:24px;right:24px;z-index:999;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
.toast{background:var(--ink);color:#fff;padding:12px 18px;border-radius:var(--radius);font-size:.83rem;font-weight:500;animation:toastin .3s cubic-bezier(.34,1.56,.64,1);max-width:340px;box-shadow:var(--shadow-xl);display:flex;align-items:center;gap:10px;pointer-events:all;letter-spacing:-.01em}
.toast-undo{background:none;border:1px solid rgba(255,255,255,.3);border-radius:4px;color:#fff;padding:3px 9px;cursor:pointer;font-size:.75rem;font-family:'Figtree',sans-serif;font-weight:600;transition:background .14s}
.toast-undo:hover{background:rgba(255,255,255,.15)}
@keyframes toastin{from{opacity:0;transform:translateY(14px) scale(.95)}to{opacity:1;transform:none}}
.info-box{background:var(--blue-bg);border:1px solid var(--blue-border);border-radius:var(--radius-sm);padding:10px 13px;font-size:.77rem;color:#1e40af;line-height:1.55}
.warn-box{background:var(--amber-bg);border:1px solid var(--amber-border);border-radius:var(--radius-sm);padding:10px 13px;font-size:.77rem;color:#92400e;line-height:1.55}
[data-theme="dark"] .info-box{color:var(--blue-border)}
[data-theme="dark"] .warn-box{color:var(--amber-border)}

/* ═══ COMMAND PALETTE ═══ */
.cmd-overlay{position:fixed;inset:0;background:rgba(15,22,35,.5);backdrop-filter:blur(6px);z-index:500;display:flex;align-items:flex-start;justify-content:center;padding-top:80px}
.cmd-box{background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);width:100%;max-width:580px;overflow:hidden;animation:cmdIn .2s cubic-bezier(.34,1.56,.64,1)}
@keyframes cmdIn{from{opacity:0;transform:scale(.95) translateY(-20px)}to{opacity:1;transform:none}}
.cmd-input-wrap{display:flex;align-items:center;gap:10px;padding:14px 18px;border-bottom:1px solid var(--border)}
.cmd-icon{font-size:1rem;color:var(--ink-dim)}
.cmd-input{flex:1;border:none;background:none;font-family:'Figtree',sans-serif;font-size:1rem;color:var(--ink);outline:none;font-weight:500}
.cmd-input::placeholder{color:var(--ink-dim)}
.cmd-shortcut{font-family:'JetBrains Mono',monospace;font-size:.65rem;background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:2px 7px;color:var(--ink-dim)}
.cmd-results{max-height:400px;overflow-y:auto}
.cmd-group-label{font-family:'JetBrains Mono',monospace;font-size:.58rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink-dim);padding:10px 18px 4px;font-weight:500}
.cmd-item{display:flex;align-items:center;gap:12px;padding:10px 18px;cursor:pointer;transition:background .12s;border:none;background:none;width:100%;text-align:left}
.cmd-item:hover,.cmd-item.focused{background:var(--accent-light)}
.cmd-item-icon{font-size:1rem;width:24px;text-align:center;flex-shrink:0}
.cmd-item-title{font-family:'Bricolage Grotesque',sans-serif;font-size:.88rem;font-weight:500;color:var(--ink);letter-spacing:-.02em}
.cmd-item-sub{font-size:.72rem;color:var(--ink-dim);margin-top:1px}
.cmd-item-kbd{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--ink-dim)}

/* ═══ SHORTCUTS PANEL ═══ */
.shortcuts-table{width:100%;border-collapse:collapse}
.shortcuts-table td{padding:8px 12px;border-bottom:1px solid var(--border);font-size:.83rem}
.shortcuts-table td:first-child{color:var(--ink-mid);width:50%}
.shortcuts-table tr:last-child td{border-bottom:none}
.kbd{display:inline-flex;align-items:center;gap:2px}
.key{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--ink-mid);font-weight:600}

/* ═══ ONBOARDING TOUR ═══ */
.tour-overlay{position:fixed;inset:0;z-index:900;pointer-events:none}
.tour-spotlight{position:absolute;border-radius:var(--radius);box-shadow:0 0 0 9999px rgba(15,22,35,.6);transition:all .4s cubic-bezier(.4,0,.2,1);pointer-events:none}
.tour-tip{position:absolute;background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:20px;box-shadow:var(--shadow-xl);max-width:300px;pointer-events:all;animation:modalIn .3s ease}
.tour-tip-num{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--accent);margin-bottom:8px;font-weight:600}
.tour-tip-title{font-family:'Bricolage Grotesque',sans-serif;font-size:1.05rem;font-weight:700;margin-bottom:6px}
.tour-tip-desc{font-size:.82rem;color:var(--ink-mid);line-height:1.55;margin-bottom:14px}
.tour-dots{display:flex;gap:5px;margin-bottom:12px}
.tour-dot{width:7px;height:7px;border-radius:50%;background:var(--border2);transition:all .2s}
.tour-dot.active{background:var(--accent);width:18px;border-radius:99px}
.tour-btns{display:flex;gap:8px;justify-content:flex-end}

/* ═══ ARCHIVE ═══ */
.archive-badge{font-family:'JetBrains Mono',monospace;font-size:.58rem;padding:2px 8px;border-radius:99px;background:var(--bg2);color:var(--ink-dim);border:1px solid var(--border)}

/* ═══ DARK MODE TOGGLE ═══ */
.theme-toggle{width:36px;height:20px;border-radius:99px;border:none;cursor:pointer;position:relative;transition:background .25s;background:var(--border2);padding:0}
.theme-toggle::after{content:'';position:absolute;left:2px;top:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:transform .25s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
[data-theme="dark"] .theme-toggle{background:var(--accent)}
[data-theme="dark"] .theme-toggle::after{transform:translateX(16px)}

/* ═══ MOBILE ═══ */
@media(max-width:768px){
  :root{--sidebar-w:0px}
  .sidebar{position:fixed;left:0;top:var(--header-h);bottom:0;z-index:90;box-shadow:var(--shadow-lg);width:0}
  .sidebar.mobile-open{width:220px;padding:14px 10px}
  .sidebar-toggle{display:none}
  .global-search-wrap{max-width:150px}
  .detail-panel{width:100%;position:fixed;inset:var(--header-h) 0 0;z-index:80}
  .kanban-col{width:260px}
  .nav-tabs .tab:nth-child(n+4){display:none}
  .view-toggle .view-btn span{display:none}
}
/* Swipe support hint */
.swipe-hint{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);color:#fff;padding:8px 16px;border-radius:99px;font-size:.75rem;white-space:nowrap;opacity:0;transition:opacity .3s;pointer-events:none}
</style>
</head>
<body>

<!-- ═══ AUTH ═══ -->
<style>
.portal-toggle{display:flex;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:3px;gap:2px;margin-bottom:20px}
.portal-btn{flex:1;padding:8px 10px;border:none;border-radius:5px;cursor:pointer;font-family:'Figtree',sans-serif;font-size:.82rem;font-weight:600;color:var(--ink-mid);background:none;transition:all .18s;display:flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap}
.portal-btn.active-admin{background:var(--white);color:var(--accent);box-shadow:var(--shadow-sm)}
.portal-btn.active-member{background:var(--white);color:var(--green);box-shadow:var(--shadow-sm)}
</style>
<div id="authScreen">
  <!-- Single unified login screen -->
  <div id="portalSelector" style="display:none"></div><!-- kept for JS compat -->
  <div id="portalLoginScreen" style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px;width:100%">
    <div class="auth-wrapper" style="max-width:420px;width:100%">
      <div class="auth-box">
        <div class="auth-logo">
          <div class="auth-logo-mark">GF</div>
          <span class="auth-logo-text">Ginesysone <span>Finance</span></span>
        </div>
        <div class="auth-title" id="authTitle">Welcome back</div>
        <div class="auth-sub" id="authSub">Sign in to your workspace</div>

        <!-- Role toggle — inline, right here -->
        <div class="portal-toggle">
          <button class="portal-btn active-admin" id="portalBtnAdmin" onclick="selectPortal('admin')">🏆 Admin</button>
          <button class="portal-btn" id="portalBtnMember" onclick="selectPortal('member')">👤 Team Member</button>
        </div>

        <!-- Sign In / Create Account tabs -->
        <div class="auth-tabs">
          <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
          <button class="auth-tab" id="registerTabBtn" onclick="switchAuthTab('register')" style="display:none">Create Account</button>
        </div>

        <div id="authErr" class="auth-err"></div>
        <div id="loginForm">
          <div class="fg"><label>Email</label><input class="input" id="loginEmail" type="email" placeholder="you@company.com" autocomplete="email"></div>
          <div class="fg"><label>Password</label><input class="input" id="loginPassword" type="password" placeholder="Your password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"></div>
          <button class="btn btn-primary" id="loginBtn" onclick="doLogin()" style="margin-top:8px">Sign In →</button>
        </div>
        <div id="registerForm" style="display:none">
          <div class="fg"><label>Full Name</label><input class="input" id="regName" placeholder="Jane Smith"></div>
          <div class="fg"><label>Work Email</label><input class="input" id="regEmail" type="email" placeholder="you@company.com"></div>
          <div class="fg"><label>Password</label><input class="input" id="regPassword" type="password" placeholder="Min 6 characters"></div>
          <input type="hidden" id="regRole" value="member">
          <button class="btn btn-primary" id="registerBtn" onclick="doRegister()" style="margin-top:8px">Create Account →</button>
        </div>
        <div class="auth-info" id="authPortalInfo">🔐 Secured by Firebase Authentication</div>
      </div>
    </div>
  </div>
</div>

<!-- ═══ FIRST-TIME WELCOME MODAL ═══ -->
<div id="welcomeModal" style="display:none;position:fixed;inset:0;z-index:2000;background:rgba(10,15,30,.55);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px">
  <div style="background:var(--white);border-radius:var(--radius-xl);box-shadow:var(--shadow-xl);max-width:520px;width:100%;overflow:hidden;animation:modalIn .35s ease">
    <!-- Top gradient banner -->
    <div style="background:var(--grad-accent);padding:32px 36px 28px;position:relative;overflow:hidden">
      <div style="position:absolute;top:-40px;right:-40px;width:180px;height:180px;background:rgba(255,255,255,.08);border-radius:50%"></div>
      <div style="position:absolute;bottom:-60px;left:-30px;width:140px;height:140px;background:rgba(255,255,255,.05);border-radius:50%"></div>
      <div style="position:relative;z-index:1">
        <div style="font-size:2.2rem;margin-bottom:10px" id="welcomeEmoji">🎉</div>
        <div style="font-family:'Bricolage Grotesque',sans-serif;font-size:1.6rem;font-weight:800;color:#fff;letter-spacing:-.03em;margin-bottom:6px">Welcome to Ginesysone Finance!</div>
        <div style="font-size:.88rem;color:rgba(255,255,255,.8);line-height:1.5" id="welcomeSubtitle">Your account is ready. Let's get you set up.</div>
      </div>
    </div>
    <!-- Body -->
    <div style="padding:28px 36px">
      <!-- User greeting -->
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px;padding:14px 16px;background:var(--accent-light);border:1.5px solid var(--accent-mid);border-radius:var(--radius)">
        <div id="welcomeAvatar" style="width:44px;height:44px;border-radius:50%;background:var(--grad-accent);display:flex;align-items:center;justify-content:center;font-family:'Bricolage Grotesque',sans-serif;font-weight:800;font-size:1rem;color:#fff;flex-shrink:0"></div>
        <div>
          <div style="font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:.95rem;color:var(--ink)" id="welcomeName">Hey there!</div>
          <div style="font-size:.78rem;color:var(--ink-mid);margin-top:2px" id="welcomeRoleDesc">You're all set up and ready to go.</div>
        </div>
        <span class="role-badge" id="welcomeRoleBadge" style="margin-left:auto"></span>
      </div>

      <!-- Quick start steps -->
      <div style="margin-bottom:24px">
        <div style="font-family:'JetBrains Mono',monospace;font-size:.6rem;text-transform:uppercase;letter-spacing:2px;color:var(--ink-dim);font-weight:600;margin-bottom:12px">Quick Start</div>
        <div id="welcomeSteps" style="display:flex;flex-direction:column;gap:8px"></div>
      </div>

      <!-- CTA buttons -->
      <div style="display:flex;gap:10px">
        <button id="welcomePrimaryBtn" onclick="closeWelcome(true)" class="btn btn-primary" style="flex:1;font-size:.9rem;padding:12px">🚀 Go to My Dashboard</button>
        <button onclick="closeWelcome(false)" class="btn btn-ghost" style="width:auto;padding:12px 18px;font-size:.85rem">Skip →</button>
      </div>
      <div style="text-align:center;margin-top:12px;font-size:.72rem;color:var(--ink-dim)">You can always find help in the <strong>Tour</strong> guide from the sidebar</div>
    </div>
  </div>
</div>


<div id="app">
  <header class="header">
    <div style="display:flex;align-items:center;gap:8px">
      <button class="btn-icon" onclick="toggleSidebar()" title="Toggle sidebar (B)">☰</button>
      <div class="logo"><div class="logo-mark">GF</div><span class="logo-text">Ginesysone <span>Finance</span></span></div>
    </div>
    <div class="global-search-wrap">
      <span class="global-search-icon">🔍</span>
      <input class="global-search-input" id="globalSearch" placeholder="Search… (⌘K)" oninput="globalSearchInput(this.value)" onblur="setTimeout(()=>hideGlobalResults(),200)" onkeydown="globalSearchKey(event)">
      <div class="global-search-results" id="globalResults"></div>
    </div>
    <div class="header-right">
      <nav class="nav-tabs">
        <button class="tab active" onclick="switchView('tasks')" title="T">Tasks</button>
        <button class="tab" onclick="switchView('activity')" title="A">Activity</button>
        <button class="tab" id="teamTab" onclick="switchView('team')">Team</button>
        <button class="tab" id="goalsTab" onclick="switchView('goals')">Goals</button>
        <button class="tab" id="reportTab" onclick="switchView('report')">Report</button>
        <button class="tab" id="complianceTab" onclick="switchView('compliance')" style="color:var(--amber)">🛡 Compliance</button>
      </nav>
      <div class="h-divider"></div>
      <div style="position:relative">
        <button class="btn-icon" id="notifBell" onclick="toggleNotifPanel()" title="Notifications" style="position:relative">🔔<span id="notifBadge" style="display:none;position:absolute;top:-3px;right:-3px;width:16px;height:16px;background:var(--red);border-radius:50%;font-size:.55rem;font-family:'JetBrains Mono',monospace;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;line-height:1" id="notifBadgeInner">0</span></button>
        <div id="notifPanel" style="display:none;position:absolute;top:calc(100% + 8px);right:0;width:340px;background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-xl);z-index:999;max-height:420px;overflow:hidden;display:none;flex-direction:column">
          <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)">
            <div style="font-weight:700;font-size:.88rem">Notifications</div>
            <button class="btn-xs btn-ghost" onclick="clearAllNotifs()" style="font-size:.7rem">Clear all</button>
          </div>
          <div id="notifList" style="overflow-y:auto;max-height:340px;"></div>
        </div>
      </div>
      <button class="btn-icon" onclick="openCmdPalette()" title="⌘K">⌘</button>
      <button class="btn-icon" onclick="showShortcuts()" title="?">?</button>
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode" id="themeToggle"></button>
      <div class="h-divider"></div>
      <div class="user-chip" id="userChip">
        <div id="userAvatar"></div>
        <span id="userName"></span>
        <span class="role-badge" id="userRoleBadge"></span>
      </div>
      <div class="sync-label"><span class="sync-dot"></span> Live</div>
      <div class="h-divider"></div>
      <button class="btn btn-ghost btn-sm" onclick="doLogout()">Sign Out</button>
    </div>
  </header>

  <!-- Bulk action toolbar -->
  <div class="bulk-toolbar" id="bulkToolbar">
    <span class="bulk-count" id="bulkCount">0 selected</span>
    <button class="btn btn-ghost btn-sm" onclick="bulkComplete()">✓ Complete</button>
    <button class="btn btn-ghost btn-sm" onclick="bulkReopen()">↩ Reopen</button>
    <button class="btn btn-ghost btn-sm" id="bulkAssignBtn" onclick="showBulkAssign()">👤 Assign</button>
    <button class="btn btn-ghost btn-sm" onclick="bulkArchive()">📦 Archive</button>
    <button class="btn btn-danger btn-sm" onclick="bulkDelete()">🗑 Delete</button>
    <button class="btn-icon" onclick="clearSelection()" style="margin-left:auto">✕</button>
  </div>

  <div class="app-body">
    <aside class="sidebar" id="mainSidebar">
      <div class="sidebar-toggle" onclick="toggleSidebar()">‹</div>
      <div class="sidebar-section">
        <div class="sidebar-label">Overview</div>
        <div class="stat-grid" id="statsGrid"></div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label" id="breakdownLabel">Priority</div>
        <div class="stat-grid" id="priorityGrid"></div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">Status</div>
        <button class="filter-btn" id="fb_todo" onclick="tf('status','todo')"><span class="fdot" style="background:#94a3b8"></span>To Do<span class="fcount" id="fc_todo">0</span></button>
        <button class="filter-btn" id="fb_ip" onclick="tf('status','in_progress')"><span class="fdot" style="background:#2563eb"></span>In Progress<span class="fcount" id="fc_ip">0</span></button>
        <button class="filter-btn" id="fb_rev" onclick="tf('status','review')"><span class="fdot" style="background:#7c3aed"></span>In Review<span class="fcount" id="fc_rev">0</span></button>
        <button class="filter-btn" id="fb_done" onclick="tf('status','done')"><span class="fdot" style="background:#059669"></span>Done<span class="fcount" id="fc_done">0</span></button>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">Due Date</div>
        <button class="due-filter-btn" id="duf_today" onclick="tfDue('today')">📅 Today</button>
        <button class="due-filter-btn" id="duf_week" onclick="tfDue('week')">📆 This Week</button>
        <button class="due-filter-btn" id="duf_overdue" onclick="tfDue('overdue')">🔴 Overdue</button>
      </div>
      <div class="sidebar-section" id="teamFilterSection">
        <div class="sidebar-label">Team Member</div>
        <div id="teamFilters"></div>
      </div>
      <div class="sidebar-section" id="adminActionsSection" style="display:none">
        <div class="sidebar-label">Actions</div>
        <button class="filter-btn" onclick="openArchiveView()">📦 Archive</button>
        <button class="filter-btn" onclick="openAutomations()">⚡ Automations</button>
        <button class="filter-btn" onclick="startTour()">🎓 Tour</button>
        <button class="filter-btn" onclick="openTempBoard()" id="tempBoardBtn" style="color:var(--amber);font-weight:600">🧲 Temp Board</button>
        <button class="filter-btn" onclick="openGmailPanel()" style="color:#ea4335;font-weight:600">✉️ Gmail Tasks</button>
      </div>
    </aside>

    <main class="main">
      <!-- TASKS VIEW -->
      <div id="tasksView">
        <div class="dash-switcher">
          <button class="dash-tab personal active" id="dashPersonalBtn" onclick="switchDashboard('personal')">
            <span>👤</span> Personal <span class="dash-badge" id="personalCount">0</span>
          </button>
          <button class="dash-tab team" id="dashTeamBtn" onclick="switchDashboard('team')">
            <span>🏢</span> Finance Team <span class="dash-badge" id="teamCount">0</span>
          </button>
          <!-- Notes shortcut button — only shown for members on personal dashboard -->
          <div id="notesShortcutWrap" style="display:none;margin-left:auto">
            <button onclick="openNotesPanel()" id="notesShortcutBtn"
              style="display:flex;align-items:center;gap:8px;padding:7px 18px;border:1.5px solid var(--green-border);background:var(--green-bg);border-radius:99px;cursor:pointer;font-family:'Figtree',sans-serif;font-size:.83rem;font-weight:600;color:var(--green);transition:all .18s;white-space:nowrap;letter-spacing:-.01em"
              onmouseover="this.style.background='var(--green)';this.style.color='#fff';this.style.borderColor='var(--green)'"
              onmouseout="this.style.background='var(--green-bg)';this.style.color='var(--green)';this.style.borderColor='var(--green-border)'">
              <span>📝</span> My Notes
              <span id="notesCount" style="font-family:'JetBrains Mono',monospace;font-size:.65rem;padding:1px 7px;border-radius:99px;font-weight:600;background:rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.08)">0</span>
            </button>
          </div>
        </div>
        <div class="toolbar">
          <div class="view-toggle">
            <button class="view-btn active" id="vb_board" onclick="setViewMode('board')"><span>⊞</span><span>Board</span></button>
            <button class="view-btn" id="vb_list" onclick="setViewMode('list')"><span>☰</span><span>List</span></button>
            <button class="view-btn" id="vb_calendar" onclick="setViewMode('calendar')"><span>📅</span><span>Calendar</span></button>
            <button class="view-btn" id="vb_workload" onclick="setViewMode('workload')"><span>📊</span><span>Workload</span></button>
          </div>
          <div class="h-divider" style="height:16px"></div>
          <div class="search-wrap"><span class="si">🔍</span><input class="search-input" id="searchInput" placeholder="Search tasks…" oninput="renderTasks()"></div>
          <select class="input" id="sortSelect" onchange="renderTasks()" style="width:auto;padding:7px 28px 7px 10px;font-size:.78rem">
            <option value="priority">Sort: Priority</option>
            <option value="due">Sort: Due Date</option>
            <option value="created">Sort: Created</option>
            <option value="title">Sort: Title</option>
            <option value="time">Sort: Time Logged</option>
          </select>
          <button class="btn btn-ghost btn-sm" id="cfBtn" onclick="clearFilters()" style="display:none">✕ Clear</button>
          <span class="tc" id="taskCount"></span>
          <button class="btn-new-task" id="newPersonalTaskBtn" onclick="openTaskModal(null,'personal')" style="margin-left:auto;display:none">＋ Personal Task</button>
          <button class="btn-new-task" id="newTaskBtn" onclick="openTaskModal()" style="display:none">＋ New Task</button>
          <button class="btn btn-ghost btn-sm" id="tplBtn" onclick="openTemplates()" style="display:none" title="Task templates">📋 Template</button>
        </div>

        <div id="tasksGridWrap" class="grid-wrap">
          <div id="tasksGrouped" style="display:flex;gap:14px;align-items:flex-start;min-width:max-content;height:100%"></div>
          <div class="empty" id="emptyState" style="display:none">
            <div class="empty-icon">📋</div>
            <div class="empty-title">No tasks found</div>
            <div class="empty-sub">Adjust your filters or create a new task.</div>
          </div>
        </div>
        <div id="calendarWrap" class="calendar-wrap" style="display:none">
          <div class="cal-header">
            <button class="cal-nav" onclick="calNav(-1)">← Prev</button>
            <div class="cal-month-title" id="calTitle"></div>
            <button class="cal-nav" onclick="calNav(1)">Next →</button>
            <button class="cal-nav" onclick="calGoToday()">Today</button>
          </div>
          <div class="cal-grid" id="calGrid"></div>
        </div>
        <div id="workloadWrap" class="workload-wrap" style="display:none"></div>
        <!-- NOTES WRAP (inside personal dashboard) -->
        <div id="notesWrap" style="display:none;flex:1;overflow:hidden;flex-direction:row;height:100%">
          <!-- Notes Sidebar -->
          <div id="notesSidebar" style="width:260px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--white);overflow:hidden">
            <div style="padding:14px 14px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px">
              <button onclick="switchDashboard('personal')" style="background:none;border:none;cursor:pointer;font-size:.75rem;color:var(--ink-dim);display:flex;align-items:center;gap:4px;padding:4px 6px;border-radius:var(--radius-sm);transition:all .14s;font-family:'Figtree',sans-serif;font-weight:600" onmouseover="this.style.background='var(--bg)';this.style.color='var(--ink)'" onmouseout="this.style.background='none';this.style.color='var(--ink-dim)'">← Tasks</button>
              <div style="width:1px;height:16px;background:var(--border)"></div>
              <div style="position:relative;flex:1">
                <span style="position:absolute;left:9px;top:50%;transform:translateY(-50%);font-size:.75rem;opacity:.4">🔍</span>
                <input id="notesSearch" class="input" placeholder="Search notes…" style="padding-left:28px;font-size:.8rem" oninput="renderNotesList()">
              </div>
              <button class="btn btn-primary btn-sm" onclick="newNote()" title="New Note" style="width:auto;padding:7px 11px;font-size:.8rem">＋</button>
            </div>
            <!-- Notebooks -->
            <div style="padding:10px 14px 6px">
              <div style="font-family:'JetBrains Mono',monospace;font-size:.56rem;color:var(--ink-dim);text-transform:uppercase;letter-spacing:2px;font-weight:500;margin-bottom:7px">Notebooks</div>
              <div id="notebooksList" style="display:flex;flex-direction:column;gap:2px"></div>
              <button onclick="createNotebook()" style="width:100%;margin-top:6px;padding:5px 8px;background:none;border:1px dashed var(--border2);border-radius:var(--radius-sm);cursor:pointer;font-size:.75rem;color:var(--ink-dim);text-align:left;transition:all .14s" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border2)';this.style.color='var(--ink-dim)'">＋ New Notebook</button>
            </div>
            <!-- Tags -->
            <div style="padding:4px 14px 6px">
              <div style="font-family:'JetBrains Mono',monospace;font-size:.56rem;color:var(--ink-dim);text-transform:uppercase;letter-spacing:2px;font-weight:500;margin-bottom:7px">Tags</div>
              <div id="notesTagFilter" style="display:flex;flex-wrap:wrap;gap:4px"></div>
            </div>
            <!-- Notes list -->
            <div id="notesListWrap" style="flex:1;overflow-y:auto;padding:8px 10px;display:flex;flex-direction:column;gap:4px"></div>
          </div>
          <!-- Notes Editor -->
          <div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
            <!-- Empty state -->
            <div id="notesEmptyState" style="flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;color:var(--ink-dim)">
              <div style="font-size:3rem">📝</div>
              <div style="font-family:'Bricolage Grotesque',sans-serif;font-size:1.1rem;font-weight:700;color:var(--ink)">No note selected</div>
              <div style="font-size:.84rem;color:var(--ink-dim)">Select a note to edit, or create a new one</div>
              <button class="btn btn-primary" onclick="newNote()" style="width:auto;margin-top:4px">＋ New Note</button>
            </div>
            <!-- Editor area -->
            <div id="notesEditorArea" style="display:none;flex:1;flex-direction:column;overflow:hidden">
              <!-- Editor Toolbar -->
              <div style="padding:10px 20px;border-bottom:1px solid var(--border);background:var(--white);display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                <div style="display:flex;gap:2px;background:var(--bg2);padding:2px;border-radius:var(--radius-sm);border:1px solid var(--border)">
                  <button class="note-fmt-btn" onclick="noteFmt('bold')" title="Bold"><b>B</b></button>
                  <button class="note-fmt-btn" onclick="noteFmt('italic')" title="Italic"><i>I</i></button>
                  <button class="note-fmt-btn" onclick="noteFmt('underline')" title="Underline"><u>U</u></button>
                  <button class="note-fmt-btn" onclick="noteFmt('strikeThrough')" title="Strikethrough"><s>S</s></button>
                </div>
                <div style="display:flex;gap:2px;background:var(--bg2);padding:2px;border-radius:var(--radius-sm);border:1px solid var(--border)">
                  <button class="note-fmt-btn" onclick="noteFmt('insertUnorderedList')" title="Bullet list">• List</button>
                  <button class="note-fmt-btn" onclick="noteFmt('insertOrderedList')" title="Numbered list">1. List</button>
                </div>
                <div style="display:flex;gap:2px;background:var(--bg2);padding:2px;border-radius:var(--radius-sm);border:1px solid var(--border)">
                  <button class="note-fmt-btn" onclick="noteFmtBlock('H1')" title="Heading 1">H1</button>
                  <button class="note-fmt-btn" onclick="noteFmtBlock('H2')" title="Heading 2">H2</button>
                  <button class="note-fmt-btn" onclick="noteFmtBlock('H3')" title="Heading 3">H3</button>
                  <button class="note-fmt-btn" onclick="noteFmtBlock('P')" title="Paragraph">¶</button>
                </div>
                <div style="display:flex;gap:2px;background:var(--bg2);padding:2px;border-radius:var(--radius-sm);border:1px solid var(--border)">
                  <button class="note-fmt-btn" onclick="insertNoteCheckbox()" title="Checkbox">☑ Check</button>
                  <button class="note-fmt-btn" onclick="insertNoteHr()" title="Divider">— HR</button>
                  <button class="note-fmt-btn" onclick="insertNoteCode()" title="Code">&lt;/&gt;</button>
                </div>
                <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
                  <span id="notesSaveStatus" style="font-size:.72rem;color:var(--ink-dim);font-family:'JetBrains Mono',monospace"></span>
                  <select id="noteNotebook" class="input" style="font-size:.75rem;padding:5px 24px 5px 8px;width:auto" onchange="moveNoteToNotebook()"></select>
                  <button class="btn btn-ghost btn-sm" onclick="pinNote()" id="notePinBtn" title="Pin note" style="width:auto">📌</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteCurrentNote()" title="Delete note" style="width:auto">🗑</button>
                </div>
              </div>
              <!-- Title -->
              <div style="padding:20px 28px 0;background:var(--white)">
                <input id="noteTitleInput" placeholder="Note title…" style="width:100%;border:none;outline:none;font-family:'Bricolage Grotesque',sans-serif;font-size:1.6rem;font-weight:800;color:var(--ink);background:transparent;letter-spacing:-.03em" oninput="onNoteChange()">
                <!-- Tags row -->
                <div style="display:flex;align-items:center;gap:6px;margin-top:8px;flex-wrap:wrap;padding-bottom:12px;border-bottom:1px solid var(--border)">
                  <div id="noteCurTags" style="display:flex;gap:4px;flex-wrap:wrap"></div>
                  <input id="noteTagInput" placeholder="＋ tag" style="border:none;outline:none;background:transparent;font-size:.75rem;color:var(--ink-mid);width:70px;font-family:'Figtree',sans-serif" onkeydown="noteTagKey(event)" title="Press Enter to add tag">
                  <span style="font-size:.7rem;color:var(--ink-dim);font-family:'JetBrains Mono',monospace;margin-left:auto" id="noteMetaInfo"></span>
                </div>
              </div>
              <!-- Body -->
              <div id="noteBody" contenteditable="true" style="flex:1;padding:16px 28px 40px;overflow-y:auto;outline:none;font-size:.93rem;line-height:1.75;color:var(--ink);caret-color:var(--accent);background:var(--white)" oninput="onNoteChange()"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ACTIVITY VIEW -->
      <div id="activityView" style="display:none;flex:1;overflow:hidden">
        <div class="feed-page">
          <div class="pg-title">Activity Feed</div>
          <div class="pg-sub" id="activitySubtitle">Everything happening across all tasks</div>
          <div id="feedList"></div>
        </div>
      </div>

      <!-- TEAM VIEW -->
      <div id="teamView" style="display:none;flex:1;overflow:hidden">
        <div class="team-page">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;flex-wrap:wrap;gap:10px">
            <div><div class="pg-title">Team Members</div><div class="pg-sub">Registered users in your workspace</div></div>
            <button class="btn btn-primary btn-sm" onclick="generateInviteLink()" style="width:auto">🔗 Generate Invite Link</button>
          </div>
          <div id="inviteLinkBox" style="display:none;background:var(--accent-light);border:1.5px solid var(--accent-mid);border-radius:var(--radius);padding:12px 16px;margin-bottom:16px;flex-direction:column;gap:8px">
            <div style="font-size:.78rem;font-weight:600;color:var(--accent)">📨 Share this link with new members to let them register:</div>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="inviteLinkInput" class="input" readonly style="font-size:.8rem;font-family:JetBrains Mono,monospace;background:var(--white);flex:1">
              <button class="btn btn-ghost btn-sm" onclick="copyInviteLink()" style="width:auto;white-space:nowrap">📋 Copy</button>
            </div>
            <div style="font-size:.7rem;color:var(--ink-dim)">⚠️ This link lets anyone with it register as a member. Share carefully.</div>
          </div>
          <div id="teamGrid" class="team-grid"></div>
        </div>
      </div>

      <!-- GOALS VIEW -->
      <div id="goalsView" style="display:none;flex:1;overflow:hidden">
        <div class="team-page">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
            <div><div class="pg-title">Goals & OKRs</div><div class="pg-sub">Track team objectives and key results</div></div>
            <button class="btn btn-primary btn-sm" onclick="openGoalModal()" style="width:auto">＋ New Goal</button>
          </div>
          <div id="goalsGrid"></div>
        </div>
      </div>

      <!-- REPORT VIEW -->
      <div id="reportView" style="display:none;flex:1;overflow:hidden">
        <div class="report-page">
          <div class="report-header">
            <div><div class="pg-title">Analytics & Report</div><div class="pg-sub">Track assignments, progress &amp; team velocity</div></div>
            <div style="display:flex;gap:6px">
              <button class="btn btn-ghost btn-sm" onclick="exportReportPDF()" style="width:auto">📄 PDF</button>
              <button class="btn btn-primary btn-sm" onclick="exportReportCSV()" style="width:auto">↓ CSV</button>
            </div>
          </div>
          <div class="report-filters">
            <div class="fg" style="min-width:150px;margin:0"><label style="font-size:.62rem;font-weight:700;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.8px;font-family:'JetBrains Mono',monospace">Member</label><select class="input" id="reportMemberFilter" onchange="renderReport()" style="margin-top:4px"><option value="">All Members</option></select></div>
            <div class="fg" style="min-width:130px;margin:0"><label style="font-size:.62rem;font-weight:700;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.8px;font-family:'JetBrains Mono',monospace">Status</label><select class="input" id="reportStatusFilter" onchange="renderReport()" style="margin-top:4px"><option value="">All Status</option><option value="todo">To Do</option><option value="in_progress">In Progress</option><option value="review">In Review</option><option value="done">Done</option></select></div>
            <div class="fg" style="min-width:130px;margin:0"><label style="font-size:.62rem;font-weight:700;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.8px;font-family:'JetBrains Mono',monospace">Priority</label><select class="input" id="reportPriorityFilter" onchange="renderReport()" style="margin-top:4px"><option value="">All Priorities</option><option value="critical">🔴 Critical</option><option value="high">🟠 High</option><option value="medium">🟡 Medium</option><option value="low">🟢 Low</option></select></div>
            <div class="fg" style="min-width:130px;margin:0"><label style="font-size:.62rem;font-weight:700;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.8px;font-family:'JetBrains Mono',monospace">From</label><input class="input" type="date" id="reportDateFrom" onchange="renderReport()" style="margin-top:4px"></div>
            <div class="fg" style="min-width:130px;margin:0"><label style="font-size:.62rem;font-weight:700;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.8px;font-family:'JetBrains Mono',monospace">To</label><input class="input" type="date" id="reportDateTo" onchange="renderReport()" style="margin-top:4px"></div>
            <button class="btn btn-ghost btn-sm" onclick="clearReportFilters()" style="margin-top:20px">✕</button>
          </div>
          <div class="report-summary" id="reportSummary"></div>
          <div class="charts-row" id="chartsRow"></div>
          <div class="charts-row" id="burndownRow" style="margin-top:0"></div>
          <div id="timeReportSection" style="margin-bottom:18px"></div>
          <div class="report-table-wrap">
            <table class="report-table" id="reportTable" style="display:none">
              <thead><tr><th>#</th><th>Member</th><th>Task</th><th>Priority</th><th>Assigned</th><th>Finished</th><th>Time</th><th>Delay</th></tr></thead>
              <tbody id="reportBody"></tbody>
            </table>
            <div class="empty" id="reportEmpty" style="display:none"><div class="ei">📊</div><div class="empty-title">No tasks match filters</div></div>
          </div>
        </div>
      </div>

      <!-- COMPLIANCE VIEW -->
      <div id="complianceView" style="display:none;flex:1;overflow:hidden">
        <div class="compliance-page">
          <!-- STICKY HEADER: filters row + title/actions row side by side -->
          <div class="c-sticky-header">
            <!-- Row 1: Title + filters + actions all on one line -->
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
              <!-- Title -->
              <div style="flex-shrink:0">
                <div style="font-family:'Bricolage Grotesque',sans-serif;font-size:1.1rem;font-weight:800;letter-spacing:-.03em;color:var(--ink)">🛡 Compliance Tracker</div>
              </div>
              <div style="width:1px;height:28px;background:var(--border);flex-shrink:0"></div>
              <!-- Filters inline -->
              <div class="compliance-filters" style="flex:1">
                <div class="fg" style="margin:0;min-width:120px">
                  <label style="font-size:.58rem;text-transform:uppercase;letter-spacing:1px;color:var(--ink-dim);font-family:'JetBrains Mono',monospace;font-weight:600">Month</label>
                  <input class="input" type="month" id="cfMonth" onchange="renderCompliance()" style="margin-top:4px;padding:6px 10px;font-size:.8rem">
                </div>
                <div class="fg" style="margin:0;min-width:120px">
                  <label style="font-size:.58rem;text-transform:uppercase;letter-spacing:1px;color:var(--ink-dim);font-family:'JetBrains Mono',monospace;font-weight:600">Type</label>
                  <select class="input" id="cfType" onchange="renderCompliance()" style="margin-top:4px;padding:6px 10px;font-size:.8rem">
                    <option value="">All Types</option>
                    <option value="Tax">Tax</option>
                    <option value="Audit">Audit</option>
                    <option value="Legal">Legal</option>
                    <option value="HR">HR</option>
                    <option value="Finance">Finance</option>
                    <option value="Regulatory">Regulatory</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="fg" style="margin:0;min-width:120px">
                  <label style="font-size:.58rem;text-transform:uppercase;letter-spacing:1px;color:var(--ink-dim);font-family:'JetBrains Mono',monospace;font-weight:600">Status</label>
                  <select class="input" id="cfStatus" onchange="renderCompliance()" style="margin-top:4px;padding:6px 10px;font-size:.8rem">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="overdue">Overdue</option>
                  </select>
                </div>
                <div class="fg" style="margin:0;width:180px;flex-shrink:0">
                  <label style="font-size:.58rem;text-transform:uppercase;letter-spacing:1px;color:var(--ink-dim);font-family:'JetBrains Mono',monospace;font-weight:600">Search</label>
                  <div style="position:relative;margin-top:4px"><span class="si" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:.72rem;opacity:.4;z-index:1">🔍</span><input class="search-input" id="cfSearch" placeholder="Search…" oninput="renderCompliance()" style="width:100%;padding:6px 26px 6px 28px;font-size:.8rem"><button onclick="clearComplianceFilters()" title="Clear filters" style="position:absolute;right:7px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:.75rem;color:var(--ink-dim);padding:2px;transition:color .14s;line-height:1" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--ink-dim)'">✕</button></div>
                </div>
              </div>
              <!-- Actions -->
              <div style="display:flex;gap:6px;align-items:center;flex-shrink:0">
                <div class="c-view-toggle">
                  <button class="c-view-btn active" id="cvBtn-table" onclick="setCView('table')">☰ Table</button>
                  <button class="c-view-btn" id="cvBtn-list" onclick="setCView('list')">≡ List</button>
                  <button class="c-view-btn" id="cvBtn-board" onclick="setCView('board')">⊞ Board</button>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="exportComplianceCSV()" style="width:auto">↓ CSV</button>
                <button class="btn btn-primary btn-sm" id="cAddBtn" onclick="openComplianceModal()" style="width:auto">＋ Add</button>
              </div>
            </div>
          </div>
          <!-- SCROLLABLE CONTENT -->
          <div class="c-content-scroll">
          <!-- Views wrapper -->
          <div class="c-view-wrap">
            <!-- TABLE VIEW -->
            <div id="cViewTable" class="compliance-table-wrap">
              <table class="compliance-table">
                <thead>
                  <tr>
                    <th style="width:30px">#</th>
                    <th>Compliance Name</th>
                    <th>Month</th>
                    <th>Type</th>
                    <th>Assigned To</th>
                    <th>Due Date</th>
                    <th>Submit Date</th>
                    <th>Filing Date</th>
                    <th>Status</th>
                    <th>Remarks</th>
                    <th style="width:90px"></th>
                  </tr>
                </thead>
                <tbody id="complianceTableBody">
                  <tr><td colspan="10"><div class="compliance-empty"><div class="compliance-empty-icon">🛡</div><div class="compliance-empty-title">No compliance records</div><div class="compliance-empty-sub">Click "+ Add Compliance" to add your first record.</div></div></td></tr>
                </tbody>
              </table>
            </div>
            <!-- LIST VIEW -->
            <div id="cViewList" class="c-list" style="display:none" id="complianceListBody"></div>
            <!-- BOARD VIEW -->
            <div id="cViewBoard" class="c-board" style="display:none"></div>
          </div>
          </div><!-- end c-content-scroll -->
        </div>
      </div>

      </div>


    </main>

    <div class="detail-panel" id="detailPanel" style="display:none"></div>
  </div>
</div>

<!-- Toast container -->

<!-- TEMP BOARD PANEL -->
<div id="tempBoardOverlay" style="display:none;position:fixed;inset:0;z-index:800;background:rgba(10,15,30,.35);backdrop-filter:blur(2px)" onclick="if(event.target===this)closeTempBoard()"></div>
<div id="tempBoardPanel" style="display:none;position:fixed;top:0;right:0;width:480px;max-width:100vw;height:100vh;background:var(--white);border-left:1.5px solid var(--border);box-shadow:var(--shadow-xl);z-index:801;flex-direction:column;overflow:hidden">
  <!-- Header -->
  <div style="padding:18px 20px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,#fff8e6,#fffaf0)">
    <div style="width:36px;height:36px;background:var(--amber-bg);border:1.5px solid var(--amber-border);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem">🧲</div>
    <div style="flex:1">
      <div style="font-family:'Bricolage Grotesque',sans-serif;font-weight:800;font-size:1rem;letter-spacing:-.02em;color:var(--ink)">Temporary Board</div>
      <div style="font-size:.72rem;color:var(--ink-dim);margin-top:1px">Park tasks temporarily — clear when done</div>
    </div>
    <button onclick="closeTempBoard()" style="background:none;border:none;cursor:pointer;font-size:1rem;color:var(--ink-dim);padding:4px;border-radius:6px;transition:all .14s" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='none'">✕</button>
  </div>
  <!-- Purpose label -->
  <div style="padding:12px 20px;border-bottom:1px solid var(--border);background:var(--surface2);display:flex;align-items:center;gap:8px">
    <span style="font-size:.75rem;font-weight:700;color:var(--ink-mid);white-space:nowrap">📌 Purpose:</span>
    <input id="tempBoardPurpose" class="input" placeholder="e.g. Meeting prep, EOD review, Sprint…" style="font-size:.8rem;padding:6px 10px;flex:1;background:var(--white)">
    <button onclick="clearTempBoard()" class="btn btn-danger btn-sm" style="white-space:nowrap" title="Clear all tasks from temp board">🗑 Clear All</button>
  </div>
  <!-- Add task row -->
  <div style="padding:12px 20px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">
    <input id="tempTaskInput" class="input" placeholder="Add a task… (Enter to add)" style="flex:1;font-size:.85rem" onkeydown="if(event.key==='Enter')addTempTask()">
    <select id="tempTaskPriority" class="input" style="width:auto;padding:8px 28px 8px 10px;font-size:.8rem">
      <option value="medium">🟡 Medium</option>
      <option value="critical">🔴 Critical</option>
      <option value="high">🟠 High</option>
      <option value="low">🟢 Low</option>
    </select>
    <button class="btn btn-primary btn-sm" onclick="addTempTask()" style="width:auto;white-space:nowrap">＋ Add</button>
  </div>
  <!-- Columns -->
  <div style="flex:1;overflow-y:auto;padding:16px 20px;display:flex;gap:12px;align-items:flex-start">
    <!-- Todo column -->
    <div style="flex:1;min-width:0">
      <div style="font-family:'JetBrains Mono',monospace;font-size:.6rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink-dim);font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:6px">
        <span style="width:8px;height:8px;border-radius:50%;background:#94a3b8;display:inline-block"></span> To Do
        <span id="tempTodoCount" style="margin-left:auto;background:var(--bg2);padding:1px 6px;border-radius:99px;font-size:.6rem">0</span>
      </div>
      <div id="tempTodoList" style="display:flex;flex-direction:column;gap:6px;min-height:60px"></div>
    </div>
    <!-- Done column -->
    <div style="flex:1;min-width:0">
      <div style="font-family:'JetBrains Mono',monospace;font-size:.6rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--green);font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:6px">
        <span style="width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block"></span> Done
        <span id="tempDoneCount" style="margin-left:auto;background:var(--green-bg);color:var(--green);padding:1px 6px;border-radius:99px;font-size:.6rem">0</span>
      </div>
      <div id="tempDoneList" style="display:flex;flex-direction:column;gap:6px;min-height:60px"></div>
    </div>
  </div>
  <!-- Footer -->
  <div style="padding:10px 20px;border-top:1px solid var(--border);background:var(--surface2);display:flex;align-items:center;justify-content:space-between">
    <span id="tempBoardStats" style="font-size:.75rem;color:var(--ink-dim);font-family:'JetBrains Mono',monospace"></span>
    <button onclick="clearDoneTempTasks()" class="btn btn-ghost btn-sm" style="font-size:.75rem">✓ Clear Done</button>
  </div>
</div>
<div class="toast-wrap" id="toastWrap"></div>

<!-- AUTOMATIONS MODAL -->
<div class="overlay" id="automationModal" style="display:none" onclick="if(event.target===this)closeAutomations()">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title">⚡ Automations</div>
      <button class="icon-btn" onclick="closeAutomations()">✕</button>
    </div>
    <div class="form-body">
      <p style="font-size:.83rem;color:var(--ink-mid);margin-bottom:16px">Set up rules that run automatically when conditions are met.</p>
      <div id="automationsList" style="margin-bottom:16px"></div>
      <div style="background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius);padding:16px">
        <div style="font-weight:700;font-size:.85rem;margin-bottom:12px">＋ Create New Rule</div>
        <div class="form-row" style="margin-bottom:10px">
          <div class="fg" style="margin:0"><label>When</label>
            <select class="input" id="autoTrigger">
              <option value="status_done">Task status → Done</option>
              <option value="status_review">Task status → In Review</option>
              <option value="status_in_progress">Task status → In Progress</option>
              <option value="task_assigned">Task assigned</option>
              <option value="due_today">Task due today</option>
              <option value="task_overdue">Task becomes overdue</option>
              <option value="comment_added">Comment added</option>
            </select>
          </div>
          <div class="fg" style="margin:0"><label>Then</label>
            <select class="input" id="autoAction">
              <option value="notify_assignee">Notify assignee</option>
              <option value="notify_watchers">Notify all watchers</option>
              <option value="notify_admin">Notify admin</option>
              <option value="send_email">Send email notification</option>
              <option value="log_activity">Log to activity feed</option>
            </select>
          </div>
        </div>
        <div class="fg" style="margin-bottom:10px"><label>Rule Name (optional)</label><input class="input" id="autoName" placeholder="e.g. Notify team when task done"></div>
        <button class="btn btn-primary btn-sm" onclick="saveAutomation()" style="width:auto">Save Rule</button>
      </div>
    </div>
  </div>
</div>

<!-- GOAL MODAL -->
<div class="overlay" id="goalModal" style="display:none" onclick="if(event.target===this)closeGoalModal()">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="goalModalTitle">New Goal</div>
      <button class="icon-btn" onclick="closeGoalModal()">✕</button>
    </div>
    <div class="form-body">
      <input type="hidden" id="editGoalId">
      <div class="fg"><label>Goal Title *</label><input class="input" id="gTitle" placeholder="e.g. Q1 Revenue Target"></div>
      <div class="fg"><label>Description</label><textarea class="input" id="gDesc" rows="2" placeholder="What does success look like?"></textarea></div>
      <div class="form-row">
        <div class="fg"><label>Target Value</label><input class="input" type="number" id="gTarget" placeholder="100" min="0"></div>
        <div class="fg"><label>Current Value</label><input class="input" type="number" id="gCurrent" placeholder="0" min="0"></div>
        <div class="fg"><label>Unit</label><input class="input" id="gUnit" placeholder="%, tasks, $…"></div>
      </div>
      <div class="form-row">
        <div class="fg"><label>Deadline</label><input class="input" type="date" id="gDeadline"></div>
        <div class="fg"><label>Owner</label><select class="input" id="gOwner"><option value="">— Any —</option></select></div>
      </div>
      <div class="fg"><label>Status</label>
        <select class="input" id="gStatus">
          <option value="on_track">🟢 On Track</option>
          <option value="at_risk">🟡 At Risk</option>
          <option value="off_track">🔴 Off Track</option>
          <option value="achieved">✅ Achieved</option>
        </select>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeGoalModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveGoal()" style="width:auto">Save Goal →</button>
      </div>
    </div>
  </div>
</div>

<!-- TASK MODAL -->
<div class="overlay" id="taskModal" style="display:none" onclick="if(event.target===this)closeTaskModal()">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="tmTitle">New Task</div>
      <button class="icon-btn" onclick="closeTaskModal()">✕</button>
    </div>
    <div class="form-body">
      <input type="hidden" id="editId"><input type="hidden" id="taskSource" value="team">
      <div class="fg"><label>Title *</label><input class="input" id="tTitle" placeholder="What needs to be done?"></div>
      <div class="fg"><label>Description</label>
        <div style="position:relative">
          <div class="richtext-area" id="tDesc" contenteditable="true" data-placeholder="Add context, links, or notes…"></div>
          <div class="richtext-toolbar">
            <button class="rt-btn" onclick="execFmt('bold')" title="Bold"><b>B</b></button>
            <button class="rt-btn" onclick="execFmt('italic')" title="Italic"><i>I</i></button>
            <button class="rt-btn" onclick="execFmt('underline')" title="Underline"><u>U</u></button>
            <button class="rt-btn" onclick="execFmt('insertUnorderedList')" title="List">• List</button>
            <button class="rt-btn" onclick="execFmt('insertOrderedList')" title="Numbered">1. List</button>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="fg"><label>Status</label><select class="input" id="tStatus"><option value="todo">To Do</option><option value="in_progress">In Progress</option><option value="review">In Review</option><option value="done">Done</option></select></div>
        <div class="fg"><label>Priority</label><select class="input" id="tPriority"><option value="critical">🔴 Critical</option><option value="high">🟠 High</option><option value="medium" selected>🟡 Medium</option><option value="low">🟢 Low</option></select></div>
      </div>
      <div class="form-row" id="assigneeRow">
        <div class="fg"><label>Assign To</label><select class="input" id="tAssignee"><option value="">— Unassigned —</option></select></div>
        <div class="fg"><label>Due Date</label><input class="input" type="date" id="tDue"></div>
      </div>
      <div class="form-row">
        <div class="fg"><label>⏱ Estimated Time (hours)</label><input class="input" type="number" id="tEstimate" placeholder="e.g. 4" min="0" step="0.5"></div>
        <div class="fg" style="display:flex;flex-direction:column;justify-content:flex-end"><div style="font-size:.72rem;color:var(--ink-dim);padding:4px 0">Used to track estimate vs. actual in reports</div></div>
      </div>
      <div class="fg"><label>Card Color</label>
        <div id="colorPicker" style="display:flex;gap:7px;flex-wrap:wrap;padding:6px 0">
          <button class="color-swatch" style="--c:transparent" onclick="selectColor('')" title="None">✕</button>
        </div>
      </div>
      <div class="fg"><label>Tags</label>
        <div class="tag-editor" id="tagEditor" onclick="document.getElementById('tagInput').focus()">
          <div id="tagBadges" style="display:contents"></div>
          <input class="tag-editor-input" id="tagInput" placeholder="Add tag, press Enter…" onkeydown="handleTagKey(event)">
        </div>
      </div>
      <div class="fg"><label>Subtasks</label>
        <div class="subtask-list" id="subtaskList"></div>
        <div class="subtask-add">
          <input class="subtask-input" id="subtaskInput" placeholder="Add a subtask…" onkeydown="if(event.key==='Enter'){event.preventDefault();addSubtask();}">
          <button class="btn btn-ghost btn-sm" onclick="addSubtask()" type="button">+ Add</button>
        </div>
      </div>
      <div class="fg"><label>🔗 Attachment / Ticket URL</label><input class="input" type="url" id="tLink" placeholder="https://… (airline ticket, file, doc link)"></div>
      <div class="fg"><label>Recurring</label>
        <div class="recur-opts" id="recurOpts">
          <button class="recur-btn active" data-v="" onclick="selectRecur(this,'')">None</button>
          <button class="recur-btn" data-v="daily" onclick="selectRecur(this,'daily')">Daily</button>
          <button class="recur-btn" data-v="weekly" onclick="selectRecur(this,'weekly')">Weekly</button>
          <button class="recur-btn" data-v="monthly" onclick="selectRecur(this,'monthly')">Monthly</button>
        </div>
      </div>
      <div id="personalAssigneeNote" style="display:none" class="info-box">👤 This task will be assigned to <strong>you</strong> and only visible to you.</div>
      <div class="fg"><label>📧 Email notification</label><div class="warn-box" id="emailNote">Configure EmailJS to enable email notifications.</div></div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeTaskModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveTask()" style="width:auto">Save Task →</button>
      </div>
    </div>
  </div>
</div>


      <!-- COMPLIANCE MODAL -->
      <div class="overlay" id="complianceModal" style="display:none" onclick="if(event.target===this)closeComplianceModal()">
        <div class="modal" style="max-width:580px;max-height:90vh;overflow-y:auto">
          <div class="modal-header" style="position:sticky;top:0;background:var(--white);z-index:2">
            <div class="modal-title" id="complianceModalTitle">Add Compliance</div>
            <button class="icon-btn" onclick="closeComplianceModal()">✕</button>
          </div>
          <div class="form-body">
            <input type="hidden" id="editComplianceId">
            <!-- Member-only info banner (shown when non-admin opens a record) -->
            <div id="cMemberBanner" style="display:none;background:var(--accent-light);border:1.5px solid var(--accent-mid);border-radius:var(--radius);padding:12px 14px;margin-bottom:14px">
              <div style="font-size:.72rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px">📋 Compliance Record</div>
              <div id="cMemberName" style="font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:.95rem;color:var(--ink);margin-bottom:2px;letter-spacing:-.02em"></div>
              <div id="cMemberMeta" style="font-size:.75rem;color:var(--ink-mid)"></div>
              <div style="font-size:.74rem;color:var(--ink-mid);margin-top:8px;padding-top:8px;border-top:1px solid var(--accent-mid)">
                Please fill in the <strong>Submit Date</strong> and <strong>Filing Date</strong> below.
              </div>
            </div>
            <div class="form-row" id="cAdminRow1">
              <div class="fg" style="flex:2">
                <label>Compliance Name *</label>
                <input class="input" id="cName" placeholder="e.g. GST Monthly Filing, TDS Return…">
              </div>
              <div class="fg">
                <label>Month *</label>
                <input class="input" type="month" id="cMonth">
              </div>
            </div>
            <div class="form-row" id="cAdminRow2">
              <div class="fg">
                <label>Type of Compliance *</label>
                <select class="input" id="cType">
                  <option value="">— Select Type —</option>
                  <option value="Tax">Tax</option>
                  <option value="Audit">Audit</option>
                  <option value="Legal">Legal</option>
                  <option value="HR">HR</option>
                  <option value="Finance">Finance</option>
                  <option value="Regulatory">Regulatory</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="fg">
                <label>Due Date</label>
                <input class="input" type="date" id="cDue">
              </div>
            </div>
            <div class="form-row">
              <div class="fg">
                <label>📤 Submit Date</label>
                <input class="input" type="date" id="cSubmitDate" placeholder="Actual submission date">
              </div>
              <div class="fg">
                <label>🗂 Filing Date</label>
                <input class="input" type="date" id="cFilingDate" placeholder="Date filed with authority">
              </div>
            </div>

            <!-- RECURRING SECTION -->
            <div class="fg" id="cAdminRecur">
              <label>🔄 Recurring Schedule</label>
              <div class="c-recur-opts" id="cRecurOpts">
                <button class="c-recur-btn active" data-v="" onclick="selectCRecur(this,'')">None</button>
                <button class="c-recur-btn" data-v="monthly" onclick="selectCRecur(this,'monthly')">Monthly</button>
                <button class="c-recur-btn" data-v="quarterly" onclick="selectCRecur(this,'quarterly')">Quarterly</button>
                <button class="c-recur-btn" data-v="half-yearly" onclick="selectCRecur(this,'half-yearly')">Half-Yearly</button>
                <button class="c-recur-btn" data-v="yearly" onclick="selectCRecur(this,'yearly')">Yearly</button>
              </div>
              <div id="cRecurNote" style="display:none;font-size:.74rem;color:var(--accent);background:var(--accent-light);border:1px solid var(--accent-mid);border-radius:var(--radius-sm);padding:7px 10px;margin-top:6px">
                🔁 When this compliance is marked <strong>Completed</strong>, the next cycle will be automatically created.
              </div>
            </div>

            <!-- ASSIGN TO SECTION -->
            <div class="fg" id="cAdminAssignee">
              <label>Assign To</label>
              <select class="input" id="cAssignee">
                <option value="">— Unassigned —</option>
              </select>
            </div>

            <div class="fg" id="cAdminStatus">
              <label>Status</label>
              <select class="input" id="cStatus">
                <option value="pending">⏳ Pending</option>
                <option value="in_progress">🔵 In Progress</option>
                <option value="completed">✅ Completed</option>
                <option value="overdue">🔴 Overdue</option>
              </select>
            </div>
            <div class="fg" id="cAdminRemarks">
              <label>Remarks</label>
              <textarea class="input" id="cRemarks" rows="3" placeholder="Any notes, submission details, or observations…" style="resize:vertical;min-height:72px"></textarea>
            </div>
            <div class="form-actions">
              <button class="btn btn-ghost" onclick="closeComplianceModal()">Cancel</button>
              <button class="btn btn-primary" onclick="saveCompliance()" style="width:auto">Save →</button>
            </div>
          </div>
        </div>
      </div>

<div class="overlay" id="templateModal" style="display:none" onclick="if(event.target===this)closeTemplates()">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title">📋 Task Templates</div>
      <button class="icon-btn" onclick="closeTemplates()">✕</button>
    </div>
    <div class="form-body" id="templateList"></div>
  </div>
</div>

<!-- SHORTCUTS MODAL -->
<div class="overlay" id="shortcutsModal" style="display:none" onclick="if(event.target===this)closeShortcuts()">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">⌨ Keyboard Shortcuts</div>
      <button class="icon-btn" onclick="closeShortcuts()">✕</button>
    </div>
    <div class="form-body">
      <table class="shortcuts-table">
        <tr><td>Open command palette</td><td><span class="kbd"><span class="key">⌘</span><span class="key">K</span></span></td></tr>
        <tr><td>New task</td><td><span class="kbd"><span class="key">N</span></span></td></tr>
        <tr><td>Search</td><td><span class="kbd"><span class="key">/</span></span></td></tr>
        <tr><td>Close panel / modal</td><td><span class="kbd"><span class="key">Esc</span></span></td></tr>
        <tr><td>Toggle sidebar</td><td><span class="kbd"><span class="key">B</span></span></td></tr>
        <tr><td>Switch to Tasks</td><td><span class="kbd"><span class="key">T</span></span></td></tr>
        <tr><td>Switch to Activity</td><td><span class="kbd"><span class="key">A</span></span></td></tr>
        <tr><td>Toggle dark mode</td><td><span class="kbd"><span class="key">D</span></span></td></tr>
        <tr><td>Board / List / Calendar view</td><td><span class="kbd"><span class="key">1</span></span> <span class="kbd"><span class="key">2</span></span> <span class="kbd"><span class="key">3</span></span></td></tr>
        <tr><td>Show shortcuts</td><td><span class="kbd"><span class="key">?</span></span></td></tr>
      </table>
    </div>
  </div>
</div>

<!-- ARCHIVE MODAL -->
<div class="overlay" id="archiveModal" style="display:none" onclick="if(event.target===this)closeArchive()">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title">📦 Archived Tasks</div>
      <button class="icon-btn" onclick="closeArchive()">✕</button>
    </div>
    <div class="form-body" id="archiveList" style="max-height:60vh;overflow-y:auto"></div>
  </div>
</div>

<!-- EMAIL MODAL -->
<div class="overlay" id="emailModal" style="display:none" onclick="if(event.target===this)closeEmailModal()">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">📧 Email Notification Setup</div>
      <button class="icon-btn" onclick="closeEmailModal()">✕</button>
    </div>
    <div class="form-body">
      <div class="info-box"><strong>How to get your free EmailJS keys:</strong><br>1. Visit <strong>emailjs.com</strong> → Sign up free<br>2. Add Email Service → copy <strong>Service ID</strong><br>3. Create Template → copy <strong>Template ID</strong><br>4. Account → API Keys → copy <strong>Public Key</strong></div>
      <div class="fg"><label>Public Key</label><input class="input" id="ej_pubkey" placeholder="user_xxxxxxxxxx"></div>
      <div class="form-row">
        <div class="fg"><label>Service ID</label><input class="input" id="ej_service" placeholder="service_xxxxxxx"></div>
        <div class="fg"><label>Template ID</label><input class="input" id="ej_template" placeholder="template_xxxxxxx"></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeEmailModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveEmailConfig()" style="width:auto">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- COMMAND PALETTE -->
<div id="cmdPalette" style="display:none" onclick="if(event.target===this)closeCmdPalette()">
  <div class="cmd-overlay" onclick="if(event.target===this)closeCmdPalette()">
    <div class="cmd-box">
      <div class="cmd-input-wrap">
        <span class="cmd-icon">⌘</span>
        <input class="cmd-input" id="cmdInput" placeholder="Type a command or search…" oninput="renderCmdResults(this.value)" onkeydown="cmdKey(event)">
        <span class="cmd-shortcut">Esc</span>
      </div>
      <div class="cmd-results" id="cmdResults"></div>
    </div>
  </div>
</div>

<!-- TOUR OVERLAY -->
<div id="tourOverlay" style="display:none" class="tour-overlay">
  <div class="tour-spotlight" id="tourSpotlight"></div>
  <div class="tour-tip" id="tourTip">
    <div class="tour-tip-num" id="tourNum"></div>
    <div class="tour-tip-title" id="tourTitle"></div>
    <div class="tour-tip-desc" id="tourDesc"></div>
    <div class="tour-dots" id="tourDots"></div>
    <div class="tour-btns">
      <button class="btn btn-ghost btn-sm" onclick="endTour()">Skip</button>
      <button class="btn btn-primary btn-sm" onclick="nextTourStep()" style="width:auto" id="tourNext">Next →</button>
    </div>
  </div>
</div>

<style>
/* Color swatches */
.color-swatch{width:24px;height:24px;border-radius:6px;border:2px solid var(--border);cursor:pointer;background:var(--c,transparent);transition:all .15s;font-size:.65rem;display:flex;align-items:center;justify-content:center;color:var(--ink-dim)}
.color-swatch.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(37,99,235,.3)}
[data-theme="dark"] .richtext-area{border-color:var(--border)}
.richtext-area[data-placeholder]:empty::before{content:attr(data-placeholder);color:var(--ink-dim);pointer-events:none}
/* Notif bell fix */
#notifBell{position:relative}
#notifBadgeInner{position:absolute;top:-4px;right:-4px;width:16px;height:16px;background:var(--red);border-radius:50%;font-size:.55rem;font-family:'JetBrains Mono',monospace;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;line-height:1;pointer-events:none}
/* Goal empty state */
.goals-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;text-align:center}
</style>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,onAuthStateChanged}from'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import{getDatabase,ref,set,onValue,push,remove,update}from'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

const FIREBASE_CONFIG={apiKey:"AIzaSyAzXRyASLi6DadFqFdb80iipyKezO5byd4",authDomain:"task-flow-65be7.firebaseapp.com",databaseURL:"https://task-flow-65be7-default-rtdb.firebaseio.com",projectId:"task-flow-65be7",appId:"1:572271775582:web:88dddc228c5511a9b409cf"};
const app=initializeApp(FIREBASE_CONFIG);const auth=getAuth(app);const db=getDatabase(app);

// ── CONSTANTS ──
const P={
  critical:{label:'Critical',color:'#b91c1c',bg:'#fef2f2',border:'#fca5a5',icon:'🔴'},
  high:{label:'High',color:'#c2410c',bg:'#fff7ed',border:'#fdba74',icon:'🟠'},
  medium:{label:'Medium',color:'#b45309',bg:'#fffbeb',border:'#fcd34d',icon:'🟡'},
  low:{label:'Low',color:'#047857',bg:'#ecfdf5',border:'#6ee7b7',icon:'🟢'}
};
const S={
  todo:{label:'To Do',color:'#475569',bg:'#f8fafc',border:'#cbd5e1',icon:'○'},
  in_progress:{label:'In Progress',color:'#1d4ed8',bg:'#eff6ff',border:'#93c5fd',icon:'◑'},
  review:{label:'In Review',color:'#6d28d9',bg:'#f5f3ff',border:'#c4b5fd',icon:'◷'},
  done:{label:'Done',color:'#047857',bg:'#ecfdf5',border:'#6ee7b7',icon:'✓'}
};
const CARD_COLORS=['','#fef3c7','#fce7f3','#dbeafe','#d1fae5','#ede9fe','#fee2e2','#e0f2fe','#f0fdf4'];
const TAG_COLORS=[{bg:'#eff6ff',border:'#93c5fd',color:'#1d4ed8'},{bg:'#f5f3ff',border:'#c4b5fd',color:'#6d28d9'},{bg:'#ecfdf5',border:'#6ee7b7',color:'#047857'},{bg:'#fff7ed',border:'#fdba74',color:'#c2410c'},{bg:'#fef2f2',border:'#fca5a5',color:'#b91c1c'},{bg:'#fdf4ff',border:'#e879f9',color:'#a21caf'},{bg:'#f0fdf4',border:'#86efac',color:'#15803d'},{bg:'#f0f9ff',border:'#7dd3fc',color:'#0369a1'}];
const TEMPLATES=[
  {name:'Monthly Report',icon:'📊',priority:'high',status:'todo',tags:['report','monthly'],description:'Prepare the monthly financial report including P&L, balance sheet and cash flow.',subtasks:[{text:'Collect data from departments',done:false,id:'t1'},{text:'Review previous month actuals',done:false,id:'t2'},{text:'Draft report',done:false,id:'t3'},{text:'Review & approve',done:false,id:'t4'}]},
  {name:'Client Review',icon:'👥',priority:'medium',status:'todo',tags:['client','review'],description:'Schedule and conduct client account review meeting.',subtasks:[{text:'Prepare agenda',done:false,id:'t1'},{text:'Send calendar invite',done:false,id:'t2'},{text:'Prepare presentation',done:false,id:'t3'}]},
  {name:'Audit Preparation',icon:'🔍',priority:'critical',status:'todo',tags:['audit','compliance'],description:'Prepare documentation and financial records for upcoming audit.',subtasks:[{text:'Gather transaction records',done:false,id:'t1'},{text:'Reconcile accounts',done:false,id:'t2'},{text:'Prepare supporting documents',done:false,id:'t3'},{text:'Conduct internal review',done:false,id:'t4'}]},
  {name:'Budget Planning',icon:'💰',priority:'high',status:'todo',tags:['budget','planning'],description:'Annual budget planning and forecast for next financial year.',subtasks:[{text:'Collect department inputs',done:false,id:'t1'},{text:'Draft initial budget',done:false,id:'t2'},{text:'Review with management',done:false,id:'t3'}]},
  {name:'Invoice Processing',icon:'📄',priority:'medium',status:'todo',tags:['invoice','finance'],description:'Process and verify incoming invoices for payment.',subtasks:[{text:'Receive and log invoices',done:false,id:'t1'},{text:'Verify against PO',done:false,id:'t2'},{text:'Approve for payment',done:false,id:'t3'}]},
];
const EMOJIS=['👍','❤️','😂','🎉','💡','🔥'];
const COLORS=['#059669','#ea580c','#2563eb','#d97706','#7c3aed','#dc2626','#0891b2','#db2777'];
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2);
const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
window.openLink=function(id){const t=tasks.find(x=>x.id===id);if(t&&t.link){window.open(t.link,'_blank','noopener,noreferrer');}else{toast('No link attached.');}};
const gi=n=>n?n.split(' ').map(p=>p[0]).join('').toUpperCase().slice(0,2):'?';
const av=(m,sz)=>`<div class="avatar" style="width:${sz}px;height:${sz}px;background:${m?.color||'#64748b'};font-size:${sz*.36}px">${gi(m?.name||'?')}</div>`;
function fd(d){if(!d)return null;const dt=new Date(d+'T00:00:00'),now=new Date(),diff=Math.ceil((dt-now)/86400000);if(diff<0)return{text:`${Math.abs(diff)}d overdue`,cls:'overdue'};if(diff===0)return{text:'Due today',cls:'warning'};if(diff===1)return{text:'Due tomorrow',cls:'warning'};return{text:dt.toLocaleDateString('en-IN',{month:'short',day:'numeric'}),cls:''};}
function ta(ts){const d=Math.floor((Date.now()-ts)/1000);if(d<60)return'just now';if(d<3600)return`${Math.floor(d/60)}m ago`;if(d<86400)return`${Math.floor(d/3600)}h ago`;return`${Math.floor(d/86400)}d ago`;}
function tagColor(tag){const h=Array.from(tag).reduce((a,c)=>a+c.charCodeAt(0),0);return TAG_COLORS[h%TAG_COLORS.length];}
function fmtTime(ms){if(!ms)return'0m';const h=Math.floor(ms/3600000);const m=Math.floor((ms%3600000)/60000);return h?`${h}h ${m}m`:`${m}m`;}
function fmtDate(ts){if(!ts)return null;return new Date(ts).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});}

let members=[],tasks=[],activity=[],currentUser=null,currentUserProfile=null;
let filters={status:'',priority:'',assignee:'',dueFilter:''},currentView='tasks',openDetailId=null,currentDashboard='personal';
let currentViewMode='board',selectedTasks=new Set();
let pendingTags=[],pendingSubtasks=[],pendingColor='',pendingRecur='';
let calYear=new Date().getFullYear(),calMonth=new Date().getMonth();
let dragSrcId=null;
let timers={};// {taskId:{start,logged}} 
let undoStack=[];
let chartInstances={};
let tourStep=0;

// ── INVITE TOKEN ──
const _INVITE_SECRET='gf-invite-2025'; // Change this to a real secret in production
const _urlParams=new URLSearchParams(location.search);
const _inviteToken=_urlParams.get('invite');
const _inviteValid=_inviteToken===_INVITE_SECRET;

// ── SESSION TIMEOUT (5 minutes) ──
const SESSION_TIMEOUT_MS=5*60*1000;
let _sessionTimer=null;
function resetSessionTimer(){
  if(!currentUser)return;
  clearTimeout(_sessionTimer);
  _sessionTimer=setTimeout(async()=>{
    toast('⏱ Session expired due to inactivity. Signing out…',4000);
    await new Promise(r=>setTimeout(r,1500));
    await signOut(auth);
  },SESSION_TIMEOUT_MS);
}
function initSessionTimeout(){
  ['mousemove','mousedown','keydown','touchstart','scroll','click'].forEach(evt=>{
    document.addEventListener(evt,resetSessionTimer,{passive:true});
  });
  resetSessionTimer();
}
function clearSessionTimeout(){
  clearTimeout(_sessionTimer);
  ['mousemove','mousedown','keydown','touchstart','scroll','click'].forEach(evt=>{
    document.removeEventListener(evt,resetSessionTimer);
  });
}

// ── DARK MODE ──
const savedTheme=localStorage.getItem('tf_theme')||'light';
document.documentElement.setAttribute('data-theme',savedTheme);
window.toggleTheme=function(){const cur=document.documentElement.getAttribute('data-theme');const next=cur==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',next);localStorage.setItem('tf_theme',next);};

// ── TOAST with UNDO ──
window.toast=function(msg,dur=3000,undoFn=null){
  const wrap=document.getElementById('toastWrap');
  const t=document.createElement('div');t.className='toast';
  const txt=document.createElement('span');txt.textContent=msg;t.appendChild(txt);
  if(undoFn){const u=document.createElement('button');u.className='toast-undo';u.textContent='Undo';u.onclick=()=>{undoFn();t.remove();};t.appendChild(u);}
  wrap.appendChild(t);setTimeout(()=>t.remove(),dur);
};

// ── COLOR PICKER ──
function initColorPicker(){
  const cp=document.getElementById('colorPicker');
  cp.innerHTML=`<button class="color-swatch ${pendingColor===''?'active':''}" style="--c:transparent" onclick="selectColor('')" title="None">✕</button>`+
  CARD_COLORS.slice(1).map(c=>`<button class="color-swatch ${pendingColor===c?'active':''}" style="--c:${c};background:${c}" onclick="selectColor('${c}')"></button>`).join('');
}
window.selectColor=function(c){pendingColor=c;initColorPicker();};

// ── RECURRING ──
window.selectRecur=function(btn,val){pendingRecur=val;document.querySelectorAll('.recur-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');};

// ── RICH TEXT ──
window.execFmt=function(cmd){document.getElementById('tDesc').focus();document.execCommand(cmd);};

// ── GLOBAL SEARCH ──
let gsrFocus=-1;
window.globalSearchInput=function(q){
  gsrFocus=-1;const res=document.getElementById('globalResults');
  if(!q.trim()){res.style.display='none';return;}
  const lower=q.toLowerCase();
  const hits=tasks.filter(t=>t.title.toLowerCase().includes(lower)||(t.description||'').toLowerCase().includes(lower)&&!t.archived).slice(0,8);
  if(!hits.length){res.innerHTML='<div class="gsr-item"><div class="gsr-title" style="color:var(--ink-dim)">No results</div></div>';res.style.display='block';return;}
  res.innerHTML=hits.map(t=>{const p=P[t.priority]||P.medium;const s_=S[t.status]||S.todo;return`<div class="gsr-item" onclick="globalSearchGo('${t.id}')" data-id="${t.id}"><div style="font-size:.9rem">${p.icon}</div><div><div class="gsr-title">${esc(t.title)}</div><div class="gsr-meta">${s_.label} · ${p.label}</div></div></div>`;}).join('');
  res.style.display='block';
};
window.globalSearchKey=function(e){
  const items=document.querySelectorAll('#globalResults .gsr-item');
  if(e.key==='ArrowDown'){gsrFocus=Math.min(gsrFocus+1,items.length-1);items.forEach((el,i)=>el.classList.toggle('active',i===gsrFocus));}
  else if(e.key==='ArrowUp'){gsrFocus=Math.max(gsrFocus-1,0);items.forEach((el,i)=>el.classList.toggle('active',i===gsrFocus));}
  else if(e.key==='Enter'&&gsrFocus>=0){items[gsrFocus]?.click();}
  else if(e.key==='Escape'){hideGlobalResults();}
};
window.hideGlobalResults=function(){document.getElementById('globalResults').style.display='none';document.getElementById('globalSearch').value='';gsrFocus=-1;};
window.globalSearchGo=function(id){hideGlobalResults();switchView('tasks');openDetail(id);};

// ── SIDEBAR ──
window.toggleSidebar=function(){
  const sb=document.getElementById('mainSidebar');
  sb.classList.toggle('collapsed');
  if(window.innerWidth<=768)sb.classList.toggle('mobile-open');
};

// ── VIEW MODE ──
window.setViewMode=function(mode){
  currentViewMode=mode;
  ['board','list','calendar','workload'].forEach(m=>{document.getElementById('vb_'+m)?.classList.toggle('active',m===mode);});
  document.getElementById('tasksGridWrap').style.display=(['board','list'].includes(mode))?'block':'none';
  document.getElementById('calendarWrap').style.display=mode==='calendar'?'block':'none';
  document.getElementById('workloadWrap').style.display=mode==='workload'?'block':'none';
  if(mode==='board'||mode==='list')document.getElementById('tasksGrouped').style.display=mode==='board'?'flex':'block';
  if(mode==='calendar')renderCalendar();
  else if(mode==='workload')renderWorkload();
  else renderTasks();
};

// ── CALENDAR ──
window.calNav=function(dir){calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}else if(calMonth<0){calMonth=11;calYear--;}renderCalendar();};
window.calGoToday=function(){calYear=new Date().getFullYear();calMonth=new Date().getMonth();renderCalendar();};
function renderCalendar(){
  const grid=document.getElementById('calGrid');const title=document.getElementById('calTitle');
  const monthNames=['January','February','March','April','May','June','July','August','September','October','November','December'];
  title.textContent=`${monthNames[calMonth]} ${calYear}`;
  const startDay=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const daysInPrev=new Date(calYear,calMonth,0).getDate();
  const f=getFiltered();const today=new Date();
  let html=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>`<div class="cal-day-label">${d}</div>`).join('');
  for(let i=startDay-1;i>=0;i--){html+=`<div class="cal-day other-month"><div class="cal-date">${daysInPrev-i}</div></div>`;}
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=d===today.getDate()&&calMonth===today.getMonth()&&calYear===today.getFullYear();
    const dt=f.filter(t=>t.due===ds);
    html+=`<div class="cal-day${isToday?' today':''}"><div class="cal-date">${d}</div>${dt.slice(0,3).map(t=>{const p=P[t.priority]||P.medium;return`<span class="cal-task-chip" style="background:${p.bg};color:${p.color}" onclick="openDetail('${t.id}')" title="${esc(t.title)}">${esc(t.title)}</span>`;}).join('')}${dt.length>3?`<span style="font-size:.6rem;color:var(--ink-dim)">+${dt.length-3}</span>`:''}</div>`;
  }
  const total=startDay+daysInMonth;const rem=(7-total%7)%7;
  for(let d=1;d<=rem;d++){html+=`<div class="cal-day other-month"><div class="cal-date">${d}</div></div>`;}
  grid.innerHTML=html;
}

// ── WORKLOAD VIEW ──
function renderWorkload(){
  const wrap=document.getElementById('workloadWrap');
  const f=getFiltered().filter(t=>t.status!=='done');
  const byMember={};
  members.forEach(m=>{byMember[m.id]={member:m,tasks:[],time:0,estTotal:0};});
  f.forEach(t=>{if(t.assigneeId&&byMember[t.assigneeId]){byMember[t.assigneeId].tasks.push(t);byMember[t.assigneeId].time+=(t.timeLogged||0);byMember[t.assigneeId].estTotal+=(t.estimatedTime||0)*3600000;}});
  const rows=Object.values(byMember).sort((a,b)=>b.tasks.length-a.tasks.length);
  const max=Math.max(1,...rows.map(r=>r.tasks.length));
  const colors=['#2563eb','#7c3aed','#059669','#d97706','#dc2626','#0891b2'];
  wrap.innerHTML=`<div style="margin-bottom:20px"><div class="pg-title">Workload & Capacity</div><div class="pg-sub">Open tasks and estimated load per team member</div></div>`+
  (rows.length?rows.map((r,i)=>{
    const pct=Math.round((r.tasks.length/max)*100);
    const overloaded=r.tasks.length>=5;
    const capacityPct=r.estTotal>0?Math.min(120,Math.round((r.estTotal/(40*3600000))*100)):0;// 40h week baseline
    const heatColor=capacityPct>=100?'var(--red)':capacityPct>=70?'var(--amber)':'var(--green)';
    return`<div class="workload-row" style="flex-wrap:wrap;gap:10px">
      ${av(r.member,36)}
      <div style="min-width:120px"><div style="font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:.88rem;letter-spacing:-.02em">${esc(r.member.name)}</div><div style="font-size:.72rem;color:var(--ink-dim)">${r.tasks.length} task${r.tasks.length!==1?'s':''} · ${fmtTime(r.time)} logged</div></div>
      <div style="flex:1;min-width:140px">
        <div style="display:flex;justify-content:space-between;font-size:.65rem;color:var(--ink-dim);margin-bottom:3px"><span>Task Load</span><span>${r.tasks.length}</span></div>
        <div class="workload-bar-wrap"><div class="workload-bar" style="width:${pct}%;background:${overloaded?'var(--red)':colors[i%colors.length]}"></div></div>
      </div>
      ${r.estTotal>0?`<div style="min-width:120px"><div style="display:flex;justify-content:space-between;font-size:.65rem;color:var(--ink-dim);margin-bottom:3px"><span>Capacity</span><span style="color:${heatColor};font-weight:700">${capacityPct}%</span></div><div style="height:7px;background:var(--border);border-radius:99px"><div style="height:100%;width:${Math.min(100,capacityPct)}%;background:${heatColor};border-radius:99px;transition:width .3s"></div></div></div>`:''}
      ${overloaded?`<span class="badge" style="background:var(--red-bg);color:var(--red);border-color:var(--red-border)">⚠ Overloaded</span>`:''}
      ${capacityPct>=100?`<span class="badge" style="background:var(--red-bg);color:var(--red);border-color:var(--red-border)">🔥 At Capacity</span>`:''}
      ${capacityPct>=70&&capacityPct<100?`<span class="badge" style="background:var(--amber-bg);color:var(--amber);border-color:var(--amber-border)">⚡ High Load</span>`:''}
    </div>`;
  }).join(''):`<div class="empty"><div class="ei">✅</div><div class="empty-title">No open tasks</div></div>`);
}

// ── DUE FILTERS ──
window.tfDue=function(key){
  filters.dueFilter=filters.dueFilter===key?'':key;
  ['today','week','overdue'].forEach(k=>{document.getElementById('duf_'+k)?.classList.toggle('active',filters.dueFilter===k);});
  document.getElementById('cfBtn').style.display=hasActiveFilters()?'':'none';
  renderTasks();
};
function hasActiveFilters(){return Object.values(filters).some(v=>v)||document.getElementById('searchInput')?.value;}

// ── TAGS ──
window.handleTagKey=function(e){
  const inp=document.getElementById('tagInput');
  if(e.key==='Enter'||e.key===','){e.preventDefault();const val=inp.value.trim().replace(/,/g,'');if(val&&!pendingTags.includes(val)){pendingTags.push(val);renderPendingTags();}inp.value='';}
  else if(e.key==='Backspace'&&!inp.value&&pendingTags.length){pendingTags.pop();renderPendingTags();}
};
function renderPendingTags(){const c=document.getElementById('tagBadges');if(!c)return;c.innerHTML=pendingTags.map((t,i)=>{const tc=tagColor(t);return`<span class="tag-badge" style="background:${tc.bg};border:1px solid ${tc.border};color:${tc.color}">${esc(t)}<button onclick="removeTag(${i})" type="button">×</button></span>`;}).join('');}
window.removeTag=function(i){pendingTags.splice(i,1);renderPendingTags();};

// ── SUBTASKS ──
window.addSubtask=function(){const inp=document.getElementById('subtaskInput');const val=inp.value.trim();if(!val)return;pendingSubtasks.push({text:val,done:false,id:uid()});inp.value='';renderPendingSubtasks();};
function renderPendingSubtasks(){const el=document.getElementById('subtaskList');if(!el)return;el.innerHTML=pendingSubtasks.map((st,i)=>`<div class="subtask-item"><input type="checkbox" ${st.done?'checked':''} onchange="togglePendingSubtask(${i})"><span class="subtask-text${st.done?' done':''}">${esc(st.text)}</span><button class="subtask-del" onclick="removePendingSubtask(${i})" type="button">✕</button></div>`).join('');}
window.togglePendingSubtask=function(i){pendingSubtasks[i].done=!pendingSubtasks[i].done;renderPendingSubtasks();};
window.removePendingSubtask=function(i){pendingSubtasks.splice(i,1);renderPendingSubtasks();};

// ── TIME TRACKER ──
window.startTimer=function(id){
  if(timers[id]?.start){stopTimer(id);return;}
  timers[id]={start:Date.now(),logged:timers[id]?.logged||0};
  const t=tasks.find(x=>x.id===id);if(t){timers[id].logged=t.timeLogged||0;}
  renderDetail();startTimerTick(id);toast(`⏱ Timer started for task`);
};
function startTimerTick(id){
  if(timers[id]?.tick)clearInterval(timers[id].tick);
  timers[id].tick=setInterval(()=>{
    const el=document.getElementById('timerDisplay_'+id);
    if(el){const elapsed=Date.now()-timers[id].start+timers[id].logged;el.textContent=fmtTime(elapsed);}
  },1000);
}
window.stopTimer=async function(id){
  if(!timers[id]?.start)return;
  clearInterval(timers[id]?.tick);
  const elapsed=Date.now()-timers[id].start;
  timers[id].logged=(timers[id].logged||0)+elapsed;
  timers[id].start=null;
  await update(ref(db,`tasks/${id}`),{timeLogged:timers[id].logged});
  await log(id,currentUser.uid,`Time logged: ${fmtTime(elapsed)}`);
  renderDetail();toast(`⏱ Logged ${fmtTime(elapsed)}`);
};

// ── BULK ACTIONS ──
window.toggleSelectTask=function(e,id){
  e.stopPropagation();
  if(selectedTasks.has(id))selectedTasks.delete(id);else selectedTasks.add(id);
  updateBulkToolbar();renderTasks();
};
function updateBulkToolbar(){
  const bt=document.getElementById('bulkToolbar');const bc=document.getElementById('bulkCount');
  bt.classList.toggle('visible',selectedTasks.size>0);
  if(bc)bc.textContent=`${selectedTasks.size} selected`;
  // Show/hide assign btn for admins only
  const ab=document.getElementById('bulkAssignBtn');if(ab)ab.style.display=isAdmin()?'':'none';
}
window.clearSelection=function(){selectedTasks.clear();updateBulkToolbar();renderTasks();};
window.bulkComplete=async function(){for(const id of selectedTasks){await update(ref(db,`tasks/${id}`),{status:'done',finishedAt:Date.now()});}toast(`✅ ${selectedTasks.size} tasks completed`);clearSelection();};
window.bulkReopen=async function(){for(const id of selectedTasks){await update(ref(db,`tasks/${id}`),{status:'todo',finishedAt:null});}toast(`↩ ${selectedTasks.size} tasks reopened`);clearSelection();};
window.bulkDelete=async function(){if(!confirm(`Delete ${selectedTasks.size} tasks?`))return;const ids=[...selectedTasks];for(const id of ids){await remove(ref(db,`tasks/${id}`));}toast(`🗑 ${ids.length} tasks deleted`);clearSelection();};
window.bulkArchive=async function(){const ids=[...selectedTasks];for(const id of ids){await update(ref(db,`tasks/${id}`),{archived:true});}toast(`📦 ${ids.length} tasks archived`,4000,async()=>{for(const id of ids){await update(ref(db,`tasks/${id}`),{archived:false});}});clearSelection();};
window.showBulkAssign=function(){const m=prompt('Assign to member ID (type member name):');if(m){const found=members.find(x=>x.name.toLowerCase().includes(m.toLowerCase()));if(found){selectedTasks.forEach(async id=>{await update(ref(db,`tasks/${id}`),{assigneeId:found.id,assignedAt:Date.now()});});toast(`👤 Assigned to ${found.name}`);clearSelection();}}};

// ── DRAG & DROP ──
window.onDragStart=function(e,id){dragSrcId=id;e.dataTransfer.effectAllowed='move';setTimeout(()=>document.getElementById('tc_'+id)?.classList.add('dragging'),0);};
window.onDragEnd=function(e,id){document.getElementById('tc_'+id)?.classList.remove('dragging');document.querySelectorAll('.kanban-cards').forEach(c=>c.classList.remove('drag-over'));};
window.onDragOver=function(e,colKey){e.preventDefault();e.dataTransfer.dropEffect='move';document.querySelectorAll('.kanban-cards').forEach(c=>c.classList.remove('drag-over'));document.getElementById('kc_'+colKey)?.classList.add('drag-over');};
window.onDrop=async function(e,colKey,groupBy){
  e.preventDefault();document.querySelectorAll('.kanban-cards').forEach(c=>c.classList.remove('drag-over'));
  if(!dragSrcId)return;const t=tasks.find(x=>x.id===dragSrcId);if(!t)return;
  const field=groupBy==='status'?'status':'priority';if(t[field]===colKey)return;
  const upd={};upd[field]=colKey;if(field==='status'){upd.finishedAt=colKey==='done'?Date.now():null;}
  await update(ref(db,`tasks/${dragSrcId}`),upd);
  await log(dragSrcId,currentUser.uid,field==='status'?`Status → ${S[colKey]?.label||colKey}`:`Priority → ${P[colKey]?.label||colKey}`);
  dragSrcId=null;
};

// ── CARD MENU ──
window.openCardMenu=function(e,id){
  e.stopPropagation();
  document.querySelectorAll('.card-dropdown').forEach(d=>d.classList.remove('open'));
  const dd=document.getElementById('cd_'+id);
  if(dd){dd.classList.toggle('open');setTimeout(()=>document.addEventListener('click',function h(){dd.classList.remove('open');document.removeEventListener('click',h);}),0);}
};

// ── CHECKBOX ──
window.toggleTaskDone=async function(e,id){
  e.stopPropagation();const t=tasks.find(x=>x.id===id);if(!t)return;
  const ns=t.status==='done'?'todo':'done';
  // Optimistic UI: update local state immediately so the card reflects change at once
  t.status=ns;t.finishedAt=ns==='done'?Date.now():null;
  // Visually update checkbox and card title right away
  const card=document.getElementById('tc_'+id);
  if(card){
    const cb=card.querySelector('.checkbox-btn');
    if(cb){cb.classList.toggle('checked',ns==='done');}
    const title=card.querySelector('.card-title');
    if(title){title.classList.toggle('done-title',ns==='done');}
  }
  // Also re-render if detail panel is open
  if(openDetailId===id)renderDetail();
  // Now persist to Firebase
  await update(ref(db,`tasks/${id}`),{status:ns,finishedAt:ns==='done'?Date.now():null});
  await log(id,currentUser.uid,`Status → ${S[ns]?.label||ns}`);
  if(ns==='done')await runAutomations('status_done',t);
  toast(ns==='done'?'✅ Task completed!':'↩ Task reopened');
};

// ── AUTH ──
// ── PORTAL SELECTION ──
let selectedPortalRole='member';
window.selectPortal=function(role){
  selectedPortalRole=role;
  const isAdm=role==='admin';
  document.getElementById('regRole').value=role;
  // Update toggle button styles
  const ba=document.getElementById('portalBtnAdmin');
  const bm=document.getElementById('portalBtnMember');
  if(ba){ba.className=isAdm?'portal-btn active-admin':'portal-btn';}
  if(bm){bm.className=isAdm?'portal-btn':'portal-btn active-member';}
  // Update title/sub
  document.getElementById('authTitle').textContent=isAdm?'Admin Sign In':'Member Sign In';
  document.getElementById('authSub').textContent=isAdm?'Sign in to manage your team workspace':'Sign in to your personal dashboard';
  document.getElementById('authPortalInfo').innerHTML=isAdm?'🏆 Admin access · Manage team, tasks & compliance':'👤 Member access · Personal tasks, notes & assignments';
  // Update button gradient
  const lb=document.getElementById('loginBtn');const rb=document.getElementById('registerBtn');
  if(lb)lb.style.background=isAdm?'var(--grad-accent)':'linear-gradient(135deg,#0a9060,#059669)';
  if(rb)rb.style.background=isAdm?'var(--grad-accent)':'linear-gradient(135deg,#0a9060,#059669)';
  // Show/hide register tab: admins never register; members only via invite
  const regTab=document.getElementById('registerTabBtn');
  if(regTab){
    if(isAdm){
      regTab.style.display='none';
      switchAuthTab('login');
    } else if(_inviteValid){
      regTab.style.display='';
      regTab.style.opacity='1';
      regTab.title='';
    } else {
      regTab.style.display='none';
    }
  }
  document.getElementById('authErr').style.display='none';
};
window.backToPortal=function(){
  document.getElementById('authErr').style.display='none';
};

window.switchAuthTab=function(tab){
  // Block register tab if no valid invite token
  if(tab==='register'&&!_inviteValid){
    const err=document.getElementById('authErr');
    err.textContent='Registration requires a valid invite link from your admin.';
    err.style.display='block';
    return;
  }
  document.getElementById('loginForm').style.display=tab==='login'?'block':'none';
  document.getElementById('registerForm').style.display=tab==='register'?'block':'none';
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',['login','register'][i]===tab));
  document.getElementById('authTitle').textContent=tab==='login'?'Welcome back':'Create your account';
  document.getElementById('authSub').textContent=tab==='login'?'Sign in to your workspace':'Join your team today';
  document.getElementById('authErr').style.display='none';
};
window.doLogin=async function(){
  const email=document.getElementById('loginEmail').value.trim();const pw=document.getElementById('loginPassword').value;
  const err=document.getElementById('authErr');if(!email||!pw){err.textContent='Please fill in all fields.';err.style.display='block';return;}
  try{
    const cred=await signInWithEmailAndPassword(auth,email,pw);
    // Role enforcement: check Firebase profile role vs selected portal
    const snap=await new Promise(res=>onValue(ref(db,`members/${cred.user.uid}`),res,{onlyOnce:true}));
    const profile=snap.val();
    const actualRole=profile?.role||'member';
    if(actualRole!==selectedPortalRole){
      await signOut(auth);
      err.textContent=actualRole==='admin'
        ?'This account is an Admin. Please sign in via the Admin Portal.'
        :'This account is a Member. Please sign in via the Team Member Portal.';
      err.style.display='block';
      return;
    }
  }catch(e){err.textContent=e.code==='auth/invalid-credential'?'Invalid email or password.':e.message;err.style.display='block';}
};
window.doRegister=async function(){
  const name=document.getElementById('regName').value.trim();const email=document.getElementById('regEmail').value.trim();
  const pw=document.getElementById('regPassword').value;const role=selectedPortalRole;
  const err=document.getElementById('authErr');if(!name||!email||!pw){err.textContent='Fill all fields.';err.style.display='block';return;}
  try{
    const cred=await createUserWithEmailAndPassword(auth,email,pw);
    await set(ref(db,`members/${cred.user.uid}`),{name,email,role,color:COLORS[Math.floor(Math.random()*COLORS.length)],createdAt:Date.now()});
    localStorage.setItem('gf_newuser_'+cred.user.uid,'1');
  }
  catch(e){err.textContent=e.code==='auth/email-already-in-use'?'Email already registered.':e.message;err.style.display='block';}
};
window.generateInviteLink=function(){
  const box=document.getElementById('inviteLinkBox');
  const inp=document.getElementById('inviteLinkInput');
  const base=location.origin+location.pathname;
  inp.value=base+'?invite=gf-invite-2025';
  box.style.display='flex';
};
window.copyInviteLink=function(){
  const inp=document.getElementById('inviteLinkInput');
  navigator.clipboard.writeText(inp.value).then(()=>toast('📋 Invite link copied!')).catch(()=>{inp.select();document.execCommand('copy');toast('📋 Copied!');});
};
window.doLogout=async function(){await signOut(auth);};

onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;
    document.getElementById('authScreen').style.display='none';
    document.getElementById('app').style.display='block';
    subscribeAll();
    initSessionTimeout();
    // Check if first-ever login for this user
    const isNew=localStorage.getItem('gf_newuser_'+user.uid)==='1';
    if(isNew){
      // Show welcome screen after profile loads (wait for subscribeAll)
      setTimeout(()=>showWelcomeModal(),1200);
    } else if(!localStorage.getItem('tf_toured')){
      setTimeout(startTour,1000);
    }
  } else {
    currentUser=null;currentUserProfile=null;
    clearSessionTimeout();
    document.getElementById('authScreen').style.display='flex';
    document.getElementById('app').style.display='none';
    // Reset login form
    document.getElementById('loginEmail').value='';
    document.getElementById('loginPassword').value='';
    switchAuthTab('login');
  }
});

// ── FIREBASE ──
function subscribeAll(){
  onValue(ref(db,'members'),snap=>{const v=snap.val()||{};members=Object.entries(v).map(([id,m])=>({id,...m}));currentUserProfile=members.find(m=>m.id===currentUser?.uid)||null;updateUserHeader();renderAll();if(currentView==='compliance')renderCompliance();});
  onValue(ref(db,'tasks'),snap=>{const v=snap.val()||{};const VP=['critical','high','medium','low'];const VS=['todo','in_progress','review','done'];
    const prevTasks=[...tasks];
    tasks=Object.entries(v).map(([id,t])=>({id,...t,priority:VP.includes(t.priority)?t.priority:'medium',status:VS.includes(t.status)?t.status:'todo',tags:t.tags||[],subtasks:t.subtasks||[],timeLogged:t.timeLogged||0,color:t.color||'',archived:t.archived||false}));// restore timers logged
    tasks.forEach(t=>{if(timers[t.id]&&!timers[t.id].start){timers[t.id].logged=t.timeLogged||0;}});
    // Notify admin when any OTHER member marks a task done
    if(currentUser&&prevTasks.length>0){
      tasks.forEach(t=>{
        const prev=prevTasks.find(p=>p.id===t.id);
        if(prev&&prev.status!=='done'&&t.status==='done'&&t.finishedAt&&t.assigneeId&&t.assigneeId!==currentUser.uid){
          const completer=members.find(m=>m.id===t.assigneeId)||members.find(m=>m.id===t.createdBy);
          const who=completer?completer.name:'A team member';
          addNotification(`✅ Task Completed`,`${who} completed "${t.title}"`,t.id);
        }
      });
    }
    renderAll();if(openDetailId)renderDetail();
    // Check recurring tasks
    checkRecurring();
    // Auto-delete done tasks older than 90 days (admin only, runs once per session)
    if(isAdmin())autoDeleteOldDoneTasks();
  });
  onValue(ref(db,'activity'),snap=>{const v=snap.val()||{};activity=Object.entries(v).map(([id,a])=>({id,...a})).sort((a,b)=>b.ts-a.ts).slice(0,300);renderActivity();});
  subscribeCompliance();
}

// ── RECURRING TASKS ──
async function checkRecurring(){
  const now=new Date();
  const recurTasks=tasks.filter(t=>t.recur&&t.status==='done'&&t.finishedAt);
  for(const t of recurTasks){
    const fin=new Date(t.finishedAt);
    const needNew=(t.recur==='daily'&&(now-fin)>=86400000)||(t.recur==='weekly'&&(now-fin)>=604800000)||(t.recur==='monthly'&&now.getMonth()!==fin.getMonth());
    if(needNew){
      const newId=uid();
      const nd={...t,id:undefined,status:'todo',finishedAt:null,ts:Date.now(),recur:t.recur};
      delete nd.id;await set(ref(db,`tasks/${newId}`),{...nd,createdBy:t.createdBy,ts:Date.now(),comments:{}});
    }
  }
}

// ── AUTO-DELETE DONE TASKS AFTER 90 DAYS ──
let _autoDeleteRan=false;
async function autoDeleteOldDoneTasks(){
  if(_autoDeleteRan)return; // run once per session
  _autoDeleteRan=true;
  const NINETY_DAYS=90*24*60*60*1000;
  const now=Date.now();
  const expired=tasks.filter(t=>
    t.status==='done'&&
    !t.archived&&
    t.finishedAt&&
    (now-t.finishedAt)>=NINETY_DAYS
  );
  if(!expired.length)return;

  // ── Auto-export CSV before deleting ──
  const headers=['#','Title','Priority','Status','Assigned To','Created','Completed','Tags','Description'];
  const rows=expired.map((t,i)=>{
    const assignee=members.find(m=>m.id===t.assigneeId);
    const created=t.ts?new Date(t.ts).toLocaleDateString('en-IN'):'';
    const finished=t.finishedAt?new Date(t.finishedAt).toLocaleDateString('en-IN'):'';
    return[
      i+1,
      `"${(t.title||'').replace(/"/g,'""')}"`,
      t.priority||'',
      'Done',
      assignee?`"${assignee.name}"`:'Unassigned',
      created,
      finished,
      `"${(t.tags||[]).join(', ')}"`,
      `"${(t.description||'').replace(/"/g,'""')}"`
    ];
  });
  const csv=[headers.join(','),...rows.map(r=>r.join(','))].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  const dateStr=new Date().toISOString().slice(0,10);
  a.download=`done-tasks-archive-${dateStr}.csv`;
  a.click();
  URL.revokeObjectURL(url);

  // ── Now delete from Firebase ──
  for(const t of expired){
    await remove(ref(db,`tasks/${t.id}`));
  }
  toast(`📥 Archived & deleted ${expired.length} completed task${expired.length>1?'s':''} older than 90 days`);
  console.log(`[Auto-clean] Exported and deleted ${expired.length} done tasks older than 90 days`);
}

function updateUserHeader(){
  if(!currentUserProfile)return;const m=currentUserProfile;
  document.getElementById('userAvatar').innerHTML=av(m,22);
  document.getElementById('userName').textContent=m.name.split(' ')[0];
  const rb=document.getElementById('userRoleBadge');rb.textContent=m.role==='admin'?'Admin':'Member';rb.className='role-badge '+(m.role==='admin'?'role-admin':'role-member');
  const isAdm=m.role==='admin';
  document.getElementById('teamTab').style.display=isAdm?'':'none';
  document.getElementById('teamFilterSection').style.display=isAdm?'':'none';
  document.getElementById('reportTab').style.display=isAdm?'':'none';
  // Hide admin-only sidebar actions from members
  const actSec=document.getElementById('adminActionsSection');
  if(actSec)actSec.style.display=isAdm?'block':'none';
  // Also hide compliance tab for members with no assignments — tab always visible but content filtered
  // Force re-render compliance if currently viewing it
  if(currentView==='compliance') renderCompliance();
  // Notes shortcut: visible to ALL users on personal dashboard
  const notesWrap=document.getElementById('notesShortcutWrap');
  if(notesWrap)notesWrap.style.display=(currentDashboard==='personal')?'':'none';
  // If admin somehow landed on notes, redirect to personal
  if(isAdm&&currentDashboard==='notes')switchDashboard('personal');
  updateDashboardButtons();
  if(isAdm&&!document.getElementById('emailConfigBtn')){
    const hr=document.querySelector('.header-right');
    const b=document.createElement('button');b.id='emailConfigBtn';b.className='btn btn-ghost btn-sm';b.textContent='📧';b.onclick=openEmailConfig;
    hr.insertBefore(b,hr.querySelector('.h-divider'));
  }
}
function updateDashboardButtons(){
  const isAdm=isAdmin();
  const nb=document.getElementById('newTaskBtn');const pb=document.getElementById('newPersonalTaskBtn');const tb=document.getElementById('tplBtn');
  if(nb)nb.style.display=(currentDashboard==='team'&&isAdm)?'':'none';
  if(pb)pb.style.display=currentDashboard==='personal'?'':'none';
  if(tb)tb.style.display=isAdm?'inline-flex':'none';
}
window.switchDashboard=function(dash){
  currentDashboard=dash;
  document.getElementById('dashPersonalBtn').className='dash-tab personal'+(dash==='personal'?' active':'');
  document.getElementById('dashTeamBtn').className='dash-tab team'+(dash==='team'?' active':'');

  // Show notes shortcut for all users on personal dashboard
  const notesShortcut=document.getElementById('notesShortcutWrap');
  if(notesShortcut)notesShortcut.style.display=(dash==='personal')?'':'none';

  // Show/hide notes wrap vs task wrap
  const isNotes=dash==='notes';
  const tasksGridWrap=document.getElementById('tasksGridWrap');
  const calWrap=document.getElementById('calendarWrap');
  const wlWrap=document.getElementById('workloadWrap');
  const notesWrap=document.getElementById('notesWrap');
  const toolbar=document.querySelector('.toolbar');
  if(notesWrap)notesWrap.style.display=isNotes?'flex':'none';
  if(tasksGridWrap)tasksGridWrap.style.display=isNotes?'none':(currentViewMode==='board'||currentViewMode==='list'?'block':'none');
  if(calWrap)calWrap.style.display=isNotes?'none':(currentViewMode==='calendar'?'block':'none');
  if(wlWrap)wlWrap.style.display=isNotes?'none':(currentViewMode==='workload'?'block':'none');
  if(toolbar)toolbar.style.display=isNotes?'none':'';

  // Hide sidebar when in notes mode
  const sb=document.getElementById('mainSidebar');
  if(sb)sb.style.display=isNotes?'none':'';

  if(isNotes){
    renderNotesView();
    return;
  }

  filters={status:'',priority:'',assignee:'',dueFilter:''};
  const si=document.getElementById('searchInput');if(si)si.value='';
  document.getElementById('cfBtn').style.display='none';
  closeDetail();updateDashboardButtons();updateDashboardCounts();renderAll();
};

// Open notes panel (called from the My Notes shortcut button)
window.openNotesPanel=function(){
  switchDashboard('notes');
};
function updateDashboardCounts(){
  const pt=tasks.filter(t=>(t.source||'team')==='personal'&&t.createdBy===currentUser?.uid&&!t.archived);
  const tt=tasks.filter(t=>(t.source||'team')!=='personal'&&!t.archived);
  const mt=isAdmin()?tt:tt.filter(t=>!t.assigneeId||t.assigneeId===currentUser?.uid);
  const pc=document.getElementById('personalCount');const tc=document.getElementById('teamCount');const nc=document.getElementById('notesCount');
  if(pc)pc.textContent=pt.length;if(tc)tc.textContent=mt.length;if(nc)nc.textContent=notes.length;
}
const isAdmin=()=>currentUserProfile?.role==='admin';

// ── EMAIL ──
function getEmailConfig(){const s=localStorage.getItem('tf_email');return s?JSON.parse(s):null;}
window.openEmailConfig=function(){document.getElementById('emailModal').style.display='flex';};
window.closeEmailModal=function(){document.getElementById('emailModal').style.display='none';};
window.saveEmailConfig=function(){
  const cfg={pubkey:document.getElementById('ej_pubkey').value.trim(),service:document.getElementById('ej_service').value.trim(),template:document.getElementById('ej_template').value.trim()};
  if(!cfg.pubkey||!cfg.service||!cfg.template){alert('Fill all fields.');return;}
  localStorage.setItem('tf_email',JSON.stringify(cfg));emailjs.init(cfg.pubkey);toast('✅ Email config saved!');closeEmailModal();
};
async function sendTaskEmail(task,assigneeMember){
  const cfg=getEmailConfig();if(!cfg||!assigneeMember?.email)return;
  try{emailjs.init(cfg.pubkey);await emailjs.send(cfg.service,cfg.template,{to_email:assigneeMember.email,to_name:assigneeMember.name,task_title:task.title,task_priority:P[task.priority]?.label||task.priority,task_status:S[task.status]?.label||task.status,task_due:task.due||'No due date',assigned_by:currentUserProfile?.name||'Admin'});toast(`📧 Email sent to ${assigneeMember.name}!`);}
  catch(e){toast('⚠ Email failed: '+(e.text||e.message));}
}
async function log(tid,mid,detail){await push(ref(db,'activity'),{taskId:tid,memberId:mid,detail,ts:Date.now()});}

function renderAll(){updateDashboardCounts();renderSidebar();if(currentViewMode==='workload')renderWorkload();else if(currentViewMode==='calendar')renderCalendar();else renderTasks();renderActivity();renderTeam();if(currentView==='report')renderReport();}

// ── SIDEBAR ──
function renderSidebar(){
  let st;
  if(currentDashboard==='personal'){st=tasks.filter(t=>(t.source||'team')==='personal'&&t.createdBy===currentUser?.uid&&!t.archived);}
  else{const tt=tasks.filter(t=>(t.source||'team')!=='personal'&&!t.archived);st=isAdmin()?tt:tt.filter(t=>!t.assigneeId||t.assigneeId===currentUser?.uid);}
  const counts={};Object.keys(S).forEach(s=>counts[s]=0);st.forEach(t=>counts[t.status]=(counts[t.status]||0)+1);
  const pCounts={};Object.keys(P).forEach(p=>pCounts[p]=0);st.forEach(t=>pCounts[t.priority]=(pCounts[t.priority]||0)+1);
  const overdue=st.filter(t=>t.due&&new Date(t.due+'T00:00:00')<new Date()&&t.status!=='done').length;
  const lbl=currentDashboard==='personal'?'My Tasks':(isAdmin()?'Total':'My Tasks');
  let h=`<div class="stat-card" onclick="clearFilters()"><div class="stat-num">${st.filter(t=>t.status!=='done').length}</div><div class="stat-lbl">${lbl}</div></div>`;
  Object.entries(S).forEach(([k,v])=>h+=`<div class="stat-card" onclick="tf('status','${k}')"><div class="stat-num" style="color:${v.color}">${counts[k]||0}</div><div class="stat-lbl">${v.label}</div></div>`);
  if(overdue>0)h+=`<div class="stat-card" style="grid-column:span 2;border-color:var(--red-border);background:var(--red-bg)"><div class="stat-num" style="color:var(--red)">${overdue}</div><div class="stat-lbl">Overdue</div></div>`;
  document.getElementById('statsGrid').innerHTML=h;
  const ids={todo:'fc_todo',in_progress:'fc_ip',review:'fc_rev',done:'fc_done'};
  Object.entries(ids).forEach(([k,id])=>{const el=document.getElementById(id);if(el)el.textContent=counts[k]||0;});
  ['fb_todo','fb_ip','fb_rev','fb_done'].forEach((id,i)=>{const key=['todo','in_progress','review','done'][i];document.getElementById(id)?.classList.toggle('active',filters.status===key);});
  if(isAdmin()&&currentDashboard==='team'){
    document.getElementById('breakdownLabel').textContent='Priority';
    document.getElementById('priorityGrid').innerHTML=Object.entries(P).map(([k,v])=>`<div class="stat-card" onclick="tf('priority','${k}')"><div class="stat-num" style="color:${v.color}">${pCounts[k]||0}</div><div class="stat-lbl">${v.icon} ${v.label}</div></div>`).join('');
  } else {
    document.getElementById('breakdownLabel').textContent='Status';
    document.getElementById('priorityGrid').innerHTML=Object.entries(S).map(([k,v])=>`<div class="stat-card" onclick="tf('status','${k}')"><div class="stat-num" style="color:${v.color}">${counts[k]||0}</div><div class="stat-lbl">${v.label}</div></div>`).join('');
  }
  const tfs=document.getElementById('teamFilterSection');if(tfs)tfs.style.display=(isAdmin()&&currentDashboard==='team')?'':'none';
  if(isAdmin()&&currentDashboard==='team'){document.getElementById('teamFilters').innerHTML=members.map(m=>`<button class="filter-btn ${filters.assignee===m.id?'active':''}" onclick="tf('assignee','${m.id}')">${av(m,16)}<span>${esc(m.name)}</span></button>`).join('');}
}
window.tf=function(key,val){filters[key]=filters[key]===val?'':val;document.getElementById('cfBtn').style.display=hasActiveFilters()?'':'none';renderTasks();renderSidebar();};
window.clearFilters=function(){filters={status:'',priority:'',assignee:'',dueFilter:''};const si=document.getElementById('searchInput');if(si)si.value='';document.getElementById('cfBtn').style.display='none';['today','week','overdue'].forEach(k=>{document.getElementById('duf_'+k)?.classList.remove('active');});renderTasks();renderSidebar();};

function getFiltered(){
  const q=(document.getElementById('searchInput')?.value||'').toLowerCase();
  let st;
  if(currentDashboard==='personal'){st=tasks.filter(t=>(t.source||'team')==='personal'&&t.createdBy===currentUser?.uid&&!t.archived);}
  else{const tt=tasks.filter(t=>(t.source||'team')!=='personal'&&!t.archived);st=isAdmin()?tt:tt.filter(t=>!t.assigneeId||t.assigneeId===currentUser?.uid);}
  const now=new Date();
  st=st.filter(t=>{
    if(!filters.status && t.status==='done') return false; // hide done by default
    if(filters.status&&t.status!==filters.status)return false;
    if(filters.priority&&t.priority!==filters.priority)return false;
    if(filters.assignee&&t.assigneeId!==filters.assignee)return false;
    if(q&&!t.title.toLowerCase().includes(q)&&!(t.description||'').toLowerCase().includes(q)&&!(t.tags||[]).some(tag=>tag.toLowerCase().includes(q)))return false;
    if(filters.dueFilter){if(!t.due)return false;const due=new Date(t.due+'T00:00:00');if(filters.dueFilter==='today'){const d=new Date(now.getFullYear(),now.getMonth(),now.getDate());const d2=new Date(d);d2.setDate(d2.getDate()+1);if(!(due>=d&&due<d2))return false;}else if(filters.dueFilter==='week'){const d=new Date(now.getFullYear(),now.getMonth(),now.getDate());const d2=new Date(d);d2.setDate(d2.getDate()+7);if(!(due>=d&&due<d2))return false;}else if(filters.dueFilter==='overdue'){if(!(due<now&&t.status!=='done'))return false;}}
    return true;
  });
  const sort=document.getElementById('sortSelect')?.value||'priority';
  const po={critical:0,high:1,medium:2,low:3};
  if(sort==='priority')st.sort((a,b)=>(po[a.priority]||2)-(po[b.priority]||2)||b.ts-a.ts);
  else if(sort==='due')st.sort((a,b)=>{if(!a.due&&!b.due)return b.ts-a.ts;if(!a.due)return 1;if(!b.due)return-1;return a.due.localeCompare(b.due);});
  else if(sort==='created')st.sort((a,b)=>b.ts-a.ts);
  else if(sort==='title')st.sort((a,b)=>a.title.localeCompare(b.title));
  else if(sort==='time')st.sort((a,b)=>(b.timeLogged||0)-(a.timeLogged||0));
  return st;
}

// ── TASK CARD ──
function taskCardHtml(t,isPersonal=false,groupBy='priority'){
  const p=P[t.priority]||P.medium,s_=S[t.status]||S.todo,assignee=members.find(m=>m.id===t.assigneeId),due=fd(t.due);
  const cmtCount=t.comments&&typeof t.comments==='object'?Object.keys(t.comments).length:0;
  const assignedDate=t.assignedAt?fmtDate(t.assignedAt):t.assigneeId&&t.ts?fmtDate(t.ts):null;
  const isDone=t.status==='done';const tags=t.tags||[];const subtasks=t.subtasks||[];
  const doneSubtasks=subtasks.filter(s=>s.done).length;
  const progress=subtasks.length?Math.round((doneSubtasks/subtasks.length)*100):(isDone?100:0);
  const showProgress=subtasks.length>0||isDone;
  const canEdit=isAdmin()||(t.source==='personal'&&t.createdBy===currentUser?.uid);
  const isSelected=selectedTasks.has(t.id);
  const timer=timers[t.id];const isTimerRunning=timer?.start;
  const cardStyle=t.color?`border-left:4px solid ${t.color};`:'';
  return`<div class="task-card${isSelected?' selected':''}" id="tc_${t.id}" style="${cardStyle}" onclick="openDetail('${t.id}')"
    draggable="true" ondragstart="onDragStart(event,'${t.id}')" ondragend="onDragEnd(event,'${t.id}')">
    <button class="card-select-btn" title="Select task" onclick="toggleSelectTask(event,'${t.id}')"></button>
    <button class="card-menu-btn" onclick="openCardMenu(event,'${t.id}')">⋯</button>
    <div class="card-dropdown" id="cd_${t.id}">
      ${canEdit?`<button class="card-menu-item" onclick="event.stopPropagation();document.getElementById('cd_${t.id}').classList.remove('open');openTaskModal('${t.id}')">✏ Edit</button>`:''}
      <button class="card-menu-item" onclick="event.stopPropagation();document.getElementById('cd_${t.id}').classList.remove('open');toggleTaskDone(event,'${t.id}')">${isDone?'↩ Reopen':'✓ Complete'}</button>
      <button class="card-menu-item" onclick="event.stopPropagation();document.getElementById('cd_${t.id}').classList.remove('open');startTimer('${t.id}')">${isTimerRunning?'⏹ Stop Timer':'⏱ Start Timer'}</button>
      ${canEdit?`<button class="card-menu-item" onclick="event.stopPropagation();document.getElementById('cd_${t.id}').classList.remove('open');archiveTask('${t.id}')">📦 Archive</button>`:''}
      ${canEdit?`<button class="card-menu-item danger" onclick="event.stopPropagation();document.getElementById('cd_${t.id}').classList.remove('open');deleteTask('${t.id}')">🗑 Delete</button>`:''}
    </div>
    <div class="ct">
      <button class="checkbox-btn ${isDone?'checked':''}" title="${isDone?'Mark as To Do':'Mark as Done'}" onclick="toggleTaskDone(event,'${t.id}')"></button>
      ${groupBy==='status'?`<span class="badge" style="color:${p.color};background:${p.bg};border-color:${p.border}">${p.icon} ${p.label}</span>`:`<span class="badge" style="color:${s_.color};background:${s_.bg};border-color:${s_.border}">${s_.label}</span>`}
      ${t.recur?`<span class="badge" style="color:var(--accent);background:var(--accent-light);border-color:var(--accent-mid)">🔄 ${t.recur}</span>`:''}
    </div>
    <div class="card-title${isDone?' done-title':''}">${esc(t.title)}</div>
    ${t.description?`<div class="card-desc">${t.description.replace(/<[^>]+>/g,' ').trim()}</div>`:''}
    ${tags.length?`<div class="card-tags">${tags.map(tag=>{const tc=tagColor(tag);return`<span class="tag" style="background:${tc.bg};border-color:${tc.border};color:${tc.color}">${esc(tag)}</span>`;}).join('')}</div>`:''}
    ${showProgress?`<div class="card-progress"><div class="card-progress-label">${subtasks.length?`${doneSubtasks}/${subtasks.length} subtasks`:'Completed'}</div><div class="card-progress-bar"><div class="card-progress-fill" style="width:${progress}%"></div></div></div>`:''}
    <div class="cb">
      ${isPersonal?`<span style="font-size:.7rem;color:var(--accent);font-weight:700;background:var(--accent-light);padding:2px 8px;border-radius:99px;border:1px solid var(--accent-mid)">👤 Personal</span>`:(assignee?`<div style="display:flex;align-items:center;gap:6px;font-size:.74rem;color:var(--ink-mid);font-weight:500">${av(assignee,19)}<span>${esc(assignee.name)}</span></div>`:`<span style="font-size:.72rem;color:var(--ink-dim);font-style:italic">Unassigned</span>`)}
      <div class="card-meta-icons">
        ${isTimerRunning?`<span class="time-badge active">⏱ Running</span>`:t.timeLogged>0?`<span class="time-badge">⏱ ${fmtTime(t.timeLogged)}</span>`:''}
        ${t.link?`<span class="meta-icon" title="Has attachment/link" onclick="event.stopPropagation();openLink('${t.id}')">🔗</span>`:''}
        ${cmtCount>0?`<span class="meta-icon">💬 ${cmtCount}</span>`:''}
        ${due?`<span class="meta-icon" style="color:${due.cls==='overdue'?'var(--red)':due.cls==='warning'?'var(--amber)':'var(--ink-dim)'}">${due.text}</span>`:''}
      </div>
    </div>
    ${assignedDate&&!isPersonal?`<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);display:flex;align-items:center;gap:5px"><span style="font-size:.61rem;color:var(--ink-dim);font-family:'JetBrains Mono',monospace">Assigned ${assignedDate}</span></div>`:''}
  </div>`;
}

// ── LIST VIEW ROW ──
function taskListRowHtml(t,isPersonal=false){
  const p=P[t.priority]||P.medium,s_=S[t.status]||S.todo;
  const assignee=members.find(m=>m.id===t.assigneeId);const due=fd(t.due);const isDone=t.status==='done';
  return`<tr class="${isDone?'done-row':''}" onclick="openDetail('${t.id}')">
    <td onclick="event.stopPropagation()"><button class="checkbox-btn ${isDone?'checked':''}" onclick="toggleTaskDone(event,'${t.id}')"></button></td>
    <td><div class="lv-title">${esc(t.title)}</div>${t.description?`<div class="lv-desc">${t.description.replace(/<[^>]+>/g,' ').trim()}</div>`:''}</td>
    <td><span class="badge" style="color:${s_.color};background:${s_.bg};border-color:${s_.border}">${s_.label}</span></td>
    <td><span class="badge" style="color:${p.color};background:${p.bg};border-color:${p.border}">${p.icon} ${p.label}</span></td>
    <td>${isPersonal?`<span style="font-size:.75rem;color:var(--accent);font-weight:600">👤 Me</span>`:(assignee?`<div style="display:flex;align-items:center;gap:6px">${av(assignee,18)}<span style="font-size:.78rem;font-weight:500">${esc(assignee.name)}</span></div>`:'<span style="font-size:.72rem;color:var(--ink-dim)">—</span>')}</td>
    <td style="font-size:.7rem;font-family:'JetBrains Mono',monospace">${t.timeLogged?fmtTime(t.timeLogged):'—'}</td>
    <td style="font-size:.72rem;font-family:'JetBrains Mono',monospace;color:${due?.cls==='overdue'?'var(--red)':due?.cls==='warning'?'var(--amber)':'var(--ink-dim)'};white-space:nowrap">${due?due.text:'—'}</td>
  </tr>`;
}

// ── RENDER TASKS ──
function renderTasks(){
  if(currentView!=='tasks')return;if(currentViewMode==='calendar'){renderCalendar();return;}if(currentViewMode==='workload'){renderWorkload();return;}
  const f=getFiltered();
  document.getElementById('cfBtn').style.display=hasActiveFilters()?'':'none';
  document.getElementById('taskCount').textContent=`${f.length} task${f.length!==1?'s':''}`;
  const si=document.getElementById('searchInput');if(si)si.placeholder=currentDashboard==='personal'?'Search personal tasks…':'Search team tasks…';
  const grouped=document.getElementById('tasksGrouped');const empty=document.getElementById('emptyState');
  if(currentViewMode==='list'){
    if(f.length===0){grouped.innerHTML='';empty.style.display='flex';empty.innerHTML=getEmptyHtml();return;}
    empty.style.display='none';grouped.style.cssText='display:block;min-width:0;height:auto;width:100%';
    grouped.innerHTML=`<table class="list-view-table"><thead><tr><th></th><th>Task</th><th>Status</th><th>Priority</th><th>Assignee</th><th>Time</th><th>Due</th></tr></thead><tbody>${f.map(t=>taskListRowHtml(t,currentDashboard==='personal')).join('')}</tbody></table>`;return;
  }
  // Board
  grouped.style.cssText='display:flex;gap:14px;align-items:flex-start;min-width:max-content;height:100%';
  if(f.length===0){grouped.innerHTML='';empty.style.display='flex';empty.innerHTML=getEmptyHtml();return;}
  empty.style.display='none';
  const makeKanban=(cols,keyFn,infoFn,groupBy)=>cols.map(([key,label])=>{
    const items=f.filter(t=>keyFn(t)===key);const info=infoFn(key);
    const cardsHtml=items.length?items.map(t=>taskCardHtml(t,currentDashboard==='personal',groupBy)).join(''):`<div class="kanban-empty"><div class="kanban-empty-icon">${info.icon||'○'}</div><div class="kanban-empty-text">No ${label.toLowerCase()} tasks</div></div>`;
    return`<div class="kanban-col" id="pg_${key}">
      <div class="kanban-col-header"><span class="fdot" style="background:${info.color}"></span><span class="kanban-col-title" style="color:${info.color}">${label}</span><span class="kanban-col-count" style="background:${info.bg};color:${info.color};border:1px solid ${info.border}">${items.length}</span><button class="kanban-col-toggle" onclick="toggleGroup('${key}')">▾</button></div>
      <div class="kanban-cards" id="kc_${key}" ondragover="onDragOver(event,'${key}')" ondrop="onDrop(event,'${key}','${groupBy}')"><div id="pgt_${key}">${cardsHtml}</div></div>
    </div>`;
  }).join('');
  if(currentDashboard==='personal'||!isAdmin()){
    grouped.innerHTML=makeKanban([['todo','To Do'],['in_progress','In Progress'],['review','In Review'],['done','Done']],t=>t.status,k=>S[k],'status');
  } else {
    grouped.innerHTML=makeKanban([['critical','Critical'],['high','High'],['medium','Medium'],['low','Low']],t=>t.priority,k=>P[k],'priority');
  }
}
function getEmptyHtml(){
  if(currentDashboard==='personal')return`<div class="empty-icon">👤</div><div class="empty-title">No personal tasks yet</div><div class="empty-sub">Click "+ Personal Task" to get started.</div>`;
  return`<div class="empty-icon">🏢</div><div class="empty-title">No team tasks found</div><div class="empty-sub">${isAdmin()?'Click "+ New Task" to create one.':'No tasks assigned to you yet.'}</div>`;
}
window.toggleGroup=function(pk){const el=document.getElementById('pgt_'+pk);const btn=document.querySelector('#pg_'+pk+' .kanban-col-toggle');if(!el)return;const h=el.style.display==='none';el.style.display=h?'':'none';if(btn)btn.textContent=h?'▾':'▸';};

// ── DETAIL PANEL ──
window.openDetail=function(id){openDetailId=id;renderDetail();document.getElementById('detailPanel').style.display='flex';};
window.closeDetail=function(){openDetailId=null;document.getElementById('detailPanel').style.display='none';};

function renderDetail(){
  if(!openDetailId)return;const t=tasks.find(x=>x.id===openDetailId);if(!t){closeDetail();return;}
  const p=P[t.priority]||P.medium,s_=S[t.status]||S.todo,due=fd(t.due);
  const comments=t.comments&&typeof t.comments==='object'?Object.entries(t.comments).map(([k,v])=>({id:k,...v})).sort((a,b)=>a.ts-b.ts):[];
  const acts=activity.filter(a=>a.taskId===t.id).slice(0,12);
  const canEdit=isAdmin()||(t.source==='personal'&&t.createdBy===currentUser?.uid);
  const mOpts=members.map(m=>`<option value="${m.id}" ${t.assigneeId===m.id?'selected':''}>${esc(m.name)}</option>`).join('');
  const sOpts=Object.entries(S).map(([k,v])=>`<option value="${k}" ${t.status===k?'selected':''}>${v.label}</option>`).join('');
  const pOpts=Object.entries(P).map(([k,v])=>`<option value="${k}" ${t.priority===k?'selected':''}>${v.icon} ${v.label}</option>`).join('');
  const tags=t.tags||[];const subtasks=t.subtasks||[];
  const doneSubtasks=subtasks.filter(s=>s.done).length;
  const progress=subtasks.length?Math.round((doneSubtasks/subtasks.length)*100):(t.status==='done'?100:0);
  const timer=timers[t.id];const isTimerRunning=timer?.start;
  const totalTime=(timer?.logged||t.timeLogged||0)+(isTimerRunning?Date.now()-timer.start:0);
  document.getElementById('detailPanel').innerHTML=`
    <div class="dh">
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        ${canEdit?`<button class="btn btn-ghost btn-sm" onclick="openTaskModal('${t.id}')">✏ Edit</button><button class="btn btn-danger btn-sm" onclick="deleteTask('${t.id}')">🗑</button>`:''}
        <button class="btn btn-ghost btn-sm" onclick="toggleTaskDone(event,'${t.id}')">${t.status==='done'?'↩ Reopen':'✓ Done'}</button>
        ${canEdit?`<button class="btn btn-ghost btn-sm" onclick="archiveTask('${t.id}')">📦</button>`:''}
      </div>
      <button class="icon-btn" onclick="closeDetail()">✕</button>
    </div>
    <div class="db">
      <div class="detail-title">${esc(t.title)}</div>
      ${t.source==='personal'?`<div style="display:inline-flex;align-items:center;gap:5px;background:var(--accent-light);border:1px solid var(--accent-mid);border-radius:99px;padding:3px 10px;font-size:.71rem;font-weight:700;color:var(--accent);margin-bottom:10px">👤 Personal Task</div>`:`<div style="display:inline-flex;align-items:center;gap:5px;background:var(--purple-bg);border:1px solid var(--purple-border);border-radius:99px;padding:3px 10px;font-size:.71rem;font-weight:700;color:var(--purple);margin-bottom:10px">🏢 Team Task</div>`}
      ${tags.length?`<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px">${tags.map(tag=>{const tc=tagColor(tag);return`<span class="tag" style="background:${tc.bg};border-color:${tc.border};color:${tc.color}">${esc(tag)}</span>`;}).join('')}</div>`:''}
      ${(subtasks.length||t.status==='done')?`<div class="detail-progress"><div class="detail-progress-label"><span>${subtasks.length?`Subtasks ${doneSubtasks}/${subtasks.length}`:'Progress'}</span><span style="font-weight:700;color:${progress===100?'var(--green)':'var(--ink)'}">${progress}%</span></div><div class="detail-progress-bar"><div class="detail-progress-fill" style="width:${progress}%"></div></div></div>`:''}
      <div class="meta-grid">
        <div class="mi"><div class="ml">Status</div>${canEdit||t.assigneeId===currentUser?.uid?`<select class="ms" onchange="qu('${t.id}','status',this.value)">${sOpts}</select>`:`<span style="font-size:.83rem;font-weight:700;color:${s_.color}">${s_.label}</span>`}</div>
        <div class="mi"><div class="ml">Priority</div>${canEdit?`<select class="ms" onchange="qu('${t.id}','priority',this.value)">${pOpts}</select>`:`<span style="font-size:.83rem;font-weight:700;color:${p.color}">${p.icon} ${p.label}</span>`}</div>
        <div class="mi"><div class="ml">Assigned To</div>${(isAdmin()&&t.source!=='personal')?`<select class="ms" onchange="qu('${t.id}','assigneeId',this.value)"><option value="" ${!t.assigneeId?'selected':''}>— Unassigned —</option>${mOpts}</select>`:`<span style="font-size:.83rem;font-weight:700">${t.source==='personal'?'👤 Me':members.find(m=>m.id===t.assigneeId)?.name||'Unassigned'}</span>`}</div>
        <div class="mi"><div class="ml">Due Date</div><div style="font-size:.83rem;font-weight:700;color:${due?.cls==='overdue'?'var(--red)':due?.cls==='warning'?'var(--amber)':'var(--ink)'}">${due?due.text:'—'}</div></div>
        <div class="mi"><div class="ml">Assigned On</div><div style="font-size:.83rem;font-weight:700">${t.assignedAt?new Date(t.assignedAt).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):'—'}</div></div>
        ${t.recur?`<div class="mi"><div class="ml">Recurring</div><div style="font-size:.83rem;font-weight:700">🔄 ${t.recur}</div></div>`:''}
      </div>
      ${t.description?`<div class="detail-desc">${t.description}</div>`:''}
      ${t.link?`<div style="margin-bottom:14px"><button onclick="openLink('${t.id}')" style="display:inline-flex;align-items:center;gap:7px;background:var(--blue-bg);border:1.5px solid var(--blue-border);border-radius:var(--radius-sm);padding:8px 14px;font-size:.82rem;font-weight:700;color:var(--accent);cursor:pointer;transition:all .15s;font-family:inherit" onmouseover="this.style.background='var(--accent-light)'" onmouseout="this.style.background='var(--blue-bg)'">🔗 Open Attachment / Ticket <span style="font-size:.75rem;opacity:.7">↗</span></button></div>`:''}
      <div class="time-tracker">
        <div>
          <div class="ml">Time Tracked</div>
          <div class="timer-display${isTimerRunning?' running':''}" id="timerDisplay_${t.id}">${fmtTime(totalTime)}</div>
          ${t.estimatedTime?`<div style="font-size:.7rem;color:var(--ink-dim);margin-top:3px">Est: <strong>${t.estimatedTime}h</strong> · Actual: <strong>${fmtTime(totalTime)}</strong> · <strong style="color:${totalTime>t.estimatedTime*3600000?'var(--red)':'var(--green)'}">${totalTime>t.estimatedTime*3600000?'Over by '+fmtTime(totalTime-t.estimatedTime*3600000):'Under by '+fmtTime(t.estimatedTime*3600000-totalTime)}</strong></div>`:''}
        </div>
        <button class="btn ${isTimerRunning?'btn-danger':'btn-ghost'} btn-sm" onclick="startTimer('${t.id}')" style="margin-left:auto">${isTimerRunning?'⏹ Stop':'⏱ Start'}</button>
      </div>
      ${subtasks.length?`<div class="stitle">Subtasks</div><div class="subtask-list" style="margin-bottom:16px">${subtasks.map(st=>`<div class="subtask-item"><input type="checkbox" ${st.done?'checked':''} onchange="toggleDetailSubtask('${t.id}','${st.id}',this.checked)"><span class="subtask-text${st.done?' done':''}">${esc(st.text)}</span></div>`).join('')}</div>`:''}
      <div class="stitle">Watchers</div>
      <div class="watchers-row" style="margin-bottom:14px">
        ${(t.watchers||[]).map(wid=>{const m=members.find(x=>x.id===wid);return m?av(m,26):'';}).join('')}
        <button class="btn btn-ghost btn-xs" onclick="toggleWatch('${t.id}')">${(t.watchers||[]).includes(currentUser?.uid)?'👁 Watching':'+ Watch'}</button>
      </div>
      <div class="stitle">Comments (${comments.length})</div>
      <div class="comments-list">
        ${comments.length===0?'<p style="font-size:.78rem;color:var(--ink-dim);font-style:italic">No comments yet.</p>':''}
        ${comments.map(c=>{const a=members.find(m=>m.id===c.authorId);const canDel=c.authorId===currentUser?.uid||isAdmin();const reactions=c.reactions||{};return`<div class="cmt">${av(a||{name:'?',color:'#64748b'},26)}<div class="cmtb"><div class="cmth"><span class="ca">${esc(a?.name||'Unknown')}</span>${c.body.includes('@')?`<span class="badge" style="background:var(--accent-light);color:var(--accent);border-color:var(--accent-mid)">mention</span>`:''}  <span class="ct2">${ta(c.ts)}</span>${canDel?`<button class="cdel" onclick="delComment('${t.id}','${c.id}')">Delete</button>`:''}</div><p class="cmtt">${esc(c.body)}</p><div class="cmt-reactions">${EMOJIS.map(em=>{const count=(reactions[btoa(em)]||[]).length;const hasReacted=(reactions[btoa(em)]||[]).includes(currentUser?.uid);return`<button class="reaction-btn${hasReacted?' active':''}" onclick="reactComment('${t.id}','${c.id}','${btoa(em)}')">${em}${count>0?` ${count}`:''}</button>`;}).join('')}</div></div></div>`;}).join('')}
      </div>
      <div class="cform">
        ${av(currentUserProfile||{name:'?',color:'#64748b'},26)}
        <div class="cwrap">
          <textarea class="input" id="ci" placeholder="Add a comment… use @name to mention (Ctrl+Enter)" rows="2" onkeydown="if((event.ctrlKey||event.metaKey)&&event.key==='Enter')postComment('${t.id}')" style="min-height:52px;resize:vertical"></textarea>
          <div style="display:flex;justify-content:flex-end"><button class="btn btn-primary btn-sm" onclick="postComment('${t.id}')">Post</button></div>
        </div>
      </div>
      <div class="stitle" style="margin-top:14px">Activity</div>
      <div class="alist">${acts.map(a=>{const m=members.find(x=>x.id===a.memberId);return`<div class="ait"><div class="adot"></div><span class="atxt"><strong>${esc(m?.name||'Someone')}</strong> ${esc(a.detail)}</span><span class="atime">${ta(a.ts)}</span></div>`;}).join('')}</div>
    </div>`;
  if(isTimerRunning)startTimerTick(t.id);
}

window.toggleDetailSubtask=async function(tid,stId,checked){
  const t=tasks.find(x=>x.id===tid);if(!t)return;
  const subtasks=(t.subtasks||[]).map(s=>s.id===stId?{...s,done:checked}:s);
  await update(ref(db,`tasks/${tid}`),{subtasks});
  await log(tid,currentUser.uid,`Subtask ${checked?'completed':'reopened'}`);
};

// ── WATCHERS ──
window.toggleWatch=async function(tid){
  const t=tasks.find(x=>x.id===tid);if(!t)return;
  const watchers=t.watchers||[];const uid=currentUser.uid;
  const next=watchers.includes(uid)?watchers.filter(x=>x!==uid):[...watchers,uid];
  await update(ref(db,`tasks/${tid}`),{watchers:next});
  toast(next.includes(uid)?'👁 Now watching this task':'Stopped watching');
};

// ── REACTIONS ──
window.reactComment=async function(tid,cid,emojiB64){
  const t=tasks.find(x=>x.id===tid);if(!t)return;
  const cmt=t.comments[cid];if(!cmt)return;
  const reactions=cmt.reactions||{};const users=reactions[emojiB64]||[];const uid=currentUser.uid;
  const next=users.includes(uid)?users.filter(x=>x!==uid):[...users,uid];
  const upd={};upd[`comments/${cid}/reactions/${emojiB64}`]=next.length?next:null;
  await update(ref(db,`tasks/${tid}`),upd);
};

// ── CRUD ──
window.qu=async function(tid,field,val){
  const t=tasks.find(x=>x.id===tid);if(!t)return;
  const upd={};upd[field]=val||null;
  if(field==='assigneeId')upd.assignedAt=val?Date.now():null;
  if(field==='status')upd.finishedAt=val==='done'?Date.now():null;
  await update(ref(db,`tasks/${tid}`),upd);
  let detail='';
  if(field==='status')detail=`Status → ${S[val]?.label||val}`;
  else if(field==='priority')detail=`Priority → ${P[val]?.label||val}`;
  else if(field==='assigneeId'){const m=members.find(x=>x.id===val);detail=m?`Assigned to ${m.name}`:'Unassigned';}
  if(detail)await log(tid,currentUser.uid,detail);
};
window.postComment=async function(tid){
  const inp=document.getElementById('ci');const body=inp?.value?.trim();if(!body)return;
  // detect @mentions and send notifs
  const mentions=body.match(/@(\w+)/g)||[];
  await push(ref(db,`tasks/${tid}/comments`),{authorId:currentUser.uid,body,ts:Date.now(),reactions:{}});
  await log(tid,currentUser.uid,`Commented: "${body.slice(0,60)}"`);
  // notify watchers
  const t=tasks.find(x=>x.id===tid);
  if(t&&t.watchers){t.watchers.filter(w=>w!==currentUser.uid).forEach(w=>{const m=members.find(x=>x.id===w);if(m)toast(`🔔 ${m.name} was notified`);});}
};
window.delComment=async function(tid,cid){await remove(ref(db,`tasks/${tid}/comments/${cid}`));};
window.deleteTask=async function(tid){
  if(!confirm('Delete this task?'))return;
  const t=tasks.find(x=>x.id===tid);const snap={...t};
  await remove(ref(db,`tasks/${tid}`));closeDetail();
  toast('🗑 Task deleted',5000,async()=>{const newId=uid();await set(ref(db,`tasks/${newId}`),{...snap,id:undefined});toast('↩ Task restored');});
};
window.archiveTask=async function(tid){
  await update(ref(db,`tasks/${tid}`),{archived:true});closeDetail();
  toast('📦 Task archived',5000,async()=>{await update(ref(db,`tasks/${tid}`),{archived:false});toast('↩ Task unarchived');});
};

// ── TASK MODAL ──
window.openTaskModal=function(tid,forceSource){
  const source=forceSource||(currentDashboard==='personal'?'personal':'team');
  if(source==='team'&&!isAdmin()){toast('Only admins can create/edit team tasks.');return;}
  const t=tid?tasks.find(x=>x.id===tid):null;const isP=(t?.source||source)==='personal';
  document.getElementById('tmTitle').textContent=isP?(t?'Edit Personal Task':'New Personal Task'):(t?'Edit Task':'New Task');
  document.getElementById('editId').value=tid||'';document.getElementById('taskSource').value=t?.source||source;
  document.getElementById('tTitle').value=t?.title||'';
  document.getElementById('tDesc').innerHTML=t?.description||'';
  document.getElementById('tStatus').value=t?.status||'todo';document.getElementById('tPriority').value=t?.priority||'medium';document.getElementById('tDue').value=t?.due||'';
  pendingTags=[...(t?.tags||[])];renderPendingTags();document.getElementById('tagInput').value='';
  pendingSubtasks=(t?.subtasks||[]).map(s=>({...s}));renderPendingSubtasks();document.getElementById('subtaskInput').value='';
  pendingColor=t?.color||'';initColorPicker();
  pendingRecur=t?.recur||'';document.querySelectorAll('.recur-btn').forEach(b=>{b.classList.toggle('active',b.dataset.v===pendingRecur);});
  const estEl=document.getElementById('tEstimate');if(estEl)estEl.value=t?.estimatedTime||'';
  const linkEl=document.getElementById('tLink');if(linkEl)linkEl.value=t?.link||'';
  const ar=document.getElementById('assigneeRow');const pn=document.getElementById('personalAssigneeNote');const en=document.getElementById('emailNote')?.parentElement;
  if(isP){if(ar)ar.style.display='none';if(pn)pn.style.display='block';if(en)en.style.display='none';}
  else{if(ar)ar.style.display='grid';if(pn)pn.style.display='none';if(en)en.style.display='';
    document.getElementById('tAssignee').innerHTML=`<option value="">— Unassigned —</option>`+members.map(m=>`<option value="${m.id}" ${t?.assigneeId===m.id?'selected':''}>${esc(m.name)}</option>`).join('');
    const cfg=getEmailConfig();const note=document.getElementById('emailNote');
    if(note){if(cfg){note.className='info-box';note.textContent='✅ EmailJS configured!';}else{note.className='warn-box';note.innerHTML='⚠ EmailJS not configured. <a href="#" onclick="closeTaskModal();openEmailConfig();return false" style="color:var(--accent);font-weight:600">Set up</a>';}}
  }
  document.getElementById('taskModal').style.display='flex';setTimeout(()=>document.getElementById('tTitle').focus(),50);
};
window.closeTaskModal=function(){document.getElementById('taskModal').style.display='none';};
window.saveTask=async function(){
  const title=document.getElementById('tTitle').value.trim();if(!title)return alert('Please enter a title!');
  const eid=document.getElementById('editId').value;const source=document.getElementById('taskSource').value||'team';const isP=source==='personal';
  const assigneeId=isP?currentUser.uid:(document.getElementById('tAssignee').value||null);
  const prevTask=eid?tasks.find(x=>x.id===eid):null;const prevAssignee=prevTask?.assigneeId||null;
  const assignedAt=!assigneeId?null:assigneeId!==prevAssignee?Date.now():(prevTask?.assignedAt||Date.now());
  const desc=document.getElementById('tDesc').innerHTML;
  const estimatedTime=parseFloat(document.getElementById('tEstimate')?.value)||0;
  const taskLink=(document.getElementById('tLink')?.value||'').trim()||null;
  const data={title,description:desc,status:document.getElementById('tStatus').value,priority:document.getElementById('tPriority').value,assigneeId,due:document.getElementById('tDue').value||null,assignedAt,source,tags:pendingTags,subtasks:pendingSubtasks,color:pendingColor,recur:pendingRecur||null,estimatedTime:estimatedTime||null,link:taskLink};
  if(eid){await update(ref(db,`tasks/${eid}`),data);await log(eid,currentUser.uid,'Task updated');if(!isP&&assigneeId&&assigneeId!==prevAssignee){const assignee=members.find(m=>m.id===assigneeId);await sendTaskEmail({...data,id:eid},assignee);}}
  else{const newId=uid();await set(ref(db,`tasks/${newId}`),{...data,createdBy:currentUser.uid,ts:Date.now(),comments:{}});await log(newId,currentUser.uid,isP?'Personal task created':`Task created`);if(!isP&&assigneeId){const assignee=members.find(m=>m.id===assigneeId);await sendTaskEmail({...data,id:newId},assignee);}}
  closeTaskModal();toast(isP?'✅ Personal task saved!':'✅ Task saved!');
};

// ── TEMPLATES ──
window.openTemplates=function(){
  const list=document.getElementById('templateList');
  list.innerHTML=`<p style="font-size:.83rem;color:var(--ink-mid);margin-bottom:16px">Choose a template to pre-fill a new task:</p>`+
  TEMPLATES.map((tpl,i)=>`<div style="background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .15s" onclick="applyTemplate(${i})" onmouseover="this.style.borderColor='var(--accent-mid)'" onmouseout="this.style.borderColor='var(--border)'">
    <span style="font-size:1.8rem">${tpl.icon}</span>
    <div><div style="font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:.9rem;letter-spacing:-.02em">${esc(tpl.name)}</div><div style="font-size:.75rem;color:var(--ink-mid);margin-top:2px">${esc(tpl.description.slice(0,80))}…</div><div style="display:flex;gap:4px;margin-top:6px">${tpl.tags.map(tag=>{const tc=tagColor(tag);return`<span class="tag" style="background:${tc.bg};border-color:${tc.border};color:${tc.color}">${esc(tag)}</span>`;}).join('')}</div></div>
    <button class="btn btn-primary btn-sm" style="margin-left:auto;white-space:nowrap">Use →</button>
  </div>`).join('');
  document.getElementById('templateModal').style.display='flex';
};
window.closeTemplates=function(){document.getElementById('templateModal').style.display='none';};
window.applyTemplate=function(i){
  closeTemplates();const tpl=TEMPLATES[i];const source=currentDashboard==='personal'?'personal':'team';
  if(source==='team'&&!isAdmin()){toast('Only admins can create team tasks.');return;}
  openTaskModal(null,source);
  setTimeout(()=>{
    document.getElementById('tTitle').value=tpl.name;
    document.getElementById('tDesc').innerHTML=tpl.description;
    document.getElementById('tPriority').value=tpl.priority;
    document.getElementById('tStatus').value=tpl.status;
    pendingTags=[...tpl.tags];renderPendingTags();
    pendingSubtasks=tpl.subtasks.map(s=>({...s,id:uid()}));renderPendingSubtasks();
  },100);
};

// ── ARCHIVE ──
window.openArchiveView=function(){
  const archived=tasks.filter(t=>t.archived);
  const list=document.getElementById('archiveList');
  if(!archived.length){list.innerHTML='<div class="empty"><div class="ei">📦</div><div class="empty-title">Archive is empty</div></div>';document.getElementById('archiveModal').style.display='flex';return;}
  list.innerHTML=archived.map(t=>{const p=P[t.priority]||P.medium;return`<div style="background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius);padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:12px">
    <div style="flex:1"><div style="font-weight:600;font-size:.87rem">${esc(t.title)}</div><div style="font-size:.72rem;color:var(--ink-dim);margin-top:2px">${p.icon} ${p.label} · Archived</div></div>
    <button class="btn btn-ghost btn-sm" onclick="unarchiveTask('${t.id}')">↩ Restore</button>
    <button class="btn btn-danger btn-sm" onclick="deleteTask('${t.id}')">🗑</button>
  </div>`;}).join('');
  document.getElementById('archiveModal').style.display='flex';
};
window.closeArchive=function(){document.getElementById('archiveModal').style.display='none';};
window.unarchiveTask=async function(tid){await update(ref(db,`tasks/${tid}`),{archived:false});toast('↩ Task restored');closeArchive();openArchiveView();};

// ── COMMAND PALETTE ──
const CMD_ACTIONS=[
  {icon:'＋',title:'New Task',sub:'Create a new team task',fn:()=>openTaskModal(),kbd:'N'},
  {icon:'👤',title:'New Personal Task',sub:'Create a personal task',fn:()=>openTaskModal(null,'personal')},
  {icon:'🌙',title:'Toggle Dark Mode',sub:'Switch light/dark theme',fn:()=>toggleTheme(),kbd:'D'},
  {icon:'⊞',title:'Board View',sub:'Switch to Kanban board',fn:()=>setViewMode('board'),kbd:'1'},
  {icon:'☰',title:'List View',sub:'Switch to list view',fn:()=>setViewMode('list'),kbd:'2'},
  {icon:'📅',title:'Calendar View',sub:'Switch to calendar',fn:()=>setViewMode('calendar'),kbd:'3'},
  {icon:'📊',title:'Workload View',sub:'See team workload',fn:()=>setViewMode('workload')},
  {icon:'📋',title:'Task Templates',sub:'Use a task template',fn:()=>openTemplates()},
  {icon:'📦',title:'Archive',sub:'View archived tasks',fn:()=>openArchiveView()},
  {icon:'📄',title:'Export PDF',sub:'Export report as PDF',fn:()=>{switchView('report');setTimeout(exportReportPDF,300);}},
  {icon:'↓',title:'Export CSV',sub:'Export report as CSV',fn:()=>{switchView('report');setTimeout(exportReportCSV,300);}},
  {icon:'🎓',title:'Start Tour',sub:'Onboarding walkthrough',fn:()=>startTour()},
  {icon:'?',title:'Keyboard Shortcuts',sub:'View all shortcuts',fn:()=>showShortcuts()},
  {icon:'⌂',title:'Tasks',sub:'Go to Tasks view',fn:()=>switchView('tasks')},
  {icon:'📊',title:'Report',sub:'Go to Analytics',fn:()=>switchView('report')},
  {icon:'🚪',title:'Sign Out',sub:'Log out of your account',fn:()=>doLogout()},
];
let cmdFocus=0;
window.openCmdPalette=function(){
  document.getElementById('cmdPalette').style.display='block';
  setTimeout(()=>{document.getElementById('cmdInput').focus();},50);
  renderCmdResults('');
};
window.closeCmdPalette=function(){document.getElementById('cmdPalette').style.display='none';document.getElementById('cmdInput').value='';};
window.renderCmdResults=function(q){
  const lower=q.toLowerCase();
  const actions=q?CMD_ACTIONS.filter(a=>a.title.toLowerCase().includes(lower)||a.sub.toLowerCase().includes(lower)):CMD_ACTIONS;
  const taskResults=q?tasks.filter(t=>!t.archived&&t.title.toLowerCase().includes(lower)).slice(0,5):[];
  let html='';
  if(taskResults.length){html+=`<div class="cmd-group-label">Tasks</div>`;html+=taskResults.map((t,i)=>{const p=P[t.priority]||P.medium;return`<button class="cmd-item" onclick="closeCmdPalette();openDetail('${t.id}')"><span class="cmd-item-icon">${p.icon}</span><div><div class="cmd-item-title">${esc(t.title)}</div><div class="cmd-item-sub">${p.label} · ${S[t.status]?.label}</div></div></button>`;}).join('');}
  html+=`<div class="cmd-group-label">${q?'Commands':'Quick Actions'}</div>`;
  html+=actions.map((a,i)=>`<button class="cmd-item${i===0&&!q?' focused':''}" onclick="closeCmdPalette();(${a.fn.toString()})()"><span class="cmd-item-icon">${a.icon}</span><div><div class="cmd-item-title">${a.title}</div><div class="cmd-item-sub">${a.sub}</div></div>${a.kbd?`<span class="cmd-item-kbd">${a.kbd}</span>`:''}</button>`).join('');
  if(!actions.length&&!taskResults.length)html='<div style="padding:20px;text-align:center;color:var(--ink-dim);font-size:.83rem">No results</div>';
  document.getElementById('cmdResults').innerHTML=html;cmdFocus=0;
};
window.cmdKey=function(e){
  const items=document.querySelectorAll('#cmdResults .cmd-item');
  if(e.key==='ArrowDown'){cmdFocus=Math.min(cmdFocus+1,items.length-1);}
  else if(e.key==='ArrowUp'){cmdFocus=Math.max(cmdFocus-1,0);}
  else if(e.key==='Enter'){items[cmdFocus]?.click();return;}
  else if(e.key==='Escape'){closeCmdPalette();return;}
  items.forEach((el,i)=>el.classList.toggle('focused',i===cmdFocus));
};

// ── SHORTCUTS ──
window.showShortcuts=function(){document.getElementById('shortcutsModal').style.display='flex';};
window.closeShortcuts=function(){document.getElementById('shortcutsModal').style.display='none';};

// ── ONBOARDING TOUR ──
const TOUR_STEPS=[
  {target:'.logo',title:'Welcome to Ginesysone Finance Task Board! 👋',desc:'Your all-in-one task management platform for finance teams. Let\'s take a quick tour of the key features.',pos:'bottom'},
  {target:'#mainSidebar',title:'Sidebar Overview',desc:'Quick stats, status filters, and due date shortcuts. Click any stat card to filter tasks instantly.',pos:'right'},
  {target:'.view-toggle',title:'Multiple Views',desc:'Switch between Board (Kanban), List, Calendar, and Workload views to see your tasks the way you like.',pos:'bottom'},
  {target:'#newTaskBtn,#newPersonalTaskBtn',title:'Create Tasks',desc:'Click here to create a new task. You can add subtasks, tags, attach color labels, set recurring intervals, and more.',pos:'bottom'},
  {target:'#globalSearch',title:'Global Search',desc:'Search across all tasks instantly. Press ⌘K anywhere to open the command palette for quick actions.',pos:'bottom'},
  {target:'.theme-toggle',title:'Dark Mode',desc:'Toggle between light and dark mode. Your preference is saved automatically.',pos:'bottom'},
];
window.startTour=function(){
  tourStep=0;document.getElementById('tourOverlay').style.display='block';showTourStep(0);
};
window.endTour=function(){document.getElementById('tourOverlay').style.display='none';localStorage.setItem('tf_toured','1');};
window.nextTourStep=function(){tourStep++;if(tourStep>=TOUR_STEPS.length){endTour();toast('🎉 Tour complete! You\'re ready to go!');return;}showTourStep(tourStep);};
function showTourStep(i){
  const step=TOUR_STEPS[i];const total=TOUR_STEPS.length;
  const el=document.querySelector(step.target);
  const spotlight=document.getElementById('tourSpotlight');const tip=document.getElementById('tourTip');
  document.getElementById('tourNum').textContent=`${i+1} of ${total}`;
  document.getElementById('tourTitle').textContent=step.title;
  document.getElementById('tourDesc').textContent=step.desc;
  document.getElementById('tourNext').textContent=i===total-1?'Finish 🎉':'Next →';
  document.getElementById('tourDots').innerHTML=TOUR_STEPS.map((_,j)=>`<div class="tour-dot${j===i?' active':''}"></div>`).join('');
  if(el){const r=el.getBoundingClientRect();spotlight.style.cssText=`top:${r.top-8}px;left:${r.left-8}px;width:${r.width+16}px;height:${r.height+16}px`;tip.style.cssText=`top:${Math.min(r.bottom+20,window.innerHeight-200)}px;left:${Math.max(10,Math.min(r.left,window.innerWidth-320))}px`;}
  else{spotlight.style.cssText='top:-100px;left:-100px;width:0;height:0';tip.style.cssText='top:50%;left:50%;transform:translate(-50%,-50%)';}
}

// ── ACTIVITY ──
function renderActivity(){
  if(currentView!=='activity')return;
  const list=document.getElementById('feedList');const sa=isAdmin()?activity:activity.filter(a=>a.memberId===currentUser?.uid);
  const sub=document.getElementById('activitySubtitle');if(sub)sub.textContent=isAdmin()?'Everything happening across all tasks':'Your recent activity';
  if(!sa.length){list.innerHTML='<p style="color:var(--ink-dim);font-style:italic;font-size:.83rem">No activity yet.</p>';return;}
  list.innerHTML=sa.slice(0,60).map(a=>{const m=members.find(x=>x.id===a.memberId),t=tasks.find(x=>x.id===a.taskId);return`<div class="feed-item"><div style="flex-shrink:0;margin-top:3px">${av(m||{name:'?',color:'#64748b'},28)}</div><div class="fc"><span class="fact">${esc(m?.name||'Someone')}</span><span class="fac"> ${esc(a.detail)}</span>${t?` on <button class="ftl" onclick="switchView('tasks');openDetail('${t.id}')">${esc(t.title)}</button>`:''}</div><span class="ftime">${ta(a.ts)}</span></div>`;}).join('');
}

// ── TEAM ──
function renderTeam(){
  if(currentView!=='team')return;const grid=document.getElementById('teamGrid');
  if(!members.length){grid.innerHTML='<p style="color:var(--ink-dim);font-size:.83rem">No members yet.</p>';return;}
  grid.innerHTML=members.map(m=>{const open=tasks.filter(t=>t.assigneeId===m.id&&t.status!=='done'&&!t.archived).length;const total=tasks.filter(t=>t.assigneeId===m.id&&!t.archived).length;const time=tasks.filter(t=>t.assigneeId===m.id).reduce((a,t)=>a+(t.timeLogged||0),0);return`<div class="mc">${av(m,44)}<div style="flex:1"><div class="mn">${esc(m.name)}<span class="role-badge ${m.role==='admin'?'role-admin':'role-member'}">${m.role}</span></div><div class="me">${esc(m.email)}</div><div class="ms2">${open} open · ${total} total · ${fmtTime(time)} logged</div></div><button class="btn btn-ghost btn-sm" onclick="switchView('tasks');tf('assignee','${m.id}')">View</button></div>`;}).join('');
}

// ── REPORT ──
function clearReportFilters(){['reportMemberFilter','reportStatusFilter','reportPriorityFilter','reportDateFrom','reportDateTo'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});renderReport();}
window.clearReportFilters=clearReportFilters;

function renderReport(){
  if(currentView!=='report')return;
  const mf=document.getElementById('reportMemberFilter');const cm=mf.value;
  mf.innerHTML='<option value="">All Members</option>'+members.map(m=>`<option value="${m.id}" ${cm===m.id?'selected':''}>${esc(m.name)}</option>`).join('');
  const mF=mf.value,sF=document.getElementById('reportStatusFilter').value,pF=document.getElementById('reportPriorityFilter').value;
  const df=document.getElementById('reportDateFrom').value,dt=document.getElementById('reportDateTo').value;
  const fTs=df?new Date(df+'T00:00:00').getTime():null,tTs=dt?new Date(dt+'T23:59:59').getTime():null;
  let rows=tasks.filter(t=>t.assigneeId&&!t.archived);
  if(mF)rows=rows.filter(t=>t.assigneeId===mF);if(sF)rows=rows.filter(t=>t.status===sF);if(pF)rows=rows.filter(t=>t.priority===pF);
  if(fTs)rows=rows.filter(t=>{const ts=t.assignedAt||t.ts||0;return ts>=fTs;});if(tTs)rows=rows.filter(t=>{const ts=t.assignedAt||t.ts||0;return ts<=tTs;});
  rows.sort((a,b)=>{const ma=members.find(x=>x.id===a.assigneeId)?.name||'';const mb=members.find(x=>x.id===b.assigneeId)?.name||'';return ma.localeCompare(mb)||a.ts-b.ts;});
  const total=rows.length,done=rows.filter(t=>t.status==='done').length;
  const delayed=rows.filter(t=>{if(!t.due)return false;const due=new Date(t.due+'T23:59:59');const fin=t.finishedAt?new Date(t.finishedAt):new Date();return fin>due&&t.status!=='done';}).length;
  const inprog=rows.filter(t=>t.status==='in_progress'||t.status==='review').length;
  const totalTime=rows.reduce((a,t)=>a+(t.timeLogged||0),0);
  document.getElementById('reportSummary').innerHTML=`
    <div class="rs-card"><div class="rs-num">${total}</div><div class="rs-lbl">Total</div></div>
    <div class="rs-card"><div class="rs-num" style="color:var(--green)">${done}</div><div class="rs-lbl">Done</div></div>
    <div class="rs-card"><div class="rs-num" style="color:var(--blue)">${inprog}</div><div class="rs-lbl">In Progress</div></div>
    <div class="rs-card"><div class="rs-num" style="color:var(--red)">${delayed}</div><div class="rs-lbl">Delayed</div></div>
    <div class="rs-card"><div class="rs-num" style="color:var(--amber)">${total-done}</div><div class="rs-lbl">Pending</div></div>
    <div class="rs-card"><div class="rs-num" style="color:var(--purple)">${fmtTime(totalTime)}</div><div class="rs-lbl">Time Logged</div></div>`;
  renderCharts(rows);
  const tbody=document.getElementById('reportBody'),empty=document.getElementById('reportEmpty'),table=document.getElementById('reportTable');
  if(!rows.length){table.style.display='none';empty.style.display='flex';return;}
  table.style.display='table';empty.style.display='none';
  tbody.innerHTML=rows.map((t,i)=>{
    const m=members.find(x=>x.id===t.assigneeId);const p=P[t.priority]||P.medium;
    const ad=t.assignedAt?new Date(t.assignedAt).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):t.ts?new Date(t.ts).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):'—';
    const fd2=t.finishedAt?new Date(t.finishedAt).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):t.status==='done'?'Completed':'—';
    let delay='<span class="rt-delay-na">—</span>';
    if(t.due){const dueD=new Date(t.due+'T23:59:59');const cmpD=t.finishedAt?new Date(t.finishedAt):(t.status!=='done'?new Date():null);if(cmpD){const diff=Math.ceil((cmpD-dueD)/86400000);if(diff<=0)delay=`<span class="rt-delay-ok">✓ On time</span>`;else if(diff<=3)delay=`<span class="rt-delay-warn">+${diff}d</span>`;else delay=`<span class="rt-delay-bad">+${diff}d</span>`;}}
    return`<tr><td class="rt-sno">${i+1}</td><td><div class="rt-name">${av(m||{name:'?',color:'#64748b'},26)}<span>${esc(m?.name||'?')}</span></div></td><td class="rt-task">${esc(t.title)}</td><td><span class="badge" style="color:${p.color};background:${p.bg};border-color:${p.border}">${p.icon} ${p.label}</span></td><td class="rt-date">${ad}</td><td class="rt-date" style="color:${t.status==='done'?'var(--green)':'var(--ink-mid)'}">${fd2}</td><td class="rt-date">${t.timeLogged?fmtTime(t.timeLogged):'—'}</td><td>${delay}</td></tr>`;
  }).join('');
}
window.renderReport=renderReport;
window.renderCompliance=renderCompliance;

function renderCharts(rows){
  const cr=document.getElementById('chartsRow');
  cr.innerHTML=`<div class="chart-card"><div class="chart-title">Status Distribution</div><canvas id="statusChart" height="180"></canvas></div><div class="chart-card"><div class="chart-title">Priority Breakdown</div><canvas id="priorityChart" height="180"></canvas></div><div class="chart-card"><div class="chart-title">Completion by Member</div><canvas id="memberChart" height="180"></canvas></div>`;
  // destroy old
  Object.values(chartInstances).forEach(c=>{try{c.destroy();}catch(e){}});chartInstances={};
  const dark=document.documentElement.getAttribute('data-theme')==='dark';
  const textColor=dark?'#8a97b0':'#5a6478';
  const gridColor=dark?'#2e3852':'#e4e7ef';
  // Status chart
  const statusCounts=Object.keys(S).map(k=>rows.filter(t=>t.status===k).length);
  chartInstances.status=new Chart(document.getElementById('statusChart'),{type:'doughnut',data:{labels:Object.values(S).map(s=>s.label),datasets:[{data:statusCounts,backgroundColor:['#94a3b8','#2563eb','#7c3aed','#059669'],borderWidth:2,borderColor:dark?'#1e2433':'#fff'}]},options:{plugins:{legend:{position:'bottom',labels:{color:textColor,font:{size:11}}}},cutout:'65%'}});
  // Priority chart
  const priCounts=Object.keys(P).map(k=>rows.filter(t=>t.priority===k).length);
  chartInstances.priority=new Chart(document.getElementById('priorityChart'),{type:'bar',data:{labels:Object.values(P).map(p=>p.label),datasets:[{data:priCounts,backgroundColor:['#fca5a5','#fdba74','#fcd34d','#6ee7b7'],borderRadius:6}]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:textColor},grid:{color:gridColor}},y:{ticks:{color:textColor,stepSize:1},grid:{color:gridColor}}}}});
  // Member completion chart
  const memberData=members.map(m=>{const mRows=rows.filter(t=>t.assigneeId===m.id);const done=mRows.filter(t=>t.status==='done').length;return{name:m.name.split(' ')[0],total:mRows.length,done,color:m.color||'#2563eb'};}).filter(m=>m.total>0);
  chartInstances.member=new Chart(document.getElementById('memberChart'),{type:'bar',data:{labels:memberData.map(m=>m.name),datasets:[{label:'Done',data:memberData.map(m=>m.done),backgroundColor:memberData.map(m=>m.color+'cc'),borderRadius:6},{label:'Total',data:memberData.map(m=>m.total-m.done),backgroundColor:memberData.map(m=>m.color+'33'),borderRadius:6}]},options:{plugins:{legend:{position:'bottom',labels:{color:textColor,font:{size:11}}}},scales:{x:{stacked:true,ticks:{color:textColor},grid:{color:gridColor}},y:{stacked:true,ticks:{color:textColor,stepSize:1},grid:{color:gridColor}}}}});

  // ── BURNDOWN CHART ──
  const br=document.getElementById('burndownRow');
  br.innerHTML=`<div class="chart-card" style="flex:1.5"><div class="chart-title">📉 Burndown — Tasks Remaining Over Time</div><canvas id="burndownChart" height="160"></canvas></div><div class="chart-card" style="flex:1"><div class="chart-title">⏱ Estimate vs. Actual (hours)</div><canvas id="estimateChart" height="160"></canvas></div>`;
  // Burndown: last 14 days
  const days=14;const bdLabels=[];const bdRemaining=[];const now=new Date();
  for(let i=days-1;i>=0;i--){const d=new Date(now);d.setDate(d.getDate()-i);const ds=d.toISOString().slice(0,10);bdLabels.push(ds.slice(5));const remaining=rows.filter(t=>t.status!=='done'||(t.finishedAt&&new Date(t.finishedAt)>d)).length;bdRemaining.push(remaining);}
  if(chartInstances.burndown)try{chartInstances.burndown.destroy();}catch(e){}
  chartInstances.burndown=new Chart(document.getElementById('burndownChart'),{type:'line',data:{labels:bdLabels,datasets:[{label:'Remaining',data:bdRemaining,borderColor:'#2563eb',backgroundColor:'rgba(37,99,235,.1)',fill:true,tension:.35,pointRadius:3}]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:textColor,maxTicksLimit:7},grid:{color:gridColor}},y:{ticks:{color:textColor,stepSize:1},grid:{color:gridColor},beginAtZero:true}}}});
  // Estimate vs Actual
  const estData=members.map(m=>{const mRows=rows.filter(t=>t.assigneeId===m.id);const est=mRows.reduce((a,t)=>a+(t.estimatedTime||0),0);const actual=mRows.reduce((a,t)=>a+(t.timeLogged||0)/3600000,0);return{name:m.name.split(' ')[0],est:parseFloat(est.toFixed(1)),actual:parseFloat(actual.toFixed(1))};}).filter(m=>m.est>0||m.actual>0);
  if(chartInstances.estimate)try{chartInstances.estimate.destroy();}catch(e){}
  if(document.getElementById('estimateChart'))chartInstances.estimate=new Chart(document.getElementById('estimateChart'),{type:'bar',data:{labels:estData.map(m=>m.name),datasets:[{label:'Estimated (h)',data:estData.map(m=>m.est),backgroundColor:'rgba(124,58,237,.7)',borderRadius:5},{label:'Actual (h)',data:estData.map(m=>m.actual),backgroundColor:'rgba(5,150,105,.7)',borderRadius:5}]},options:{plugins:{legend:{position:'bottom',labels:{color:textColor,font:{size:11}}}},scales:{x:{ticks:{color:textColor},grid:{color:gridColor}},y:{ticks:{color:textColor},grid:{color:gridColor},beginAtZero:true}}}});

  // ── TIME REPORT ──
  const tr=document.getElementById('timeReportSection');
  const weekMs=7*24*60*60*1000;const weekAgo=Date.now()-weekMs;
  const memberTimeRows=members.map(m=>{
    const mTasks=rows.filter(t=>t.assigneeId===m.id);
    const totalLogged=mTasks.reduce((a,t)=>a+(t.timeLogged||0),0);
    const weekLogged=mTasks.filter(t=>t.updatedAt&&t.updatedAt>weekAgo).reduce((a,t)=>a+(t.timeLogged||0),0);
    const totalEst=mTasks.reduce((a,t)=>a+(t.estimatedTime||0)*3600000,0);
    return{m,totalLogged,weekLogged,totalEst,count:mTasks.length};
  }).filter(r=>r.totalLogged>0||r.count>0);
  if(memberTimeRows.length){
    tr.innerHTML=`<div style="font-weight:700;font-size:.88rem;margin-bottom:10px;color:var(--ink)">⏱ Time Tracking Report — by Member</div><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px">`+
    memberTimeRows.map(r=>{const pct=r.totalEst>0?Math.min(100,Math.round((r.totalLogged/r.totalEst)*100)):0;const over=r.totalEst>0&&r.totalLogged>r.totalEst;return`<div style="background:var(--bg);border:1.5px solid ${over?'var(--red-border)':'var(--border)'};border-radius:var(--radius);padding:12px 14px"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">${av(r.m,28)}<div><div style="font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:.84rem;letter-spacing:-.02em">${esc(r.m.name)}</div><div style="font-size:.68rem;color:var(--ink-dim)">${r.count} task${r.count!==1?'s':''}</div></div></div><div style="display:flex;justify-content:space-between;font-size:.75rem;margin-bottom:4px"><span style="color:var(--ink-mid)">Total logged</span><strong>${fmtTime(r.totalLogged)}</strong></div>${r.totalEst>0?`<div style="height:6px;background:var(--border);border-radius:99px;margin-bottom:6px"><div style="height:100%;width:${pct}%;background:${over?'var(--red)':'var(--green)'};border-radius:99px"></div></div><div style="font-size:.68rem;color:${over?'var(--red)':'var(--ink-dim)'};">${pct}% of ${r.totalEst/3600000}h est.</div>`:''}</div>`;}).join('')+`</div>`;
  } else {tr.innerHTML='';}
}

window.exportReportCSV=function(){
  let rows=tasks.filter(t=>t.assigneeId&&!t.archived);
  rows.sort((a,b)=>{const ma=members.find(x=>x.id===a.assigneeId)?.name||'';const mb=members.find(x=>x.id===b.assigneeId)?.name||'';return ma.localeCompare(mb);});
  const h=['#','Member','Task','Priority','Assigned','Finished','Time Logged','Delay'];
  const cr=rows.map((t,i)=>{const m=members.find(x=>x.id===t.assigneeId);const p=P[t.priority]||P.medium;const ad=t.assignedAt?new Date(t.assignedAt).toLocaleDateString('en-IN'):'';const fd2=t.finishedAt?new Date(t.finishedAt).toLocaleDateString('en-IN'):t.status==='done'?'Completed':'Pending';let delay='';if(t.due){const dueD=new Date(t.due+'T23:59:59');const cmpD=t.finishedAt?new Date(t.finishedAt):(t.status!=='done'?new Date():null);if(cmpD){const diff=Math.ceil((cmpD-dueD)/86400000);delay=diff<=0?'On time':'+'+diff+' days';}}return[i+1,m?.name||'?',t.title,p.label,ad,fd2,fmtTime(t.timeLogged||0),delay].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');});
  const csv=[h.join(','),...cr].join('\n');const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='taskflow-report.csv';a.click();URL.revokeObjectURL(url);toast('✅ CSV exported!');
};
window.exportReportPDF=function(){
  window.print();toast('🖨 Print dialog opened — save as PDF');
};

window.switchView=function(view){
  currentView=view;
  const vMap={tasks:'block',activity:'flex',team:'flex',goals:'flex',report:'flex',compliance:'flex'};
  ['tasks','activity','team','goals','report','compliance'].forEach(v=>{const el=document.getElementById(v+'View');if(el)el.style.display=v===view?vMap[v]:'none';});
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',['tasks','activity','team','goals','report','compliance'][i]===view));
  // Hide sidebar for compliance (full-width), show for all other views
  const sb=document.getElementById('mainSidebar');
  if(sb) sb.style.display=view==='compliance'?'none':'';
  // Notes shortcut visible on Tasks view for all users when on personal dashboard
  const notesShortcut=document.getElementById('notesShortcutWrap');
  if(notesShortcut)notesShortcut.style.display=(view==='tasks'&&currentDashboard==='personal')?'':'none';
  if(view==='activity')renderActivity();if(view==='team')renderTeam();if(view==='tasks'){if(currentDashboard==='notes')switchDashboard('personal');else renderTasks();}if(view==='report')renderReport();if(view==='goals')renderGoals();if(view==='compliance')renderCompliance();
};

// ══════════════════════════════════════════════
// ── IN-APP NOTIFICATION CENTER ──
// ══════════════════════════════════════════════
let notifications=JSON.parse(localStorage.getItem('tf_notifications')||'[]');
function saveNotifications(){localStorage.setItem('tf_notifications',JSON.stringify(notifications.slice(0,100)));}
function addNotification(title,body,taskId){
  const n={id:uid(),title,body,taskId,ts:Date.now(),read:false};
  notifications.unshift(n);saveNotifications();renderNotifBadge();renderNotifList();
  sendBrowserNotification(title,body);
}
function renderNotifBadge(){
  const unread=notifications.filter(n=>!n.read).length;
  const badge=document.getElementById('notifBadgeInner');
  if(badge){badge.textContent=unread>9?'9+':unread;badge.style.display=unread>0?'flex':'none';}
}
function renderNotifList(){
  const list=document.getElementById('notifList');if(!list)return;
  if(!notifications.length){list.innerHTML='<div style="padding:20px;text-align:center;font-size:.8rem;color:var(--ink-dim)">No notifications yet</div>';return;}
  list.innerHTML=notifications.slice(0,30).map(n=>`<div onclick="notifClick('${n.id}'${n.taskId?`,'${n.taskId}'`:''})" style="display:flex;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border);cursor:pointer;background:${n.read?'transparent':'var(--accent-light)'};transition:background .15s" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='${n.read?'transparent':'var(--accent-light)'}'">
    <div style="width:8px;height:8px;border-radius:50%;background:${n.read?'transparent':'var(--accent)'};flex-shrink:0;margin-top:5px"></div>
    <div style="flex:1"><div style="font-size:.8rem;font-weight:${n.read?'500':'700'};color:var(--ink)">${esc(n.title)}</div><div style="font-size:.72rem;color:var(--ink-dim);margin-top:1px">${esc(n.body)}</div><div style="font-size:.66rem;color:var(--ink-dim);margin-top:3px;font-family:'JetBrains Mono',monospace">${ta(n.ts)}</div></div>
  </div>`).join('');
}
window.notifClick=function(nid,taskId){
  const n=notifications.find(x=>x.id===nid);if(n)n.read=true;saveNotifications();renderNotifBadge();renderNotifList();
  if(taskId){toggleNotifPanel();switchView('tasks');openDetail(taskId);}
};
window.clearAllNotifs=function(){notifications=[];saveNotifications();renderNotifBadge();renderNotifList();};
window.toggleNotifPanel=function(){
  const p=document.getElementById('notifPanel');
  const isOpen=p.style.display==='flex';
  p.style.display=isOpen?'none':'flex';
  if(!isOpen){notifications.forEach(n=>n.read=true);saveNotifications();renderNotifBadge();renderNotifList();}
};
// Close notif panel on outside click
document.addEventListener('click',e=>{const panel=document.getElementById('notifPanel');const bell=document.getElementById('notifBell');if(panel&&bell&&!panel.contains(e.target)&&!bell.contains(e.target))panel.style.display='none';},{capture:true});

// ══════════════════════════════════════════════
// ── AUTOMATIONS ──
// ══════════════════════════════════════════════
let automations=JSON.parse(localStorage.getItem('tf_automations')||'[]');
function saveAutomationsData(){localStorage.setItem('tf_automations',JSON.stringify(automations));}
window.openAutomations=function(){
  renderAutomationsList();document.getElementById('automationModal').style.display='flex';
};
window.closeAutomations=function(){document.getElementById('automationModal').style.display='none';};
function renderAutomationsList(){
  const list=document.getElementById('automationsList');
  if(!automations.length){list.innerHTML='<div style="font-size:.8rem;color:var(--ink-dim);margin-bottom:12px;font-style:italic">No automations yet. Create your first rule below.</div>';return;}
  list.innerHTML=`<div style="font-weight:700;font-size:.8rem;color:var(--ink-mid);margin-bottom:8px">Active Rules (${automations.length})</div>`+automations.map((a,i)=>
    `<div style="display:flex;align-items:center;gap:10px;background:var(--green-bg);border:1px solid var(--green-border);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:6px">
      <span style="font-size:1rem">⚡</span>
      <div style="flex:1"><div style="font-size:.82rem;font-weight:600">${esc(a.name||'Unnamed Rule')}</div><div style="font-size:.72rem;color:var(--ink-mid)">When: <strong>${a.trigger.replace(/_/g,' ')}</strong> → Then: <strong>${a.action.replace(/_/g,' ')}</strong></div></div>
      <button onclick="deleteAutomation(${i})" style="background:none;border:none;color:var(--ink-dim);cursor:pointer;font-size:.8rem">✕</button>
    </div>`).join('');
}
window.saveAutomation=function(){
  const trigger=document.getElementById('autoTrigger').value;
  const action=document.getElementById('autoAction').value;
  const name=document.getElementById('autoName').value.trim()||`${trigger.replace(/_/g,' ')} → ${action.replace(/_/g,' ')}`;
  automations.push({id:uid(),trigger,action,name,active:true});
  saveAutomationsData();renderAutomationsList();
  document.getElementById('autoName').value='';
  toast('⚡ Automation saved!');
};
window.deleteAutomation=function(i){automations.splice(i,1);saveAutomationsData();renderAutomationsList();};
// Run automations on task status change
async function runAutomations(trigger,task){
  const matching=automations.filter(a=>a.active&&a.trigger===trigger);
  if(!matching.length)return;
  const assignee=members.find(m=>m.id===task.assigneeId);
  const watchers=(task.watchers||[]).map(wid=>members.find(m=>m.id===wid)).filter(Boolean);
  for(const rule of matching){
    if(rule.action==='notify_assignee'&&assignee){
      addNotification(`⚡ Automation: ${rule.name||trigger}`,`Task "${task.title}" triggered: ${trigger.replace(/_/g,' ')}`,task.id);
    } else if(rule.action==='notify_watchers'){
      watchers.forEach(()=>addNotification(`⚡ ${rule.name||trigger}`,`"${task.title}" — ${trigger.replace(/_/g,' ')}`,task.id));
    } else if(rule.action==='notify_admin'||rule.action==='log_activity'){
      addNotification(`⚡ Rule: ${rule.name||trigger}`,`"${task.title}" — ${trigger.replace(/_/g,' ')}`,task.id);
    } else if(rule.action==='send_email'&&assignee){
      const cfg=getEmailConfig();if(cfg)await sendTaskEmailCustom(task,assignee,`Auto: ${trigger.replace(/_/g,' ')}`);
    }
  }
}
// Hook into qu() status changes
const _origQu=window.qu;
window.qu=async function(tid,field,val){
  await _origQu(tid,field,val);
  const t=tasks.find(x=>x.id===tid);if(!t)return;
  if(field==='status'){
    if(val==='done')await runAutomations('status_done',t);
    else if(val==='review')await runAutomations('status_review',t);
    else if(val==='in_progress')await runAutomations('status_in_progress',t);
  } else if(field==='assigneeId'&&val){
    await runAutomations('task_assigned',t);
    // Auto email notification on assign
    const assignee=members.find(m=>m.id===val);
    if(assignee)addNotification(`👤 Task Assigned`,`"${t.title}" assigned to ${assignee.name}`,tid);
  }
};

// ── AUTO EMAIL ON COMMENT ──
const _origPostComment=window.postComment;
window.postComment=async function(tid){
  await _origPostComment(tid);
  const t=tasks.find(x=>x.id===tid);if(!t)return;
  const commenter=currentUserProfile?.name||'Someone';
  if(t.assigneeId&&t.assigneeId!==currentUser?.uid){
    addNotification(`💬 New Comment`,`${commenter} commented on "${t.title}"`,tid);
  }
  (t.watchers||[]).filter(w=>w!==currentUser?.uid).forEach(()=>{
    addNotification(`💬 Comment on watched task`,`${commenter} commented on "${t.title}"`,tid);
  });
  await runAutomations('comment_added',t);
};

// ── OVERDUE AUTO-NOTIFY (daily) ──
function checkOverdueNotifs(){
  if(!currentUser)return;
  const now=new Date();
  const overdue=tasks.filter(t=>t.due&&new Date(t.due+'T00:00:00')<now&&t.status!=='done'&&!t.archived&&(t.assigneeId===currentUser.uid||isAdmin()));
  overdue.forEach(t=>{
    const key='tf_overdue_notif_'+t.id+'_'+now.toDateString();
    if(!localStorage.getItem(key)){localStorage.setItem(key,'1');addNotification('🔴 Overdue Task',`"${t.title}" is past its due date`,t.id);runAutomations('task_overdue',t);}
  });
}

// ══════════════════════════════════════════════
// ── GOALS & OKRs ──
// ══════════════════════════════════════════════
let goals=JSON.parse(localStorage.getItem('tf_goals')||'[]');
function saveGoals(){localStorage.setItem('tf_goals',JSON.stringify(goals));}
function renderGoals(){
  const grid=document.getElementById('goalsGrid');if(!grid)return;
  // populate owner dropdown
  const gOwner=document.getElementById('gOwner');if(gOwner)gOwner.innerHTML='<option value="">— Any —</option>'+members.map(m=>`<option value="${m.id}">${esc(m.name)}</option>`).join('');
  if(!goals.length){grid.innerHTML=`<div class="empty" style="margin-top:40px"><div class="empty-icon">🎯</div><div class="empty-title">No goals yet</div><div class="empty-sub">Create your first Goal or OKR to track team objectives.</div></div>`;return;}
  const statusMeta={on_track:{label:'On Track',color:'var(--green)',bg:'var(--green-bg)',border:'var(--green-border)'},at_risk:{label:'At Risk',color:'var(--amber)',bg:'var(--amber-bg)',border:'var(--amber-border)'},off_track:{label:'Off Track',color:'var(--red)',bg:'var(--red-bg)',border:'var(--red-border)'},achieved:{label:'Achieved',color:'var(--green)',bg:'var(--green-bg)',border:'var(--green-border)'}};
  grid.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px">`+goals.map((g,i)=>{
    const sm=statusMeta[g.status]||statusMeta.on_track;
    const pct=g.target>0?Math.min(100,Math.round((g.current/g.target)*100)):0;
    const owner=members.find(m=>m.id===g.ownerId);
    const due=g.deadline?fd(g.deadline):null;
    return`<div style="background:var(--white);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:18px;box-shadow:var(--shadow-xs)">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px">
        <div style="font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:.92rem;color:var(--ink);flex:1;margin-right:8px;letter-spacing:-.02em">🎯 ${esc(g.title)}</div>
        <div style="display:flex;gap:6px;flex-shrink:0">
          <span style="font-size:.68rem;font-weight:700;padding:2px 8px;border-radius:99px;background:${sm.bg};color:${sm.color};border:1px solid ${sm.border}">${sm.label}</span>
          <button onclick="editGoal(${i})" style="background:none;border:none;cursor:pointer;color:var(--ink-dim);font-size:.75rem">✏</button>
          <button onclick="deleteGoal(${i})" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:.75rem">✕</button>
        </div>
      </div>
      ${g.description?`<div style="font-size:.78rem;color:var(--ink-mid);margin-bottom:10px">${esc(g.description)}</div>`:''}
      ${g.target>0?`<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;font-size:.72rem;color:var(--ink-dim);margin-bottom:4px"><span>Progress</span><span><strong style="color:var(--ink)">${g.current}${g.unit?' '+g.unit:''}</strong> / ${g.target}${g.unit?' '+g.unit:''} (${pct}%)</span></div><div style="height:8px;background:var(--border);border-radius:99px"><div style="height:100%;width:${pct}%;background:${pct>=100?'var(--green)':pct>=60?'var(--blue)':'var(--amber)'};border-radius:99px;transition:width .3s"></div></div></div>`:''}
      <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap">
        ${owner?`<div style="display:flex;align-items:center;gap:5px;font-size:.72rem;color:var(--ink-dim)">${av(owner,18)}<span>${esc(owner.name)}</span></div>`:''}
        ${due?`<span style="font-size:.7rem;color:${due.cls==='overdue'?'var(--red)':due.cls==='warning'?'var(--amber)':'var(--ink-dim)'}">${due.text}</span>`:''}
        ${g.target>0?`<button onclick="updateGoalProgress(${i})" style="margin-left:auto;background:var(--accent-light);border:1px solid var(--accent-mid);border-radius:var(--radius-sm);padding:4px 10px;font-size:.72rem;font-weight:700;color:var(--accent);cursor:pointer">Update Progress</button>`:''}
      </div>
    </div>`;
  }).join('')+`</div>`;
}
window.openGoalModal=function(){
  document.getElementById('goalModalTitle').textContent='New Goal';
  document.getElementById('editGoalId').value='';
  ['gTitle','gDesc','gTarget','gCurrent','gUnit','gDeadline'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('gStatus').value='on_track';
  const gOwner=document.getElementById('gOwner');if(gOwner)gOwner.innerHTML='<option value="">— Any —</option>'+members.map(m=>`<option value="${m.id}">${esc(m.name)}</option>`).join('');
  document.getElementById('goalModal').style.display='flex';
};
window.closeGoalModal=function(){document.getElementById('goalModal').style.display='none';};
window.saveGoal=function(){
  const title=document.getElementById('gTitle').value.trim();if(!title)return alert('Please enter a goal title!');
  const eid=document.getElementById('editGoalId').value;
  const goal={title,description:document.getElementById('gDesc').value,target:parseFloat(document.getElementById('gTarget').value)||0,current:parseFloat(document.getElementById('gCurrent').value)||0,unit:document.getElementById('gUnit').value,deadline:document.getElementById('gDeadline').value||null,ownerId:document.getElementById('gOwner').value||null,status:document.getElementById('gStatus').value,id:eid||uid(),createdAt:Date.now()};
  if(eid){const idx=goals.findIndex(g=>g.id===eid);if(idx>=0)goals[idx]=goal;else goals.push(goal);}else goals.push(goal);
  saveGoals();closeGoalModal();renderGoals();toast('🎯 Goal saved!');
};
window.editGoal=function(i){
  const g=goals[i];if(!g)return;
  document.getElementById('goalModalTitle').textContent='Edit Goal';
  document.getElementById('editGoalId').value=g.id;
  document.getElementById('gTitle').value=g.title;document.getElementById('gDesc').value=g.description||'';
  document.getElementById('gTarget').value=g.target||'';document.getElementById('gCurrent').value=g.current||'';
  document.getElementById('gUnit').value=g.unit||'';document.getElementById('gDeadline').value=g.deadline||'';
  document.getElementById('gStatus').value=g.status||'on_track';
  const gOwner=document.getElementById('gOwner');if(gOwner){gOwner.innerHTML='<option value="">— Any —</option>'+members.map(m=>`<option value="${m.id}">${esc(m.name)}</option>`).join('');gOwner.value=g.ownerId||'';}
  document.getElementById('goalModal').style.display='flex';
};
window.deleteGoal=function(i){if(!confirm('Delete this goal?'))return;goals.splice(i,1);saveGoals();renderGoals();toast('🗑 Goal deleted');};
window.updateGoalProgress=function(i){
  const g=goals[i];const val=prompt(`Update progress for "${g.title}" (current: ${g.current}${g.unit?' '+g.unit:''}, target: ${g.target}${g.unit?' '+g.unit:''}):`,g.current);
  if(val===null)return;const n=parseFloat(val);if(isNaN(n))return;
  goals[i].current=n;if(n>=goals[i].target)goals[i].status='achieved';
  saveGoals();renderGoals();toast(`🎯 Progress updated to ${n}${g.unit?' '+g.unit:''}`);
};


// ══════════════════════════════════════════════
// ── COMPLIANCE MODULE ──
let complianceItems=[];
let pendingCRecur='';   // active recur selection in modal
let cTaskMode='link';   // 'link' | 'create' | 'none'
let cComplianceView='table'; // 'table' | 'list' | 'board'

const COMPLIANCE_TYPES={
  'Tax':       {bg:'#fff8e6',color:'#c97300',border:'#f5d080'},
  'Audit':     {bg:'#f3eeff',color:'#6d28d9',border:'#d0b8f8'},
  'Legal':     {bg:'#edf2ff',color:'#2056d8',border:'#b3c6fa'},
  'HR':        {bg:'#f0fdf9',color:'#0a9060',border:'#8de3bc'},
  'Finance':   {bg:'#fff1f1',color:'#d92020',border:'#fbb'},
  'Regulatory':{bg:'#f0f9ff',color:'#0369a1',border:'#bae6fd'},
  'Other':     {bg:'var(--bg2)',color:'var(--ink-mid)',border:'var(--border2)'},
};
const CS_STATUS={
  pending:     {label:'⏳ Pending',    cls:'pending'},
  in_progress: {label:'🔵 In Progress',cls:'in_progress'},
  completed:   {label:'✅ Completed',  cls:'completed'},
  overdue:     {label:'🔴 Overdue',    cls:'overdue'},
};
const CRECUR_LABELS={
  monthly:'Monthly','quarterly':'Quarterly','half-yearly':'Half-Yearly',yearly:'Yearly'
};

/* ── helpers ── */
window.setCView=function(v){
  cComplianceView=v;
  ['table','list','board'].forEach(m=>{
    const btn=document.getElementById('cvBtn-'+m);
    const el=document.getElementById('cView'+m.charAt(0).toUpperCase()+m.slice(1));
    if(btn) btn.classList.toggle('active',m===v);
    if(el)  el.style.display=m===v?(m==='table'?'block':'flex'):'none';
  });
  renderCompliance();
};

window.selectCRecur=function(btn,val){
  pendingCRecur=val;
  document.querySelectorAll('.c-recur-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const note=document.getElementById('cRecurNote');
  if(note) note.style.display=val?'block':'none';
};

window.setCTaskMode=function(mode){
  cTaskMode=mode;
  ['link','create','none'].forEach(m=>{
    document.getElementById('cTaskTab'+m.charAt(0).toUpperCase()+m.slice(1))?.classList.toggle('active',m===mode);
    const p=document.getElementById('cTaskPanel'+m.charAt(0).toUpperCase()+m.slice(1));
    if(p) p.classList.toggle('open',m===mode);
  });
};

/* ── subscribe ── */
function subscribeCompliance(){
  onValue(ref(db,'compliance'),snap=>{
    const v=snap.val()||{};
    complianceItems=Object.entries(v).map(([id,c])=>({id,...c}))
      .sort((a,b)=>(a.due||'').localeCompare(b.due||'')||b.ts-a.ts);
    // auto-mark overdue
    const today=new Date().toISOString().split('T')[0];
    complianceItems.forEach(c=>{
      if(c.due&&c.due<today&&c.status!=='completed'&&c.status!=='overdue')
        update(ref(db,`compliance/${c.id}`),{status:'overdue'});
    });
    if(currentView==='compliance') renderCompliance();
  });
}

/* ── next-cycle date helpers ── */
function nextComplianceMonth(monthStr, recur){
  const [y,m]=monthStr.split('-').map(Number);
  const d=new Date(y,m-1,1);
  if(recur==='monthly')    d.setMonth(d.getMonth()+1);
  else if(recur==='quarterly')  d.setMonth(d.getMonth()+3);
  else if(recur==='half-yearly')d.setMonth(d.getMonth()+6);
  else if(recur==='yearly') d.setFullYear(d.getFullYear()+1);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}
function nextDueDate(dueStr, recur){
  if(!dueStr) return null;
  const d=new Date(dueStr+'T00:00:00');
  if(recur==='monthly')    d.setMonth(d.getMonth()+1);
  else if(recur==='quarterly')  d.setMonth(d.getMonth()+3);
  else if(recur==='half-yearly')d.setMonth(d.getMonth()+6);
  else if(recur==='yearly') d.setFullYear(d.getFullYear()+1);
  // skip weekends: if Saturday(6) push to Monday, if Sunday(0) push to Monday
  const day=d.getDay();
  if(day===6) d.setDate(d.getDate()+2);      // Sat → Mon
  else if(day===0) d.setDate(d.getDate()+1); // Sun → Mon
  return d.toISOString().split('T')[0];
}

/* ── spawn next cycle ── */
async function spawnNextCycle(c){
  if(!c.recur) return;
  const nextMonth=nextComplianceMonth(c.month, c.recur);
  // prevent duplicate
  const exists=complianceItems.some(x=>x.name===c.name&&x.month===nextMonth&&x.recur===c.recur);
  if(exists) return;
  const newId=uid();
  const nextDue=nextDueDate(c.due, c.recur);
  const newC={
    name:c.name, month:nextMonth, type:c.type,
    due:nextDue, status:'pending', recur:c.recur,
    remarks:'', createdBy:c.createdBy||null,
    taskId:null,  // fresh task for next cycle
    ts:Date.now(), updatedAt:Date.now(), id:newId,
    spawnedFrom:c.id
  };
  await set(ref(db,`compliance/${newId}`),newC);
  addNotification(`🔁 Recurring Compliance`,`Next cycle created: "${c.name}" for ${nextMonth}`,null);
  toast(`🔁 Next cycle created for ${CRECUR_LABELS[c.recur]||c.recur} compliance`);
}

/* ── render ── */
function renderCompliance(){
  if(currentView!=='compliance') return;
  // Wait until user profile is loaded - prevents showing all records before role is known
  if(!currentUserProfile) return;
  // Show/hide Add button based on role
  const addBtn=document.getElementById('cAddBtn');
  if(addBtn) addBtn.style.display=isAdmin()?'':'none';
  const month =document.getElementById('cfMonth')?.value||'';
  const type  =document.getElementById('cfType')?.value||'';
  const status=document.getElementById('cfStatus')?.value||'';
  const q     =(document.getElementById('cfSearch')?.value||'').toLowerCase();

  let items=complianceItems.filter(c=>{
    // Members only see compliance records assigned to them
    if(!isAdmin()&&c.assigneeId!==(currentUser&&currentUser.uid)) return false;
    if(month &&c.month!==month)  return false;
    if(type  &&c.type!==type)    return false;
    if(status&&c.status!==status)return false;
    if(q&&!c.name.toLowerCase().includes(q)&&!(c.remarks||'').toLowerCase().includes(q)&&!(c.type||'').toLowerCase().includes(q)) return false;
    return true;
  });

  const today2=new Date().toISOString().split('T')[0];

  // shared helpers
  function typeChip(type){const tc=COMPLIANCE_TYPES[type]||COMPLIANCE_TYPES['Other'];return`<span class="c-card-type" style="background:${tc.bg};color:${tc.color};border:1px solid ${tc.border}">${esc(type||'—')}</span>`;}
  function statusSelect(c,stopProp='event.stopPropagation()'){
    if(!isAdmin()) return`<span style="font-size:.75rem;font-weight:700;color:${cs_color(c.status)}">${CS_STATUS[c.status]?.label||c.status}</span>`;
    return`<select class="ms" style="font-size:.75rem;font-weight:700;border:none;background:none;cursor:pointer;padding:0;color:${cs_color(c.status)}" onchange="quickUpdateComplianceStatus('${c.id}',this.value)" onclick="${stopProp}"><option value="pending" ${c.status==='pending'?'selected':''}>⏳ Pending</option><option value="in_progress" ${c.status==='in_progress'?'selected':''}>🔵 In Progress</option><option value="completed" ${c.status==='completed'?'selected':''}>✅ Completed</option><option value="overdue" ${c.status==='overdue'?'selected':''}>🔴 Overdue</option></select>`;
  }
  function actionBtns(c,stop='event.stopPropagation()'){
    if(!isAdmin()) return `<div style="display:flex;gap:4px"><button class="btn-icon btn-xs" title="Fill Dates" onclick="${stop};openComplianceModal('${c.id}')">📅</button></div>`;
    return`<div style="display:flex;gap:4px"><button class="btn-icon btn-xs" title="Edit" onclick="${stop};openComplianceModal('${c.id}')">✏</button><button class="btn-icon btn-xs" title="Delete" onclick="${stop};deleteCompliance('${c.id}')" style="color:var(--red)">🗑</button></div>`;
  }
  function dueStr(c){if(!c.due)return'';const isOD=c.due<today2&&c.status!=='completed';return`<span class="c-card-due${isOD?' overdue':''}">📅 ${new Date(c.due+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})}</span>`;}
  function monthStr(c){return c.month?`<span class="c-card-month">${new Date(c.month+'-01').toLocaleDateString('en-IN',{month:'short',year:'numeric'})}</span>`:'';}
  function recurBadge(c){return c.recur?`<span class="recur-badge">🔁 ${CRECUR_LABELS[c.recur]||c.recur}</span>`:''}

  const emptyHTML=`<div class="compliance-empty"><div class="compliance-empty-icon">🛡</div><div class="compliance-empty-title">No records found</div><div class="compliance-empty-sub">Try adjusting your filters or add a new compliance record.</div></div>`;

  // ── TABLE VIEW ──
  if(cComplianceView==='table'){
    const tbody=document.getElementById('complianceTableBody');
    if(!items.length){tbody.innerHTML=`<tr><td colspan="11">${emptyHTML}</td></tr>`;return;}
    tbody.innerHTML=items.map((c,i)=>{
      const dueColor=c.due&&c.due<today2&&c.status!=='completed'?'color:var(--red);font-weight:700':'';
      const dueDisplay=c.due?new Date(c.due+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):'—';
      const monthDisplay=c.month?new Date(c.month+'-01').toLocaleDateString('en-IN',{month:'short',year:'numeric'}):'—';
      const rb=c.recur?`<div style="margin-top:4px"><span class="recur-badge">🔁 ${CRECUR_LABELS[c.recur]||c.recur}</span></div>`:'';
      const assignee=members.find(m=>m.id===c.assigneeId);
      const assigneeCell=assignee?`<div style="display:flex;align-items:center;gap:6px">${av(assignee,20)}<span style="font-size:.78rem;font-weight:500">${esc(assignee.name)}</span></div>`:`<span style="font-size:.72rem;color:var(--ink-dim)">—</span>`;
      return`<tr onclick="openComplianceModal('${c.id}')">
        <td style="color:var(--ink-dim);font-size:.75rem;font-family:'JetBrains Mono',monospace">${i+1}</td>
        <td class="td-name"><div>${esc(c.name)}</div>${rb}</td>
        <td style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--ink-mid)">${monthDisplay}</td>
        <td class="td-type">${typeChip(c.type)}</td>
        <td onclick="event.stopPropagation()">${assigneeCell}</td>
        <td style="${dueColor}">${dueDisplay}</td>
        <td style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--ink-mid)">${c.submitDate?new Date(c.submitDate+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):'—'}</td>
        <td style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--ink-mid)">${c.filingDate?new Date(c.filingDate+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):'—'}</td>
        <td>${statusSelect(c)}</td>
        <td class="td-remarks" title="${esc(c.remarks||'')}">${esc(c.remarks||'—')}</td>
        <td onclick="event.stopPropagation()"><div class="compliance-row-actions">
          ${isAdmin()?`<button class="btn-icon btn-xs" title="Edit" onclick="openComplianceModal('${c.id}')">✏</button>
          <button class="btn-icon btn-xs" title="Delete" onclick="deleteCompliance('${c.id}')" style="color:var(--red)">🗑</button>`:`<button class="btn-icon btn-xs" title="Fill Dates" onclick="openComplianceModal('${c.id}')">📅</button>`}
        </div></td></tr>`;
    }).join('');
    return;
  }

  // ── LIST VIEW ──
  if(cComplianceView==='list'){
    const el=document.getElementById('cViewList');
    if(!items.length){el.innerHTML=`<div style="flex:1">${emptyHTML}</div>`;return;}
    el.innerHTML=items.map(c=>{
      const assignee=members.find(m=>m.id===c.assigneeId);
      return`
      <div class="c-list-item" onclick="openComplianceModal('${c.id}')">
        <div>
          <div class="c-list-name">${esc(c.name)}</div>
          <div class="c-list-sub" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:3px">
            ${monthStr(c)} ${recurBadge(c)}
          </div>
        </div>
        <div>${typeChip(c.type)}</div>
        <div style="display:flex;align-items:center;gap:5px">${assignee?`${av(assignee,20)}<span style="font-size:.78rem;font-weight:500;color:var(--ink-mid)">${esc(assignee.name)}</span>`:`<span style="font-size:.72rem;color:var(--ink-dim)">Unassigned</span>`}</div>
        <div style="display:flex;flex-direction:column;gap:3px;font-size:.72rem;font-family:'JetBrains Mono',monospace;color:var(--ink-mid)">
          ${dueStr(c)||'<span style="color:var(--ink-dim)">No due date</span>'}
          ${c.submitDate?`<span>📤 ${new Date(c.submitDate+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short'})}</span>`:''}
          ${c.filingDate?`<span>🗂 ${new Date(c.filingDate+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short'})}</span>`:''}
        </div>
        <div onclick="event.stopPropagation()">${statusSelect(c,'event.stopPropagation()')}</div>
        <div onclick="event.stopPropagation()" class="c-list-actions">${actionBtns(c,'event.stopPropagation()')}</div>
      </div>`;}).join('');
    return;
  }

  // ── BOARD VIEW ──
  if(cComplianceView==='board'){
    const el=document.getElementById('cViewBoard');
    const cols=[
      {key:'pending',   label:'⏳ Pending',     color:'var(--amber)', bg:'var(--amber-bg)',   border:'var(--amber-border)'},
      {key:'in_progress',label:'🔵 In Progress', color:'var(--blue)',  bg:'var(--blue-bg)',    border:'var(--blue-border)'},
      {key:'completed', label:'✅ Completed',    color:'var(--green)', bg:'var(--green-bg)',   border:'var(--green-border)'},
      {key:'overdue',   label:'🔴 Overdue',      color:'var(--red)',   bg:'var(--red-bg)',     border:'var(--red-border)'},
    ];
    el.innerHTML=cols.map(col=>{
      const colItems=items.filter(c=>c.status===col.key);
      const cards=colItems.length
        ?colItems.map(c=>{
          const assignee=members.find(m=>m.id===c.assigneeId);
          return`
          <div class="c-card" onclick="openComplianceModal('${c.id}')" style="border-top:3px solid ${col.color}">
            <div class="c-card-title">${esc(c.name)}</div>
            <div class="c-card-meta">${typeChip(c.type)} ${monthStr(c)}</div>
            ${assignee?`<div style="display:flex;align-items:center;gap:5px;margin-bottom:6px">${av(assignee,18)}<span style="font-size:.72rem;color:var(--ink-mid);font-weight:500">${esc(assignee.name)}</span></div>`:''}
            ${c.recur?`<div style="margin-bottom:6px">${recurBadge(c)}</div>`:''}
            ${c.due?`<div style="margin-bottom:4px">${dueStr(c)}</div>`:''}
            ${c.submitDate||c.filingDate?`<div style="display:flex;gap:8px;font-size:.68rem;font-family:'JetBrains Mono',monospace;color:var(--ink-dim);margin-bottom:4px">${c.submitDate?`<span>📤 ${new Date(c.submitDate+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})}</span>`:''} ${c.filingDate?`<span>🗂 ${new Date(c.filingDate+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})}</span>`:''}</div>`:''}
            ${c.remarks?`<div style="font-size:.72rem;color:var(--ink-mid);margin-top:4px;line-height:1.4">${esc(c.remarks.length>60?c.remarks.slice(0,60)+'…':c.remarks)}</div>`:''}
            <div class="c-card-footer">
              <div onclick="event.stopPropagation()">${statusSelect(c,'event.stopPropagation()')}</div>
              <div onclick="event.stopPropagation()" class="c-card-actions">
                <button class="btn-icon btn-xs" onclick="event.stopPropagation();openComplianceModal('${c.id}')">✏</button>
                <button class="btn-icon btn-xs" onclick="event.stopPropagation();deleteCompliance('${c.id}')" style="color:var(--red)">🗑</button>
              </div>
            </div>
          </div>`;}).join('')
        :`<div class="c-col-empty">No ${col.label.replace(/[^\w ]/g,'').trim()} items</div>`;
      return`<div class="c-col" style="border-top:3px solid ${col.color}">
        <div class="c-col-header">
          <span class="c-col-title" style="color:${col.color}">${col.label}</span>
          <span class="c-col-count" style="background:${col.bg};color:${col.color};border:1px solid ${col.border}">${colItems.length}</span>
        </div>
        <div class="c-col-cards">${cards}</div>
      </div>`;
    }).join('');
    return;
  }
}


function cs_color(status){
  return status==='completed'?'var(--green)':status==='overdue'?'var(--red)':status==='in_progress'?'var(--blue)':'var(--amber)';
}

window.clearComplianceFilters=function(){
  ['cfMonth','cfType','cfStatus'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const s=document.getElementById('cfSearch');if(s)s.value='';
  renderCompliance();
};

/* ── quick status update inline ── */
window.quickUpdateComplianceStatus=async function(cid,newStatus){
  const c=complianceItems.find(x=>x.id===cid);if(!c)return;
  const prev=c.status;
  await update(ref(db,`compliance/${cid}`),{status:newStatus,updatedAt:Date.now()});
  // trigger next cycle when completing a recurring item
  if(newStatus==='completed'&&prev!=='completed'&&c.recur){
    await spawnNextCycle({...c,status:'completed'});
  }
  toast(newStatus==='completed'?'✅ Marked completed!':'🔄 Status updated');
};

/* ── quick Add Task button in table ── */
window.createTaskForCompliance=async function(cid){
  const c=complianceItems.find(x=>x.id===cid);if(!c)return;
  const tId=uid();
  await set(ref(db,`tasks/${tId}`),{
    title:c.name, description:`Compliance task for ${c.month} - ${c.type}`,
    status:'todo', priority:'medium', source:'team',
    due:c.due||null, assigneeId:null, assignedAt:null,
    tags:['compliance',c.type?.toLowerCase()||''], subtasks:[],
    color:'', recur:c.recur||null, estimatedTime:null,
    createdBy:currentUser?.uid||null, ts:Date.now(), comments:{},
  });
  await update(ref(db,`compliance/${cid}`),{taskId:tId,updatedAt:Date.now()});
  toast('✅ Task created and linked!');
};

/* ── open modal ── */
window.openComplianceModal=function(cid){
  const c=cid?complianceItems.find(x=>x.id===cid):null;
  const memberMode=!isAdmin();

  // Members cannot create new records — only fill dates on existing ones
  if(memberMode&&!cid){toast('Only admins can add new compliance records.');return;}

  document.getElementById('complianceModalTitle').textContent=memberMode?'Fill Compliance Dates':(c?'Edit Compliance':'Add Compliance');
  document.getElementById('editComplianceId').value=c?.id||'';
  document.getElementById('cName').value=c?.name||'';
  document.getElementById('cMonth').value=c?.month||new Date().toISOString().slice(0,7);
  document.getElementById('cType').value=c?.type||'';
  document.getElementById('cDue').value=c?.due||'';
  const today=new Date().toISOString().split('T')[0];
  document.getElementById('cSubmitDate').value=c?.submitDate||today;
  document.getElementById('cFilingDate').value=c?.filingDate||'';
  document.getElementById('cStatus').value=c?.status||'pending';
  document.getElementById('cRemarks').value=c?.remarks||'';

  // recur
  pendingCRecur=c?.recur||'';
  document.querySelectorAll('.c-recur-btn').forEach(b=>{b.classList.toggle('active',b.dataset.v===pendingCRecur);});
  const note=document.getElementById('cRecurNote');
  if(note) note.style.display=pendingCRecur?'block':'none';

  // populate assignee dropdown
  const assigneeSel=document.getElementById('cAssignee');
  if(assigneeSel){assigneeSel.innerHTML=`<option value="">— Unassigned —</option>`+members.map(m=>`<option value="${m.id}" ${c?.assigneeId===m.id?'selected':''}>${esc(m.name)}</option>`).join('');}

  // ── ROLE-BASED FIELD VISIBILITY ──
  const adminOnlyIds=['cAdminRow1','cAdminRow2','cAdminRecur','cAdminAssignee','cAdminStatus','cAdminRemarks'];
  adminOnlyIds.forEach(id=>{const el=document.getElementById(id);if(el)el.style.display=memberMode?'none':'';});

  // Member banner: show record name + meta info
  const banner=document.getElementById('cMemberBanner');
  if(banner){
    banner.style.display=memberMode?'block':'none';
    if(memberMode&&c){
      document.getElementById('cMemberName').textContent=c.name||'';
      const monthLabel=c.month?new Date(c.month+'-01').toLocaleDateString('en-IN',{month:'long',year:'numeric'}):'';
      const typeLabel=c.type||'';
      const dueLabel=c.due?'Due: '+new Date(c.due+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):'';
      document.getElementById('cMemberMeta').textContent=[typeLabel,monthLabel,dueLabel].filter(Boolean).join(' · ');
    }
  }

  document.getElementById('complianceModal').style.display='flex';
  setTimeout(()=>document.getElementById(memberMode?'cSubmitDate':'cName').focus(),50);
};

window.closeComplianceModal=function(){document.getElementById('complianceModal').style.display='none';};

/* ── save ── */
window.saveCompliance=async function(){
  const eid=document.getElementById('editComplianceId').value;

  // ── MEMBER MODE: only save Submit Date & Filing Date ──
  if(!isAdmin()){
    if(!eid){toast('Only admins can add new compliance records.');return;}
    await update(ref(db,`compliance/${eid}`),{
      submitDate:document.getElementById('cSubmitDate').value||null,
      filingDate:document.getElementById('cFilingDate').value||null,
      updatedAt:Date.now()
    });
    closeComplianceModal();
    toast('✅ Dates saved successfully!');
    return;
  }

  // ── ADMIN MODE: full save ──
  const name=document.getElementById('cName').value.trim();
  if(!name) return alert('Please enter a compliance name!');
  const cType=document.getElementById('cType').value;
  if(!cType) return alert('Please select a compliance type!');
  const month=document.getElementById('cMonth').value;
  if(!month) return alert('Please select a month!');
  const prevStatus=eid?complianceItems.find(x=>x.id===eid)?.status:null;
  const newStatus=document.getElementById('cStatus').value||'pending';

  // handle assignee
  const assigneeId=document.getElementById('cAssignee')?.value||null;

  const data={
    name, month, type:cType,
    assigneeId,
    due:document.getElementById('cDue').value||null,
    submitDate:document.getElementById('cSubmitDate').value||null,
    filingDate:document.getElementById('cFilingDate').value||null,
    status:newStatus,
    recur:pendingCRecur||null,
    remarks:document.getElementById('cRemarks').value.trim()||'',
    createdBy:currentUser?.uid||null,
    ts:eid?(complianceItems.find(x=>x.id===eid)?.ts||Date.now()):Date.now(),
    updatedAt:Date.now()
  };

  if(eid){
    await update(ref(db,`compliance/${eid}`),data);
    // if just completed a recurring item, spawn next cycle
    if(newStatus==='completed'&&prevStatus!=='completed'&&pendingCRecur){
      await spawnNextCycle({...data,id:eid,status:'completed'});
    }
  } else {
    const newId=uid();
    await set(ref(db,`compliance/${newId}`),{...data,id:newId});
  }
  closeComplianceModal();
  toast(eid?'✅ Compliance updated!':'✅ Compliance added!');
};

window.deleteCompliance=async function(cid){
  if(!isAdmin()){toast('Only admins can delete compliance records.');return;}
  if(!confirm('Delete this compliance record?'))return;
  await remove(ref(db,`compliance/${cid}`));
  toast('🗑 Compliance deleted');
};

window.exportComplianceCSV=function(){
  const headers=['#','Name','Month','Type','Recurring','Assigned To','Due Date','Submit Date','Filing Date','Status','Remarks'];
  const rows=complianceItems.map((c,i)=>{
    const assignee=members.find(m=>m.id===c.assigneeId);
    return[i+1,`"${(c.name||'').replace(/"/g,'""')}"`,c.month||'',c.type||'',c.recur||'None',assignee?`"${assignee.name}"`:'',(c.due||''),(c.submitDate||''),(c.filingDate||''),c.status||'',`"${(c.remarks||'').replace(/"/g,'""')}"`];
  });
  const csv=[headers.join(','),...rows.map(r=>r.join(','))].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`compliance-${new Date().toISOString().slice(0,7)}.csv`;a.click();
  URL.revokeObjectURL(url);toast('✅ Compliance CSV exported!');
};

// ── end COMPLIANCE MODULE ──




// ══════════════════════════════════════════════
// ── NOTES MODULE (Evernote-style) ──
// ══════════════════════════════════════════════
let notes = JSON.parse(localStorage.getItem('gf_notes') || '[]');
let notebooks = JSON.parse(localStorage.getItem('gf_notebooks') || '["Personal","Work","Finance"]');
let currentNoteId = null;
let activeNotebook = null;
let activeNoteTag = null;
let noteSaveTimer = null;

function saveNotesToStorage() {
  localStorage.setItem('gf_notes', JSON.stringify(notes));
  localStorage.setItem('gf_notebooks', JSON.stringify(notebooks));
}

function noteUid() { return 'n' + Date.now().toString(36) + Math.random().toString(36).slice(2, 7); }

window.newNote = function() {
  const note = {
    id: noteUid(),
    title: '',
    body: '',
    tags: [],
    notebook: activeNotebook || notebooks[0] || 'Personal',
    pinned: false,
    created: Date.now(),
    updated: Date.now()
  };
  notes.unshift(note);
  saveNotesToStorage();
  renderNotesList();
  openNote(note.id);
  setTimeout(() => document.getElementById('noteTitleInput')?.focus(), 50);
};

window.openNote = function(id) {
  currentNoteId = id;
  const note = notes.find(n => n.id === id);
  if (!note) return;
  document.getElementById('notesEmptyState').style.display = 'none';
  document.getElementById('notesEditorArea').style.display = 'flex';
  document.getElementById('notesEditorArea').style.flexDirection = 'column';
  document.getElementById('noteTitleInput').value = note.title;
  document.getElementById('noteBody').innerHTML = note.body;
  renderCurNoteTags(note);
  document.getElementById('notePinBtn').textContent = note.pinned ? '📌' : '📍';
  document.getElementById('notePinBtn').title = note.pinned ? 'Unpin note' : 'Pin note';
  // populate notebook select
  const ns = document.getElementById('noteNotebook');
  ns.innerHTML = notebooks.map(nb => `<option value="${esc(nb)}" ${nb === note.notebook ? 'selected' : ''}>${esc(nb)}</option>`).join('');
  // meta
  document.getElementById('noteMetaInfo').textContent = fmtDate(note.updated);
  setSaveStatus('');
  renderNotesList();
};

function renderCurNoteTags(note) {
  const el = document.getElementById('noteCurTags');
  if (!el) return;
  el.innerHTML = (note.tags || []).map((t, i) => `<span class="note-tag-chip">${esc(t)}<span onclick="removeNoteTag(${i})" style="opacity:.6;font-size:.8rem">×</span></span>`).join('');
}

window.removeNoteTag = function(i) {
  const note = notes.find(n => n.id === currentNoteId);
  if (!note) return;
  note.tags.splice(i, 1);
  note.updated = Date.now();
  saveNotesToStorage();
  renderCurNoteTags(note);
  renderNotesTagFilter();
  renderNotesList();
};

window.noteTagKey = function(e) {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    const val = e.target.value.trim().replace(/,/g, '').toLowerCase();
    if (!val) return;
    const note = notes.find(n => n.id === currentNoteId);
    if (!note) return;
    if (!note.tags.includes(val)) note.tags.push(val);
    note.updated = Date.now();
    saveNotesToStorage();
    e.target.value = '';
    renderCurNoteTags(note);
    renderNotesTagFilter();
    renderNotesList();
  }
};

window.onNoteChange = function() {
  setSaveStatus('Unsaved…');
  clearTimeout(noteSaveTimer);
  noteSaveTimer = setTimeout(autoSaveNote, 800);
};

function autoSaveNote() {
  const note = notes.find(n => n.id === currentNoteId);
  if (!note) return;
  note.title = document.getElementById('noteTitleInput').value.trim();
  note.body = document.getElementById('noteBody').innerHTML;
  note.updated = Date.now();
  // move to top (unless pinned notes at top)
  const idx = notes.indexOf(note);
  if (idx > 0 && !note.pinned) { notes.splice(idx, 1); notes.unshift(note); }
  saveNotesToStorage();
  setSaveStatus('Saved ✓');
  document.getElementById('noteMetaInfo').textContent = fmtDate(note.updated);
  renderNotesList();
}

function setSaveStatus(s) {
  const el = document.getElementById('notesSaveStatus');
  if (el) el.textContent = s;
}

window.pinNote = function() {
  const note = notes.find(n => n.id === currentNoteId);
  if (!note) return;
  note.pinned = !note.pinned;
  note.updated = Date.now();
  saveNotesToStorage();
  document.getElementById('notePinBtn').textContent = note.pinned ? '📌' : '📍';
  renderNotesList();
  toast(note.pinned ? '📌 Note pinned!' : '📍 Note unpinned');
};

window.deleteCurrentNote = function() {
  if (!currentNoteId) return;
  if (!confirm('Delete this note?')) return;
  notes = notes.filter(n => n.id !== currentNoteId);
  currentNoteId = null;
  saveNotesToStorage();
  document.getElementById('notesEmptyState').style.display = 'flex';
  document.getElementById('notesEditorArea').style.display = 'none';
  renderNotesList();
  toast('🗑 Note deleted');
};

window.moveNoteToNotebook = function() {
  const note = notes.find(n => n.id === currentNoteId);
  if (!note) return;
  note.notebook = document.getElementById('noteNotebook').value;
  note.updated = Date.now();
  saveNotesToStorage();
  renderNotebooksList();
  renderNotesList();
};

window.createNotebook = function() {
  const name = prompt('New notebook name:');
  if (!name || !name.trim()) return;
  const nb = name.trim();
  if (notebooks.includes(nb)) { toast('Notebook already exists'); return; }
  notebooks.push(nb);
  saveNotesToStorage();
  renderNotebooksList();
  toast('📓 Notebook created: ' + nb);
};

window.filterByNotebook = function(nb) {
  activeNotebook = activeNotebook === nb ? null : nb;
  activeNoteTag = null;
  renderNotebooksList();
  renderNotesTagFilter();
  renderNotesList();
};

window.filterByNoteTag = function(tag) {
  activeNoteTag = activeNoteTag === tag ? null : tag;
  renderNotesTagFilter();
  renderNotesList();
};

function getFilteredNotes() {
  const q = (document.getElementById('notesSearch')?.value || '').toLowerCase();
  let list = [...notes];
  if (activeNotebook) list = list.filter(n => n.notebook === activeNotebook);
  if (activeNoteTag) list = list.filter(n => n.tags.includes(activeNoteTag));
  if (q) list = list.filter(n => n.title.toLowerCase().includes(q) || n.body.replace(/<[^>]+>/g, '').toLowerCase().includes(q) || n.tags.some(t => t.includes(q)));
  // pinned first
  list.sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0) || b.updated - a.updated);
  return list;
}

window.renderNotesList = function() {
  const wrap = document.getElementById('notesListWrap');
  if (!wrap) return;
  const list = getFilteredNotes();
  if (!list.length) {
    wrap.innerHTML = `<div style="text-align:center;padding:24px 10px;color:var(--ink-dim);font-size:.78rem">No notes found.<br><span onclick="newNote()" style="color:var(--accent);cursor:pointer;font-weight:600">Create one →</span></div>`;
    return;
  }
  wrap.innerHTML = list.map(n => {
    const preview = n.body.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim().slice(0, 80);
    const isActive = n.id === currentNoteId;
    return `<div class="note-item${isActive ? ' active' : ''}" onclick="openNote('${n.id}')">
      <div class="note-item-title">${n.pinned ? '📌 ' : ''}${n.title || '<em style="opacity:.5">Untitled</em>'}</div>
      ${preview ? `<div class="note-item-preview">${esc(preview)}</div>` : ''}
      <div class="note-item-meta">
        <span>${fmtDate(n.updated)}</span>
        ${n.tags.length ? `<span>🏷 ${n.tags.slice(0,2).join(', ')}${n.tags.length > 2 ? '…' : ''}</span>` : ''}
        <span style="margin-left:auto;opacity:.6">${esc(n.notebook)}</span>
      </div>
    </div>`;
  }).join('');
};

function renderNotebooksList() {
  const el = document.getElementById('notebooksList');
  if (!el) return;
  const allCounts = {};
  notebooks.forEach(nb => allCounts[nb] = notes.filter(n => n.notebook === nb).length);
  const allBtn = `<button class="nb-btn${!activeNotebook ? ' active' : ''}" onclick="filterByNotebook(null)">📓 All Notes <span style="margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:.65rem;opacity:.7">${notes.length}</span></button>`;
  const nbBtns = notebooks.map(nb => `<button class="nb-btn${activeNotebook === nb ? ' active' : ''}" onclick="filterByNotebook('${esc(nb)}')" style="justify-content:space-between">
    <span>📔 ${esc(nb)}</span>
    <span style="font-family:'JetBrains Mono',monospace;font-size:.65rem;opacity:.7">${allCounts[nb] || 0}</span>
  </button>`).join('');
  el.innerHTML = allBtn + nbBtns;
}

function renderNotesTagFilter() {
  const el = document.getElementById('notesTagFilter');
  if (!el) return;
  const allTags = [...new Set(notes.flatMap(n => n.tags))].sort();
  if (!allTags.length) { el.innerHTML = '<span style="font-size:.72rem;color:var(--ink-dim)">No tags yet</span>'; return; }
  el.innerHTML = allTags.map(t => `<button class="note-tag-filter${activeNoteTag === t ? ' active' : ''}" onclick="filterByNoteTag('${esc(t)}')">${esc(t)}</button>`).join('');
}

// Formatting helpers
window.noteFmt = function(cmd) {
  document.getElementById('noteBody').focus();
  document.execCommand(cmd, false, null);
  onNoteChange();
};
window.noteFmtBlock = function(tag) {
  document.getElementById('noteBody').focus();
  document.execCommand('formatBlock', false, tag);
  onNoteChange();
};
window.insertNoteCheckbox = function() {
  document.getElementById('noteBody').focus();
  document.execCommand('insertHTML', false, '<div><input type="checkbox"> <span></span></div>');
  onNoteChange();
};
window.insertNoteHr = function() {
  document.getElementById('noteBody').focus();
  document.execCommand('insertHTML', false, '<hr><p><br></p>');
  onNoteChange();
};
window.insertNoteCode = function() {
  document.getElementById('noteBody').focus();
  document.execCommand('insertHTML', false, '<pre><code></code></pre><p><br></p>');
  onNoteChange();
};

// Render notes view when switching to it
function renderNotesView() {
  renderNotebooksList();
  renderNotesTagFilter();
  renderNotesList();
  // Update notes badge
  const nc=document.getElementById('notesCount');if(nc)nc.textContent=notes.length;
  if (!currentNoteId) {
    document.getElementById('notesEmptyState').style.display = 'flex';
    document.getElementById('notesEditorArea').style.display = 'none';
  }
}

// ══════════════════════════════════════════════
// ── TEMPORARY BOARD MODULE ──
// ══════════════════════════════════════════════
let tempTasks = JSON.parse(localStorage.getItem('gf_tempboard') || '[]');

function saveTempTasks() {
  localStorage.setItem('gf_tempboard', JSON.stringify(tempTasks));
}

function tempUid() { return 'tmp' + Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

window.openTempBoard = function() {
  document.getElementById('tempBoardOverlay').style.display = 'block';
  document.getElementById('tempBoardPanel').style.display = 'flex';
  // Restore saved purpose
  const savedPurpose = localStorage.getItem('gf_tempboard_purpose') || '';
  document.getElementById('tempBoardPurpose').value = savedPurpose;
  renderTempBoard();
  setTimeout(() => document.getElementById('tempTaskInput').focus(), 100);
};

window.closeTempBoard = function() {
  document.getElementById('tempBoardOverlay').style.display = 'none';
  document.getElementById('tempBoardPanel').style.display = 'none';
  // Save purpose
  localStorage.setItem('gf_tempboard_purpose', document.getElementById('tempBoardPurpose').value);
};

window.addTempTask = function() {
  const inp = document.getElementById('tempTaskInput');
  const title = inp.value.trim();
  if (!title) return;
  const priority = document.getElementById('tempTaskPriority').value;
  tempTasks.push({ id: tempUid(), title, priority, done: false, ts: Date.now() });
  saveTempTasks();
  inp.value = '';
  inp.focus();
  renderTempBoard();
};

window.toggleTempTask = function(id) {
  const t = tempTasks.find(x => x.id === id);
  if (!t) return;
  t.done = !t.done;
  t.doneAt = t.done ? Date.now() : null;
  saveTempTasks();
  renderTempBoard();
};

window.deleteTempTask = function(id) {
  tempTasks = tempTasks.filter(x => x.id !== id);
  saveTempTasks();
  renderTempBoard();
};

window.clearDoneTempTasks = function() {
  const count = tempTasks.filter(x => x.done).length;
  if (!count) { toast('No done tasks to clear'); return; }
  tempTasks = tempTasks.filter(x => !x.done);
  saveTempTasks();
  renderTempBoard();
  toast(`✓ Cleared ${count} done task${count > 1 ? 's' : ''} from Temp Board`);
};

window.clearTempBoard = function() {
  if (!tempTasks.length) { toast('Temp Board is already empty'); return; }
  if (!confirm(`Clear all ${tempTasks.length} tasks from the Temp Board? This cannot be undone.`)) return;
  tempTasks = [];
  localStorage.removeItem('gf_tempboard_purpose');
  document.getElementById('tempBoardPurpose').value = '';
  saveTempTasks();
  renderTempBoard();
  toast('🧹 Temp Board cleared!');
};

const TEMP_P = {
  critical: { icon: '🔴', color: '#b91c1c', bg: '#fef2f2', border: '#fca5a5' },
  high:     { icon: '🟠', color: '#c2410c', bg: '#fff7ed', border: '#fdba74' },
  medium:   { icon: '🟡', color: '#b45309', bg: '#fffbeb', border: '#fcd34d' },
  low:      { icon: '🟢', color: '#047857', bg: '#ecfdf5', border: '#6ee7b7' }
};

function renderTempBoard() {
  const todo = tempTasks.filter(t => !t.done);
  const done = tempTasks.filter(t => t.done);

  document.getElementById('tempTodoCount').textContent = todo.length;
  document.getElementById('tempDoneCount').textContent = done.length;

  const cardHtml = (t) => {
    const p = TEMP_P[t.priority] || TEMP_P.medium;
    return `<div class="temp-card${t.done ? ' done-card' : ''}">
      <div class="temp-card-actions">
        <button class="temp-card-btn" onclick="toggleTempTask('${t.id}')" title="${t.done ? 'Reopen' : 'Mark done'}">${t.done ? '↩' : '✓'}</button>
        <button class="temp-card-btn" onclick="deleteTempTask('${t.id}')" title="Remove" style="color:var(--red)">✕</button>
      </div>
      <div class="temp-card-title">${esc(t.title)}</div>
      <div><span class="temp-card-priority" style="background:${p.bg};color:${p.color};border:1px solid ${p.border}">${p.icon} ${t.priority}</span></div>
    </div>`;
  };

  document.getElementById('tempTodoList').innerHTML = todo.length
    ? todo.map(cardHtml).join('')
    : '<div style="text-align:center;padding:20px 10px;color:var(--ink-dim);font-size:.78rem;border:1.5px dashed var(--border);border-radius:var(--radius)">No tasks yet<br><span style="font-size:.7rem">Add one above ↑</span></div>';

  document.getElementById('tempDoneList').innerHTML = done.length
    ? done.map(cardHtml).join('')
    : '<div style="text-align:center;padding:20px 10px;color:var(--ink-dim);font-size:.78rem;border:1.5px dashed var(--border);border-radius:var(--radius)">Nothing done yet</div>';

  const total = tempTasks.length;
  const pct = total ? Math.round((done.length / total) * 100) : 0;
  document.getElementById('tempBoardStats').textContent = total
    ? `${done.length}/${total} done · ${pct}% complete`
    : 'Empty board';

  // Update sidebar badge
  const btn = document.getElementById('tempBoardBtn');
  if (btn) {
    btn.textContent = `🧲 Temp Board${total ? ` (${todo.length})` : ''}`;
    btn.style.color = todo.length > 0 ? 'var(--amber)' : 'var(--green)';
  }
}

// Init badge on load
setTimeout(renderTempBoard, 500);

// ── end TEMP BOARD MODULE ──

// ══════════════════════════════════════════════
// ── FIRST-TIME WELCOME MODAL ──
// ══════════════════════════════════════════════
function showWelcomeModal(){
  const profile=currentUserProfile;
  if(!profile)return;
  const isAdm=profile.role==='admin';
  const name=profile.name||'there';
  const firstName=name.split(' ')[0];

  // Avatar initials
  const initials=name.split(' ').map(p=>p[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('welcomeAvatar').textContent=initials;
  document.getElementById('welcomeAvatar').style.background=profile.color||'var(--grad-accent)';

  // Greeting
  const hour=new Date().getHours();
  const greeting=hour<12?'Good morning':hour<17?'Good afternoon':'Good evening';
  document.getElementById('welcomeName').textContent=`${greeting}, ${firstName}! 👋`;
  document.getElementById('welcomeEmoji').textContent=isAdm?'🏆':'🎯';

  // Role badge
  const rb=document.getElementById('welcomeRoleBadge');
  rb.textContent=isAdm?'Admin':'Member';
  rb.className='role-badge '+(isAdm?'role-admin':'role-member');

  // Subtitle & steps based on role
  if(isAdm){
    document.getElementById('welcomeSubtitle').textContent='You have admin access. Set up your team and start assigning tasks.';
    document.getElementById('welcomeRoleDesc').textContent='Full access: manage team, compliance, reports & tasks';
    document.getElementById('welcomePrimaryBtn').textContent='🏢 Go to Team Dashboard';
    document.getElementById('welcomeSteps').innerHTML=`
      <div class="welcome-step"><span class="welcome-step-num">1</span><div><div class="welcome-step-title">Invite team members</div><div class="welcome-step-sub">Go to Team tab → share the app URL so members can register</div></div></div>
      <div class="welcome-step"><span class="welcome-step-num">2</span><div><div class="welcome-step-title">Create your first task</div><div class="welcome-step-sub">Click "+ New Task" and assign it to a team member</div></div></div>
      <div class="welcome-step"><span class="welcome-step-num">3</span><div><div class="welcome-step-title">Set up Compliance records</div><div class="welcome-step-sub">Head to 🛡 Compliance tab to track filings & deadlines</div></div></div>
      <div class="welcome-step"><span class="welcome-step-num">4</span><div><div class="welcome-step-title">View Reports & Analytics</div><div class="welcome-step-sub">Monitor team velocity, workload and task completion rates</div></div></div>
    `;
  } else {
    document.getElementById('welcomeSubtitle').textContent='Your personal workspace is ready. Start organizing your tasks.';
    document.getElementById('welcomeRoleDesc').textContent='Personal dashboard + team tasks assigned to you';
    document.getElementById('welcomePrimaryBtn').textContent='👤 Go to Personal Dashboard';
    document.getElementById('welcomeSteps').innerHTML=`
      <div class="welcome-step"><span class="welcome-step-num">1</span><div><div class="welcome-step-title">Create a personal task</div><div class="welcome-step-sub">Click "+ Personal Task" on your Personal dashboard to add your first task</div></div></div>
      <div class="welcome-step"><span class="welcome-step-num">2</span><div><div class="welcome-step-title">Check team tasks</div><div class="welcome-step-sub">Switch to Finance Team tab to see tasks assigned to you by admin</div></div></div>
      <div class="welcome-step"><span class="welcome-step-num">3</span><div><div class="welcome-step-title">Use 📝 My Notes</div><div class="welcome-step-sub">Click "My Notes" button on Personal dashboard to jot down quick notes</div></div></div>
      <div class="welcome-step"><span class="welcome-step-num">4</span><div><div class="welcome-step-title">Try the Temp Board</div><div class="welcome-step-sub">Use 🧲 Temp Board in the sidebar to park tasks temporarily</div></div></div>
    `;
  }

  document.getElementById('welcomeModal').style.display='flex';
}

window.closeWelcome=function(goToDashboard){
  document.getElementById('welcomeModal').style.display='none';
  // Clear new-user flag
  if(currentUser)localStorage.removeItem('gf_newuser_'+currentUser.uid);
  localStorage.setItem('tf_toured','1');
  if(goToDashboard){
    const isAdm=currentUserProfile?.role==='admin';
    switchView('tasks');
    switchDashboard(isAdm?'team':'personal');
  }
};





document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.isContentEditable)return;
  if(e.key==='Escape'){closeTaskModal();closeDetail();closeCmdPalette();closeShortcuts();endTour();closeArchive();closeTemplates();closeComplianceModal();closeTempBoard();if(currentView==='notes'&&noteSaveTimer){clearTimeout(noteSaveTimer);autoSaveNote();}}
  if(e.key==='n'||e.key==='N'){if(currentView==='tasks'){if(currentDashboard==='personal')openTaskModal(null,'personal');else if(isAdmin())openTaskModal();}}
  if(e.key==='/'||e.key==='f'){document.getElementById('searchInput')?.focus();}
  if(e.key==='b'||e.key==='B'){toggleSidebar();}
  if(e.key==='t'||e.key==='T'){switchView('tasks');}
  if(e.key==='a'||e.key==='A'){switchView('activity');}
  if(e.key==='d'||e.key==='D'){toggleTheme();}
  if(e.key==='?'){showShortcuts();}
  if(e.key==='1'){setViewMode('board');}
  if(e.key==='2'){setViewMode('list');}
  if(e.key==='3'){setViewMode('calendar');}
  if(e.key==='4'){setViewMode('workload');}
  if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();openCmdPalette();}
});

// ── MOBILE SWIPE ──
let touchStartX=0,touchStartY=0;
document.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;},{passive:true});
document.addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-touchStartX;const dy=e.changedTouches[0].clientY-touchStartY;
  if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>50){
    if(dx>0&&document.getElementById('detailPanel').style.display==='flex'){closeDetail();}
    else if(dx<0&&window.innerWidth<=768){const sb=document.getElementById('mainSidebar');if(sb.classList.contains('mobile-open'))sb.classList.remove('mobile-open');}
  }
},{passive:true});

// ── PUSH NOTIFICATIONS ──
async function requestNotificationPermission(){
  if('Notification' in window&&Notification.permission==='default'){await Notification.requestPermission();}
}
function sendBrowserNotification(title,body){
  if('Notification' in window&&Notification.permission==='granted'){new Notification(title,{body,icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><rect width="32" height="32" rx="8" fill="%232563eb"/><text x="16" y="21" text-anchor="middle" fill="white" font-size="14" font-weight="bold">GF</text></svg>'});}
}
// Check overdue tasks every minute
setInterval(()=>{
  if(!currentUser)return;
  const now=new Date();
  const overdue=tasks.filter(t=>t.due&&new Date(t.due+'T00:00:00')<now&&t.status!=='done'&&!t.archived&&(t.assigneeId===currentUser.uid||isAdmin()));
  if(overdue.length>0){sendBrowserNotification('Ginesysone Finance Task Board','You have '+overdue.length+' overdue task'+(overdue.length>1?'s':'')+'!');}
},60000);

const savedEmail=localStorage.getItem('tf_email');if(savedEmail){try{const c=JSON.parse(savedEmail);emailjs.init(c.pubkey);}catch(e){}}
// Auto-init portal toggle to 'member' on load
selectedPortalRole='member';selectPortal('member');
window.openEmailConfig=openEmailConfig;

// Request notification permission on app load
setTimeout(requestNotificationPermission, 2000);
// Init notification badge on load
setTimeout(()=>{renderNotifBadge();renderNotifList();checkOverdueNotifs();},3000);
// Auto-switch to compliance view if opened via #compliance link
if(location.hash==='#compliance'){setTimeout(()=>switchView('compliance'),500);}
// Check overdue every hour
setInterval(checkOverdueNotifs,3600000);
</script>
</body>
</html>
