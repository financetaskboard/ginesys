<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TaskFlow Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,800&family=Instrument+Sans:wght@400;500;600&family=DM+Mono&display=swap" rel="stylesheet">
<style>
:root{--bg:#f7f3ee;--surface:#fff;--surface2:#f0ebe3;--border:#e2d9ce;--ink:#1c1712;--ink-mid:#6b5f52;--ink-dim:#a89e92;--accent:#b84a1a;--green:#2d7d4f;--red:#c41a2d;--radius:10px;--shadow:0 2px 12px rgba(28,23,18,.09);--shadow-lg:0 8px 32px rgba(28,23,18,.14)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Instrument Sans',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;font-size:14px}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px}

/* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
#authScreen{position:fixed;inset:0;background:linear-gradient(135deg,#1c1712 0%,#2d2018 50%,#1a1510 100%);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
.auth-box{background:#fff;border-radius:16px;padding:36px 32px;width:100%;max-width:420px;box-shadow:0 24px 64px rgba(0,0,0,.4)}
.auth-logo{display:flex;align-items:center;gap:10px;margin-bottom:28px}
.auth-logo-mark{width:36px;height:36px;background:var(--ink);color:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Fraunces',serif;font-weight:800;font-size:14px}
.auth-logo-text{font-family:'Fraunces',serif;font-weight:700;font-size:1.2rem}
.auth-title{font-family:'Fraunces',serif;font-size:1.5rem;font-weight:700;margin-bottom:4px}
.auth-sub{font-size:.82rem;color:var(--ink-mid);margin-bottom:24px}
.auth-tabs{display:flex;background:var(--surface2);border-radius:8px;padding:3px;margin-bottom:20px;gap:2px}
.auth-tab{flex:1;padding:7px;border:none;background:none;border-radius:6px;cursor:pointer;font-family:'Instrument Sans',sans-serif;font-size:.8rem;font-weight:600;color:var(--ink-mid);transition:all .15s}
.auth-tab.active{background:#fff;color:var(--ink);box-shadow:0 1px 4px rgba(0,0,0,.1)}
.fg{display:flex;flex-direction:column;gap:4px;margin-bottom:12px}
.fg label{font-size:.72rem;font-weight:600;color:var(--ink-mid)}
.input{width:100%;padding:9px 12px;background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;font-family:'Instrument Sans',sans-serif;font-size:.85rem;color:var(--ink);outline:none;transition:border-color .15s}
.input:focus{border-color:var(--ink);background:#fff}
select.input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b5f52' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
.btn{padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-family:'Instrument Sans',sans-serif;font-weight:600;font-size:.85rem;transition:all .15s;display:inline-flex;align-items:center;justify-content:center;gap:5px;width:100%}
.btn-primary{background:var(--ink);color:#fff}.btn-primary:hover{background:#2d2420}
.btn-ghost{background:transparent;border:1.5px solid var(--border);color:var(--ink-mid);width:auto}.btn-ghost:hover{border-color:var(--ink-mid);color:var(--ink)}
.btn-danger{background:var(--red);color:#fff;width:auto}
.btn-sm{padding:5px 11px;font-size:.75rem;width:auto}
.auth-err{color:var(--red);font-size:.76rem;margin-bottom:10px;display:none;background:#fce8eb;padding:8px 10px;border-radius:6px}
.auth-info{font-size:.74rem;color:var(--ink-dim);margin-top:14px;text-align:center;line-height:1.5}
.auth-info strong{color:var(--ink)}

/* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
#app{display:none}
.header{display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:56px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;gap:10px;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:9px}
.logo-mark{width:30px;height:30px;background:var(--ink);color:var(--bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:'Fraunces',serif;font-weight:800;font-size:12px}
.logo-text{font-family:'Fraunces',serif;font-weight:600;font-size:1.05rem}
.header-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.tabs{display:flex;gap:2px;background:var(--surface2);padding:3px;border-radius:8px}
.tab{padding:5px 12px;border:none;background:none;cursor:pointer;font-family:'Instrument Sans',sans-serif;font-size:.78rem;font-weight:500;color:var(--ink-mid);border-radius:5px;transition:all .15s}
.tab.active{background:var(--surface);color:var(--ink);box-shadow:0 1px 4px rgba(0,0,0,.1)}
.user-chip{display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 10px 4px 4px;font-size:.76rem;font-weight:600}
.role-badge{font-size:.6rem;padding:1px 6px;border-radius:99px;font-family:'DM Mono',monospace;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.role-admin{background:#fce8eb;color:var(--red)}
.role-member{background:#e0edf8;color:#1a5fa0}
.app-body{display:flex;height:calc(100vh - 56px);overflow:hidden}
.sidebar{width:200px;background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;flex-shrink:0;padding:14px 0}
.sidebar-section{padding:0 10px 16px}
.sidebar-label{font-family:'DM Mono',monospace;font-size:.6rem;color:var(--ink-dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:7px;padding:0 4px}
.filter-btn{width:100%;display:flex;align-items:center;gap:7px;padding:6px 8px;border-radius:6px;border:none;background:none;cursor:pointer;font-family:'Instrument Sans',sans-serif;font-size:.8rem;color:var(--ink-mid);text-align:left;transition:all .15s;margin-bottom:1px}
.filter-btn:hover{background:var(--surface2);color:var(--ink)}.filter-btn.active{background:var(--ink);color:#fff}
.fdot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.stat-card{background:var(--surface2);border-radius:8px;padding:9px;cursor:pointer;transition:background .15s}.stat-card:hover{background:var(--border)}
.stat-num{font-family:'Fraunces',serif;font-size:1.4rem;font-weight:600;line-height:1}
.stat-lbl{font-size:.62rem;color:var(--ink-dim);margin-top:1px;text-transform:uppercase;letter-spacing:.5px}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.toolbar{display:flex;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.search-wrap{position:relative;flex:1;min-width:140px;max-width:280px}
.search-input{width:100%;padding:6px 10px 6px 28px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;font-family:'Instrument Sans',sans-serif;font-size:.8rem;color:var(--ink);outline:none}
.search-input:focus{border-color:var(--ink);background:#fff}
.si{position:absolute;left:9px;top:50%;transform:translateY(-50%);font-size:.8rem}
.tc{font-size:.73rem;color:var(--ink-dim);font-family:'DM Mono',monospace;margin-left:auto;white-space:nowrap}
.grid-wrap{flex:1;overflow:auto;padding:16px}
.tasks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:11px}
.task-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:13px;cursor:pointer;transition:all .18s;animation:fu .2s ease forwards}
.task-card:hover{border-color:var(--ink);box-shadow:var(--shadow);transform:translateY(-2px)}
@keyframes fu{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:none}}
.ct{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:7px}
.card-title{font-weight:600;font-size:.86rem;line-height:1.35;margin-bottom:3px}
.card-desc{font-size:.74rem;color:var(--ink-mid);overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;margin-bottom:9px}
.cb{display:flex;align-items:center;justify-content:space-between;gap:6px}
.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:99px;font-size:.65rem;font-weight:600;font-family:'DM Mono',monospace;white-space:nowrap}
.avatar{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;flex-shrink:0;font-family:'Instrument Sans',sans-serif;text-shadow:0 1px 2px rgba(0,0,0,.3)}
.overlay{position:fixed;inset:0;background:rgba(28,23,18,.45);backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;z-index:200;padding:14px}
.modal{background:var(--surface);border-radius:13px;border:1px solid var(--border);box-shadow:var(--shadow-lg);width:100%;max-width:500px;max-height:92vh;overflow-y:auto;animation:si2 .18s ease}
@keyframes si2{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px 0}
.modal-title{font-family:'Fraunces',serif;font-size:1.05rem;font-weight:600}
.icon-btn{background:none;border:none;cursor:pointer;color:var(--ink-mid);font-size:.95rem;padding:4px 7px;border-radius:4px;line-height:1}.icon-btn:hover{background:var(--surface2)}
.form-body{padding:16px 18px 18px;display:flex;flex-direction:column;gap:11px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.form-actions{display:flex;justify-content:flex-end;gap:7px;padding-top:3px}
.form-error{color:var(--red);font-size:.76rem}
.detail-panel{width:380px;flex-shrink:0;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;animation:dp .2s ease}
@keyframes dp{from{opacity:0;transform:translateX(18px)}to{opacity:1;transform:none}}
.dh{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0}
.db{flex:1;overflow-y:auto;padding:16px}
.detail-title{font-family:'Fraunces',serif;font-size:1.2rem;font-weight:600;line-height:1.3;margin-bottom:12px}
.meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;background:var(--surface2);border-radius:9px;padding:12px;margin-bottom:12px}
.mi{display:flex;flex-direction:column;gap:3px}
.ml{font-size:.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--ink-dim);font-family:'DM Mono',monospace}
.ms{border:none;background:none;font-family:'Instrument Sans',sans-serif;font-size:.8rem;font-weight:600;color:var(--ink);cursor:pointer;padding:0;outline:none;width:100%}
.detail-desc{font-size:.81rem;color:var(--ink-mid);line-height:1.6;margin-bottom:16px}
.stitle{font-size:.62rem;text-transform:uppercase;letter-spacing:1px;color:var(--ink-dim);font-family:'DM Mono',monospace;margin-bottom:8px}
.comments-list{display:flex;flex-direction:column;gap:9px;margin-bottom:12px}
.cmt{display:flex;gap:7px}.cmtb{flex:1}.cmth{display:flex;align-items:center;gap:5px;margin-bottom:2px}
.ca{font-weight:600;font-size:.78rem}.ct2{font-size:.66rem;color:var(--ink-dim);font-family:'DM Mono',monospace}
.cdel{margin-left:auto;font-size:.66rem;color:var(--red);border:none;background:none;cursor:pointer}
.cmtt{font-size:.79rem;color:var(--ink-mid);line-height:1.5}
.cform{display:flex;gap:7px;align-items:flex-start;margin-bottom:18px}
.cwrap{flex:1;display:flex;flex-direction:column;gap:4px}
.alist{display:flex;flex-direction:column;gap:6px}
.ait{display:flex;align-items:baseline;gap:6px}
.adot{width:6px;height:6px;background:var(--border);border-radius:50%;flex-shrink:0}
.atxt{font-size:.76rem;color:var(--ink-mid);flex:1;line-height:1.4}
.atime{font-size:.64rem;color:var(--ink-dim);font-family:'DM Mono',monospace;white-space:nowrap}
.feed-page{flex:1;overflow-y:auto;padding:22px;max-width:650px}
.pg-title{font-family:'Fraunces',serif;font-size:1.35rem;font-weight:600;margin-bottom:3px}
.pg-sub{font-size:.81rem;color:var(--ink-dim);margin-bottom:20px}
.feed-item{display:flex;align-items:baseline;gap:11px;padding:10px 0;border-bottom:1px solid var(--border)}
.fc{flex:1;font-size:.81rem;line-height:1.5}
.fact{font-weight:600}.fac{color:var(--ink-mid)}
.ftl{color:var(--accent);cursor:pointer;text-decoration:underline;border:none;background:none;font-family:inherit;font-size:inherit;padding:0}
.ftime{font-size:.66rem;color:var(--ink-dim);font-family:'DM Mono',monospace;white-space:nowrap}
.team-page{flex:1;overflow-y:auto;padding:22px}
.team-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:11px;margin-top:16px}
.mc{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;display:flex;align-items:center;gap:11px}
.mn{font-weight:600;font-size:.88rem}.me{font-size:.73rem;color:var(--ink-dim);margin-top:1px}.ms2{font-size:.71rem;color:var(--ink-mid);margin-top:2px}
.mact{display:flex;flex-direction:column;gap:3px;margin-left:auto}
.priority-group{flex:1;min-width:220px;min-height:100px}.priority-group-header{display:flex;align-items:center;gap:7px;margin-bottom:10px;padding:8px 10px;border-radius:8px}.priority-group-title{font-family:'Fraunces',serif;font-size:1rem;font-weight:700}.priority-group-count{font-family:'DM Mono',monospace;font-size:.68rem;padding:2px 8px;border-radius:99px;font-weight:700}.priority-group-toggle{margin-left:auto;font-size:.72rem;color:var(--ink-dim);border:none;background:none;cursor:pointer;font-family:'Instrument Sans',sans-serif}.pg-tasks{display:flex;flex-direction:column;gap:9px;margin-top:2px}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;min-height:240px;gap:9px;color:var(--ink-dim)}
.ei{font-size:2.3rem}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--green);flex-shrink:0;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
.sync-label{font-size:.7rem;color:var(--ink-dim);font-family:'DM Mono',monospace;display:flex;align-items:center;gap:4px}
.toast{position:fixed;bottom:20px;right:20px;background:var(--ink);color:#fff;padding:10px 16px;border-radius:8px;font-size:.8rem;z-index:999;animation:toastin .3s ease;max-width:320px}
@keyframes toastin{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.info-box{background:#e8f4fd;border:1px solid #b3d9f5;border-radius:8px;padding:10px 12px;font-size:.76rem;color:#1a5fa0;line-height:1.5}
.warn-box{background:#fef9e0;border:1px solid #f5e070;border-radius:8px;padding:10px 12px;font-size:.76rem;color:#8a6800;line-height:1.5}
.report-page{flex:1;overflow-y:auto;padding:22px;display:flex;flex-direction:column;gap:16px;height:100%}
.report-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
.report-summary{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:9px}
.rs-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px;text-align:center}
.rs-num{font-family:'Fraunces',serif;font-size:1.6rem;font-weight:700;line-height:1}
.rs-lbl{font-size:.65rem;color:var(--ink-dim);margin-top:3px;text-transform:uppercase;letter-spacing:.5px}
.report-table-wrap{flex:1;overflow:auto;border:1px solid var(--border);border-radius:var(--radius);background:var(--surface)}
.report-table{width:100%;border-collapse:collapse;font-size:.8rem}
.report-table thead{position:sticky;top:0;z-index:2}
.report-table th{background:var(--ink);color:#fff;padding:10px 13px;text-align:left;font-family:'DM Mono',monospace;font-size:.65rem;text-transform:uppercase;letter-spacing:.7px;white-space:nowrap}
.report-table td{padding:9px 13px;border-bottom:1px solid var(--border);vertical-align:middle}
.report-table tbody tr:hover{background:var(--surface2)}
.report-table tbody tr:last-child td{border-bottom:none}
.rt-sno{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--ink-dim);font-weight:600}
.rt-name{display:flex;align-items:center;gap:7px;font-weight:600;font-size:.82rem}
.rt-task{font-weight:500;max-width:200px}
.rt-date{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--ink-mid);white-space:nowrap}
.rt-delay-ok{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--green);font-weight:700}
.rt-delay-warn{font-family:'DM Mono',monospace;font-size:.72rem;color:#c4921a;font-weight:700}
.rt-delay-bad{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--red);font-weight:700}
.rt-delay-na{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--ink-dim)}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="authScreen">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="auth-logo-mark">TF</div>
      <span class="auth-logo-text">TaskFlow Pro</span>
    </div>
    <div class="auth-title" id="authTitle">Welcome back</div>
    <div class="auth-sub" id="authSub">Sign in to your team workspace</div>

    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
    </div>

    <div id="authErr" class="auth-err"></div>

    <!-- LOGIN FORM -->
    <div id="loginForm">
      <div class="fg"><label>Email</label><input class="input" id="loginEmail" type="email" placeholder="you@company.com"></div>
      <div class="fg"><label>Password</label><input class="input" id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <button class="btn btn-primary" onclick="doLogin()" style="margin-top:6px">Sign In ‚Üí</button>
    </div>

    <!-- REGISTER FORM -->
    <div id="registerForm" style="display:none">
      <div class="fg"><label>Full Name</label><input class="input" id="regName" placeholder="Jane Smith"></div>
      <div class="fg"><label>Email</label><input class="input" id="regEmail" type="email" placeholder="you@company.com"></div>
      <div class="fg"><label>Password</label><input class="input" id="regPassword" type="password" placeholder="Min 6 characters"></div>
      <div class="fg"><label>Role</label>
        <select class="input" id="regRole">
          <option value="member">Team Member</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="doRegister()" style="margin-top:6px">Create Account ‚Üí</button>
    </div>

    <div class="auth-info">
      üîê Secured by Firebase Authentication<br>
      <strong>Admin</strong> can create/assign/delete tasks &amp; manage team<br>
      <strong>Member</strong> can view tasks, update status &amp; comment
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">
<div class="header">
  <div class="logo">
    <div class="logo-mark">TF</div>
    <span class="logo-text">TaskFlow Pro</span>
  </div>
  <div class="header-right">
    <div class="tabs">
      <button class="tab active" onclick="switchView('tasks')">Tasks</button>
      <button class="tab" onclick="switchView('activity')">Activity</button>
      <button class="tab" id="teamTab" onclick="switchView('team')">Team</button>
      <button class="tab" id="reportTab" onclick="switchView('report')">üìä Report</button>
    </div>
    <div class="user-chip" id="userChip">
      <div id="userAvatar"></div>
      <span id="userName"></span>
      <span class="role-badge" id="userRoleBadge"></span>
    </div>
    <div class="sync-label"><span class="sync-dot"></span> Live</div>
    <button class="btn btn-ghost btn-sm" onclick="doLogout()">Sign Out</button>
  </div>
</div>

<div class="app-body">
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Overview</div>
      <div class="stat-grid" id="statsGrid"></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label" id="breakdownLabel">Priority Breakdown</div>
      <div class="stat-grid" id="priorityGrid"></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Status</div>
      <button class="filter-btn" onclick="tf('status','todo')"><span class="fdot" style="background:#6b5f52"></span>To Do</button>
      <button class="filter-btn" onclick="tf('status','in_progress')"><span class="fdot" style="background:#1a5fa0"></span>In Progress</button>
      <button class="filter-btn" onclick="tf('status','review')"><span class="fdot" style="background:#6b3fa0"></span>In Review</button>
      <button class="filter-btn" onclick="tf('status','done')"><span class="fdot" style="background:#2d7d4f"></span>Done</button>
    </div>
    <div class="sidebar-section" id="teamFilterSection">
      <div class="sidebar-label">Team</div>
      <div id="teamFilters"></div>
    </div>
  </aside>

  <main class="main">
    <div id="tasksView">
      <div class="toolbar">
        <div class="search-wrap"><span class="si">üîç</span><input class="search-input" id="searchInput" placeholder="Search tasks‚Ä¶" oninput="renderTasks()"></div>
        <button class="btn btn-ghost btn-sm" id="cfBtn" onclick="clearFilters()" style="display:none">‚úï Clear</button>
        <span class="tc" id="taskCount"></span>
        <button class="btn btn-primary btn-sm" id="newTaskBtn" onclick="openTaskModal()" style="margin-left:auto">+ New Task</button>
      </div>
      <div class="grid-wrap">
        <div id="tasksGrouped" style="display:flex;gap:14px;align-items:flex-start;min-width:max-content;height:100%"></div>
        <div class="empty" id="emptyState" style="display:none"><div class="ei">üìã</div><p>No tasks found.</p></div>
      </div>
    </div>

    <div id="activityView" style="display:none;flex:1;overflow:hidden">
      <div class="feed-page">
        <div class="pg-title">Activity Feed</div>
        <div class="pg-sub" id="activitySubtitle">Everything that's happened across all tasks</div>
        <div id="feedList"></div>
      </div>
    </div>

    <div id="teamView" style="display:none;flex:1;overflow:hidden">
      <div class="team-page">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
          <div><div class="pg-title">Team Members</div><div class="pg-sub">Registered users in your workspace</div></div>
        </div>
        <div id="teamGrid" class="team-grid"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê REPORT VIEW ‚ïê‚ïê -->
    <div id="reportView" style="display:none;flex:1;overflow:hidden">
      <div class="report-page">
        <div class="report-header">
          <div>
            <div class="pg-title">üìä Task Report</div>
            <div class="pg-sub">Track task progress, assignments &amp; delays</div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="exportReportCSV()" style="width:auto">‚¨á Export CSV</button>
        </div>

        <!-- FILTERS -->
        <div style="display:flex;gap:9px;flex-wrap:wrap;align-items:flex-end;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px">
          <div class="fg" style="min-width:150px;margin:0">
            <label style="font-size:.68rem;font-weight:600;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.5px">Member</label>
            <select class="input" id="reportMemberFilter" onchange="renderReport()" style="margin-top:3px">
              <option value="">All Members</option>
            </select>
          </div>
          <div class="fg" style="min-width:130px;margin:0">
            <label style="font-size:.68rem;font-weight:600;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.5px">Status</label>
            <select class="input" id="reportStatusFilter" onchange="renderReport()" style="margin-top:3px">
              <option value="">All Status</option>
              <option value="todo">To Do</option>
              <option value="in_progress">In Progress</option>
              <option value="review">In Review</option>
              <option value="done">Done</option>
            </select>
          </div>
          <div class="fg" style="min-width:130px;margin:0">
            <label style="font-size:.68rem;font-weight:600;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.5px">Priority</label>
            <select class="input" id="reportPriorityFilter" onchange="renderReport()" style="margin-top:3px">
              <option value="">All Priorities</option>
              <option value="critical">üî¥ Critical</option>
              <option value="high">üü† High</option>
              <option value="medium">üü° Medium</option>
              <option value="low">üü¢ Low</option>
            </select>
          </div>
          <div class="fg" style="min-width:140px;margin:0">
            <label style="font-size:.68rem;font-weight:600;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.5px">Assigned From</label>
            <input class="input" type="date" id="reportDateFrom" onchange="renderReport()" style="margin-top:3px">
          </div>
          <div class="fg" style="min-width:140px;margin:0">
            <label style="font-size:.68rem;font-weight:600;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.5px">Assigned To</label>
            <input class="input" type="date" id="reportDateTo" onchange="renderReport()" style="margin-top:3px">
          </div>
          <button class="btn btn-ghost btn-sm" onclick="clearReportFilters()" style="margin-top:18px">‚úï Clear</button>
        </div>

        <!-- SUMMARY CARDS -->
        <div class="report-summary" id="reportSummary"></div>

        <!-- TABLE -->
        <div class="report-table-wrap">
          <table class="report-table" id="reportTable" style="display:none">
            <thead>
              <tr>
                <th>S.No</th>
                <th>Member Name</th>
                <th>Task Name</th>
                <th>Task Type</th>
                <th>Assigned Date</th>
                <th>Finished Date</th>
                <th>Delay Days</th>
              </tr>
            </thead>
            <tbody id="reportBody"></tbody>
          </table>
          <div class="empty" id="reportEmpty" style="display:none"><div class="ei">üìä</div><p>No tasks match the filters.</p></div>
        </div>
      </div>
    </div>
  </main>

  <div class="detail-panel" id="detailPanel" style="display:none"></div>
</div>
</div>

<!-- REPORT VIEW injected into main via JS -->

<!-- TASK MODAL -->
<div class="overlay" id="taskModal" style="display:none" onclick="if(event.target===this)closeTaskModal()">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="tmTitle">New Task</div>
      <button class="icon-btn" onclick="closeTaskModal()">‚úï</button>
    </div>
    <div class="form-body">
      <input type="hidden" id="editId">
      <div class="fg"><label>Title *</label><input class="input" id="tTitle" placeholder="What needs to be done?"></div>
      <div class="fg"><label>Description</label><textarea class="input" id="tDesc" placeholder="Add more context‚Ä¶" style="min-height:65px;resize:vertical"></textarea></div>
      <div class="form-row">
        <div class="fg"><label>Status</label>
          <select class="input" id="tStatus">
            <option value="todo">To Do</option><option value="in_progress">In Progress</option>
            <option value="review">In Review</option><option value="done">Done</option>
          </select>
        </div>
        <div class="fg"><label>Priority</label>
          <select class="input" id="tPriority">
            <option value="critical">üî¥ Critical</option><option value="high">üü† High</option>
            <option value="medium" selected>üü° Medium</option><option value="low">üü¢ Low</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="fg"><label>Assign To</label><select class="input" id="tAssignee"><option value="">‚Äî Unassigned ‚Äî</option></select></div>
        <div class="fg"><label>Due Date</label><input class="input" type="date" id="tDue"></div>
      </div>
      <div class="fg">
        <label>üìß Send email notification to assignee</label>
        <div class="warn-box" id="emailNote">EmailJS must be configured below for emails to send. Once set up, assignee gets an email automatically!</div>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeTaskModal()" style="width:auto">Cancel</button>
        <button class="btn btn-primary" onclick="saveTask()" style="width:auto">Save Task</button>
      </div>
    </div>
  </div>
</div>

<!-- EMAILJS CONFIG MODAL -->
<div class="overlay" id="emailModal" style="display:none" onclick="if(event.target===this)closeEmailModal()">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">üìß Configure Email Notifications</div>
      <button class="icon-btn" onclick="closeEmailModal()">‚úï</button>
    </div>
    <div class="form-body">
      <div class="info-box">
        <strong>How to get free EmailJS keys:</strong><br>
        1. Go to <strong>emailjs.com</strong> ‚Üí Sign up free<br>
        2. Add an <strong>Email Service</strong> (Gmail/Outlook) ‚Üí copy <strong>Service ID</strong><br>
        3. Create an <strong>Email Template</strong> ‚Üí copy <strong>Template ID</strong><br>
        4. Go to <strong>Account ‚Üí API Keys</strong> ‚Üí copy <strong>Public Key</strong><br>
        Template variables to use: <code>{{to_name}}</code>, <code>{{task_title}}</code>, <code>{{task_priority}}</code>, <code>{{task_due}}</code>, <code>{{assigned_by}}</code>
      </div>
      <div class="fg"><label>EmailJS Public Key</label><input class="input" id="ej_pubkey" placeholder="user_xxxxxxxxxx"></div>
      <div class="form-row">
        <div class="fg"><label>Service ID</label><input class="input" id="ej_service" placeholder="service_xxxxxxx"></div>
        <div class="fg"><label>Template ID</label><input class="input" id="ej_template" placeholder="template_xxxxxxx"></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeEmailModal()" style="width:auto">Cancel</button>
        <button class="btn btn-primary" onclick="saveEmailConfig()" style="width:auto">Save Email Config</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase + EmailJS SDKs -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged }
  from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { getDatabase, ref, set, onValue, push, remove, update }
  from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

// ‚îÄ‚îÄ YOUR FIREBASE CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAzXRyASLi6DadFqFdb80iipyKezO5byd4",
  authDomain: "task-flow-65be7.firebaseapp.com",
  databaseURL: "https://task-flow-65be7-default-rtdb.firebaseio.com",
  projectId: "task-flow-65be7",
  appId: "1:572271775582:web:88dddc228c5511a9b409cf"
};

const app = initializeApp(FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getDatabase(app);

// ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const P={critical:{label:'Critical',color:'#c41a2d',bg:'#fce8eb',icon:'üî¥'},high:{label:'High',color:'#c4501a',bg:'#fceae3',icon:'üü†'},medium:{label:'Medium',color:'#c4921a',bg:'#fcf0e0',icon:'üü°'},low:{label:'Low',color:'#2d7d4f',bg:'#e0f5ea',icon:'üü¢'}};
const S={todo:{label:'To Do',color:'#6b5f52',bg:'#f0ebe3'},in_progress:{label:'In Progress',color:'#1a5fa0',bg:'#e0edf8'},review:{label:'In Review',color:'#6b3fa0',bg:'#ece5f5'},done:{label:'Done',color:'#2d7d4f',bg:'#e0f5ea'}};
const COLORS=['#2d7d4f','#c4501a','#1a5fa0','#c4921a','#6b3fa0','#c41a2d','#2d5f7d','#7d2d5f'];
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2);
const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const gi=n=>n?n.split(' ').map(p=>p[0]).join('').toUpperCase().slice(0,2):'?';
const av=(m,sz)=>`<div class="avatar" style="width:${sz}px;height:${sz}px;background:${m?.color||'#999'};font-size:${sz*.34}px">${gi(m?.name||'?')}</div>`;
function fd(d){if(!d)return null;const dt=new Date(d+'T00:00:00'),now=new Date(),diff=Math.ceil((dt-now)/86400000);if(diff<0)return{text:`${Math.abs(diff)}d overdue`,cls:'overdue'};if(diff===0)return{text:'Due today',cls:'warning'};if(diff===1)return{text:'Due tomorrow',cls:'warning'};return{text:dt.toLocaleDateString('en-IN',{month:'short',day:'numeric'}),cls:''}}
function ta(ts){const d=Math.floor((Date.now()-ts)/1000);if(d<60)return'just now';if(d<3600)return`${Math.floor(d/60)}m ago`;if(d<86400)return`${Math.floor(d/3600)}h ago`;return`${Math.floor(d/86400)}d ago`}

function toast(msg,dur=3000){
  const t=document.createElement('div');t.className='toast';t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),dur);
}

// ‚îÄ‚îÄ state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let members=[],tasks=[],activity=[],currentUser=null,currentUserProfile=null;
let filters={status:'',priority:'',assignee:''},currentView='tasks',openDetailId=null;

// ‚îÄ‚îÄ expose globals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.switchAuthTab=switchAuthTab;window.doLogin=doLogin;window.doRegister=doRegister;window.doLogout=doLogout;
window.openTaskModal=openTaskModal;window.closeTaskModal=closeTaskModal;window.saveTask=saveTask;
window.openDetail=openDetail;window.closeDetail=closeDetail;window.deleteTask=deleteTask;
window.qu=qu;window.postComment=postComment;window.delComment=delComment;
window.tf=tf;window.clearFilters=clearFilters;window.switchView=switchView;window.toggleGroup=toggleGroup;window.renderReport=renderReport;window.exportReportCSV=exportReportCSV;
window.closeEmailModal=closeEmailModal;window.saveEmailConfig=saveEmailConfig;
window.openEmailConfig=openEmailConfig;
window.clearReportFilters=clearReportFilters;
window.exportReportCSV=exportReportCSV;

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchAuthTab(tab){
  document.getElementById('loginForm').style.display=tab==='login'?'block':'none';
  document.getElementById('registerForm').style.display=tab==='register'?'block':'none';
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',['login','register'][i]===tab));
  document.getElementById('authTitle').textContent=tab==='login'?'Welcome back':'Create account';
  document.getElementById('authSub').textContent=tab==='login'?'Sign in to your team workspace':'Join your team workspace';
  document.getElementById('authErr').style.display='none';
}

async function doLogin(){
  const email=document.getElementById('loginEmail').value.trim();
  const password=document.getElementById('loginPassword').value;
  const err=document.getElementById('authErr');
  if(!email||!password){err.textContent='Please fill in all fields.';err.style.display='block';return;}
  try{
    await signInWithEmailAndPassword(auth,email,password);
  }catch(e){
    err.textContent=e.code==='auth/invalid-credential'?'Invalid email or password.':e.message;
    err.style.display='block';
  }
}

async function doRegister(){
  const name=document.getElementById('regName').value.trim();
  const email=document.getElementById('regEmail').value.trim();
  const password=document.getElementById('regPassword').value;
  const role=document.getElementById('regRole').value;
  const err=document.getElementById('authErr');
  if(!name||!email||!password){err.textContent='Please fill in all fields.';err.style.display='block';return;}
  try{
    const cred=await createUserWithEmailAndPassword(auth,email,password);
    const colorIdx=Math.floor(Math.random()*COLORS.length);
    await set(ref(db,`members/${cred.user.uid}`),{
      name,email,role,color:COLORS[colorIdx],createdAt:Date.now()
    });
  }catch(e){
    err.textContent=e.code==='auth/email-already-in-use'?'Email already registered.':e.message;
    err.style.display='block';
  }
}

async function doLogout(){
  await signOut(auth);
}

// ‚îÄ‚îÄ Auth state listener ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth, user=>{
  if(user){
    currentUser=user;
    document.getElementById('authScreen').style.display='none';
    document.getElementById('app').style.display='block';
    subscribeAll();
  } else {
    currentUser=null;currentUserProfile=null;
    document.getElementById('authScreen').style.display='flex';
    document.getElementById('app').style.display='none';
  }
});

// ‚îÄ‚îÄ Firebase subscriptions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function subscribeAll(){
  onValue(ref(db,'members'),snap=>{
    const val=snap.val()||{};
    members=Object.entries(val).map(([id,v])=>({id,...v}));
    currentUserProfile=members.find(m=>m.id===currentUser?.uid)||null;
    updateUserHeader();
    renderAll();
  });
  onValue(ref(db,'tasks'),snap=>{
    const val=snap.val()||{};
    const VALID_P=['critical','high','medium','low'];
    const VALID_S=['todo','in_progress','review','done'];
    tasks=Object.entries(val).map(([id,v])=>({
      id,...v,
      priority:VALID_P.includes(v.priority)?v.priority:'medium',
      status:VALID_S.includes(v.status)?v.status:'todo'
    }));
    renderAll();if(openDetailId)renderDetail();
  });
  onValue(ref(db,'activity'),snap=>{
    const val=snap.val()||{};
    activity=Object.entries(val).map(([id,v])=>({id,...v})).sort((a,b)=>b.ts-a.ts).slice(0,300);
    renderActivity();
  });
}

function updateUserHeader(){
  if(!currentUserProfile)return;
  const m=currentUserProfile;
  document.getElementById('userAvatar').innerHTML=av(m,22);
  document.getElementById('userName').textContent=m.name.split(' ')[0];
  const rb=document.getElementById('userRoleBadge');
  rb.textContent=m.role==='admin'?'Admin':'Member';
  rb.className='role-badge '+(m.role==='admin'?'role-admin':'role-member');
  // show/hide admin-only UI
  const isAdmin=m.role==='admin';
  document.getElementById('newTaskBtn').style.display=isAdmin?'':'none';
  document.getElementById('teamTab').style.display=isAdmin?'':'none';
  const tfs=document.getElementById('teamFilterSection');if(tfs)tfs.style.display=isAdmin?'':'none';
  
  const rt=document.getElementById('reportTab');if(rt)rt.style.display=isAdmin?'':'none';
}

const isAdmin=()=>currentUserProfile?.role==='admin';

// ‚îÄ‚îÄ EmailJS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getEmailConfig(){
  const s=localStorage.getItem('tf_email');
  return s?JSON.parse(s):null;
}
function openEmailConfig(){document.getElementById('emailModal').style.display='flex';}
function closeEmailModal(){document.getElementById('emailModal').style.display='none';}
function saveEmailConfig(){
  const cfg={pubkey:document.getElementById('ej_pubkey').value.trim(),service:document.getElementById('ej_service').value.trim(),template:document.getElementById('ej_template').value.trim()};
  if(!cfg.pubkey||!cfg.service||!cfg.template){alert('Please fill all fields.');return;}
  localStorage.setItem('tf_email',JSON.stringify(cfg));
  emailjs.init(cfg.pubkey);
  toast('‚úÖ Email config saved!');closeEmailModal();
  document.getElementById('emailNote').className='info-box';
  document.getElementById('emailNote').textContent='‚úÖ EmailJS configured! Assignees will receive email notifications.';
}

async function sendTaskEmail(task,assigneeMember){
  const cfg=getEmailConfig();
  if(!cfg||!assigneeMember?.email)return;
  try{
    emailjs.init(cfg.pubkey);
    await emailjs.send(cfg.service,cfg.template,{
      to_email:assigneeMember.email,
      to_name:assigneeMember.name,
      task_title:task.title,
      task_description:task.description||'No description',
      task_priority:P[task.priority]?.label||task.priority,
      task_status:S[task.status]?.label||task.status,
      task_due:task.due||'No due date',
      assigned_by:currentUserProfile?.name||'Admin',
    });
    toast(`üìß Email sent to ${assigneeMember.name}!`);
  }catch(e){
    toast('‚ö†Ô∏è Email failed: '+e.text||e.message);
  }
}

// ‚îÄ‚îÄ write helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function log(tid,mid,detail){await push(ref(db,'activity'),{taskId:tid,memberId:mid,detail,ts:Date.now()});}

// ‚îÄ‚îÄ render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll(){renderSidebar();renderTasks();renderActivity();renderTeam();if(currentView==='report')renderReport();}

function renderSidebar(){
  // for members, scope stats to their own tasks only
  const scopedTasks=isAdmin()?tasks:tasks.filter(t=>t.assigneeId===currentUser?.uid);
  const counts={};Object.keys(S).forEach(s=>counts[s]=0);scopedTasks.forEach(t=>counts[t.status]=(counts[t.status]||0)+1);
  const overdue=scopedTasks.filter(t=>t.due&&new Date(t.due+'T00:00:00')<new Date()&&t.status!=='done').length;
  const pCounts={};Object.keys(P).forEach(p=>pCounts[p]=0);scopedTasks.forEach(t=>pCounts[t.priority]=(pCounts[t.priority]||0)+1);

  // Status stats
  let h=`<div class="stat-card" onclick="clearFilters()"><div class="stat-num">${scopedTasks.length}</div><div class="stat-lbl">${isAdmin()?'Total':'My Tasks'}</div></div>`;
  Object.entries(S).forEach(([k,v])=>h+=`<div class="stat-card" onclick="tf('status','${k}')"><div class="stat-num" style="color:${v.color}">${counts[k]||0}</div><div class="stat-lbl">${v.label}</div></div>`);
  if(overdue>0)h+=`<div class="stat-card" style="grid-column:span 2"><div class="stat-num" style="color:#c41a2d">${overdue}</div><div class="stat-lbl">Overdue</div></div>`;
  document.getElementById('statsGrid').innerHTML=h;

  // Priority breakdown (admin) or Status breakdown (member)
  if(isAdmin()){
    document.getElementById('breakdownLabel').textContent='Priority Breakdown';
    let ph='';
    Object.entries(P).forEach(([k,v])=>ph+=`<div class="stat-card" onclick="tf('priority','${k}')"><div class="stat-num" style="color:${v.color}">${pCounts[k]||0}</div><div class="stat-lbl">${v.icon} ${v.label}</div></div>`);
    document.getElementById('priorityGrid').innerHTML=ph;
  } else {
    document.getElementById('breakdownLabel').textContent='Status Breakdown';
    let sh='';
    Object.entries(S).forEach(([k,v])=>sh+=`<div class="stat-card" onclick="tf('status','${k}')"><div class="stat-num" style="color:${v.color}">${counts[k]||0}</div><div class="stat-lbl">${v.label}</div></div>`);
    document.getElementById('priorityGrid').innerHTML=sh;
  }
  document.getElementById('teamFilters').innerHTML=members.map(m=>{
    const open=tasks.filter(t=>t.assigneeId===m.id&&t.status!=='done').length;
    return`<button class="filter-btn ${filters.assignee===m.id?'active':''}" onclick="tf('assignee','${m.id}')">${av(m,20)}<span style="flex:1">${esc(m.name.split(' ')[0])}</span><span style="font-family:'DM Mono';font-size:.66rem;background:rgba(0,0,0,.07);padding:1px 5px;border-radius:99px">${open}</span></button>`;
  }).join('');
}

function tf(type,val){filters[type]=filters[type]===val?'':val;document.getElementById('cfBtn').style.display=Object.values(filters).some(v=>v)||document.getElementById('searchInput').value?'':'none';renderSidebar();renderTasks();}
function clearFilters(){filters={status:'',priority:'',assignee:''};document.getElementById('searchInput').value='';document.getElementById('cfBtn').style.display='none';renderSidebar();renderTasks();}

function getFiltered(){
  const q=document.getElementById('searchInput').value.toLowerCase();
  const po={critical:0,high:1,medium:2,low:3};
  let list=tasks;
  // members only see their tasks + unassigned
  if(!isAdmin())list=tasks.filter(t=>!t.assigneeId||t.assigneeId===currentUser?.uid);
  return list.filter(t=>{
    if(filters.status&&t.status!==filters.status)return false;
    if(filters.priority&&t.priority!==filters.priority)return false;
    if(filters.assignee&&t.assigneeId!==filters.assignee)return false;
    if(q&&!t.title.toLowerCase().includes(q)&&!(t.description||'').toLowerCase().includes(q))return false;
    return true;
  }).sort((a,b)=>(po[a.priority]||2)-(po[b.priority]||2)||b.ts-a.ts);
}

function fmtDate(ts){
  if(!ts)return null;
  const d=new Date(ts);
  return d.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
}

function taskCardHtml(t){
  const p=P[t.priority]||P.medium,s_=S[t.status]||S.todo,assignee=members.find(m=>m.id===t.assigneeId),due=fd(t.due);
  const cmtCount=t.comments&&typeof t.comments==='object'?Object.keys(t.comments).length:0;
  const assignedDate=t.assignedAt?fmtDate(t.assignedAt):t.assigneeId&&t.ts?fmtDate(t.ts):null;
  return`<div class="task-card" onclick="openDetail('${t.id}')">
    <div class="ct"><span class="badge" style="color:${s_.color};background:${s_.bg}">${s_.label}</span></div>
    <div class="card-title">${esc(t.title)}</div>
    ${t.description?`<div class="card-desc">${esc(t.description)}</div>`:''}
    <div class="cb">
      ${assignee?`<div style="display:flex;align-items:center;gap:5px;font-size:.72rem;color:var(--ink-mid)">${av(assignee,19)}<span>${esc(assignee.name)}</span></div>`:'<span style="font-size:.72rem;color:var(--ink-dim);font-style:italic">Unassigned</span>'}
      <div style="display:flex;align-items:center;gap:6px">
        ${cmtCount>0?`<span style="font-size:.68rem;color:var(--ink-dim)">üí¨${cmtCount}</span>`:''}
        ${due?`<span style="font-size:.68rem;font-family:'DM Mono',monospace;color:${due.cls==='overdue'?'#c41a2d':due.cls==='warning'?'#c4921a':'var(--ink-dim)'}">${due.text}</span>`:''}
      </div>
    </div>
    ${assignedDate?`<div style="margin-top:7px;padding-top:7px;border-top:1px solid var(--border);display:flex;align-items:center;gap:4px"><span style="font-size:.62rem;color:var(--ink-dim);font-family:'DM Mono',monospace">üìÖ Assigned</span><span style="font-size:.62rem;font-family:'DM Mono',monospace;color:var(--ink-mid);font-weight:600">${assignedDate}</span></div>`:''}
  </div>`;
}

function renderTasks(){
  if(currentView!=='tasks')return;
  const f=getFiltered(),grouped=document.getElementById('tasksGrouped'),empty=document.getElementById('emptyState');
  const hasF=Object.values(filters).some(v=>v)||document.getElementById('searchInput').value;
  document.getElementById('cfBtn').style.display=hasF?'':'none';
  document.getElementById('taskCount').textContent=`${f.length} task${f.length!==1?'s':''}`;
  if(f.length===0){grouped.innerHTML='';empty.style.display='flex';return;}
  empty.style.display='none';

  if(isAdmin()){
    // Admin: Group by priority
    const groups=[['critical','Critical'],['high','High'],['medium','Medium'],['low','Low']];
    grouped.innerHTML=groups.map(([pk,pl])=>{
      const pts=f.filter(t=>t.priority===pk);
      if(pts.length===0)return'';
      const pInfo=P[pk];
      return`<div class="priority-group" id="pg_${pk}" style="width:280px;flex-shrink:0">
        <div class="priority-group-header" style="background:${pInfo.bg}">
          <span style="font-size:1rem">${pInfo.icon}</span>
          <span class="priority-group-title" style="color:${pInfo.color}">${pl} Priority</span>
          <span class="priority-group-count" style="background:${pInfo.bg};color:${pInfo.color}">${pts.length} task${pts.length!==1?'s':''}</span>
          <button class="priority-group-toggle" onclick="toggleGroup('${pk}')">‚ñæ collapse</button>
        </div>
        <div class="pg-tasks" id="pgt_${pk}">${pts.map(t=>taskCardHtml(t)).join('')}</div>
      </div>`;
    }).join('');
  } else {
    // Member: Group by status
    const statusGroups=[['todo','To Do'],['in_progress','In Progress'],['review','In Review'],['done','Done']];
    grouped.innerHTML=statusGroups.map(([sk,sl])=>{
      const sts=f.filter(t=>t.status===sk);
      if(sts.length===0)return'';
      const sInfo=S[sk];
      const bgMap={todo:'#f5f2ee',in_progress:'#e8f1fb',review:'#f0eaf8',done:'#e6f4ec'};
      const bg=bgMap[sk]||'#f5f2ee';
      return`<div class="priority-group" id="pg_${sk}" style="width:280px;flex-shrink:0">
        <div class="priority-group-header" style="background:${bg}">
          <span style="width:10px;height:10px;border-radius:50%;background:${sInfo.color};display:inline-block;flex-shrink:0"></span>
          <span class="priority-group-title" style="color:${sInfo.color}">${sl}</span>
          <span class="priority-group-count" style="background:${bg};color:${sInfo.color}">${sts.length} task${sts.length!==1?'s':''}</span>
          <button class="priority-group-toggle" onclick="toggleGroup('${sk}')">‚ñæ collapse</button>
        </div>
        <div class="pg-tasks" id="pgt_${sk}">${sts.map(t=>taskCardHtml(t)).join('')}</div>
      </div>`;
    }).join('');
  }
}

function toggleGroup(pk){
  const el=document.getElementById('pgt_'+pk);
  const btn=document.querySelector('#pg_'+pk+' .priority-group-toggle');
  if(!el)return;
  const hidden=el.style.display==='none';
  el.style.display=hidden?'grid':'none';
  btn.textContent=hidden?'‚ñæ collapse':'‚ñ∏ expand';
}

function openDetail(id){openDetailId=id;renderDetail();document.getElementById('detailPanel').style.display='flex';}
function closeDetail(){openDetailId=null;document.getElementById('detailPanel').style.display='none';}

function renderDetail(){
  if(!openDetailId)return;
  const t=tasks.find(x=>x.id===openDetailId);if(!t){closeDetail();return;}
  const p=P[t.priority]||P.medium,s_=S[t.status]||S.todo,due=fd(t.due);
  const comments=t.comments&&typeof t.comments==='object'?Object.entries(t.comments).map(([k,v])=>({id:k,...v})).sort((a,b)=>a.ts-b.ts):[];
  const acts=activity.filter(a=>a.taskId===t.id).slice(0,12);
  const canEdit=isAdmin();
  const mOpts=members.map(m=>`<option value="${m.id}" ${t.assigneeId===m.id?'selected':''}>${esc(m.name)}</option>`).join('');
  const sOpts=Object.entries(S).map(([k,v])=>`<option value="${k}" ${t.status===k?'selected':''}>${v.label}</option>`).join('');
  const pOpts=Object.entries(P).map(([k,v])=>`<option value="${k}" ${t.priority===k?'selected':''}>${v.icon} ${v.label}</option>`).join('');
  document.getElementById('detailPanel').innerHTML=`
    <div class="dh">
      <div style="display:flex;gap:5px">
        ${canEdit?`<button class="btn btn-ghost btn-sm" onclick="openTaskModal('${t.id}')">‚úè Edit</button><button class="btn btn-danger btn-sm" onclick="deleteTask('${t.id}')">üóë Delete</button>`:''}
      </div>
      <button class="icon-btn" onclick="closeDetail()">‚úï</button>
    </div>
    <div class="db">
      <div class="detail-title">${esc(t.title)}</div>
      <div class="meta-grid">
        <div class="mi"><div class="ml">Status</div>${canEdit||t.assigneeId===currentUser?.uid?`<select class="ms" onchange="qu('${t.id}','status',this.value)">${sOpts}</select>`:`<span style="font-size:.8rem;font-weight:600">${s_.label}</span>`}</div>
        <div class="mi"><div class="ml">Priority</div>${canEdit?`<select class="ms" onchange="qu('${t.id}','priority',this.value)">${pOpts}</select>`:`<span style="font-size:.8rem;font-weight:600">${p.icon} ${p.label}</span>`}</div>
        <div class="mi"><div class="ml">Assigned To</div>${canEdit?`<select class="ms" onchange="qu('${t.id}','assigneeId',this.value)"><option value="" ${!t.assigneeId?'selected':''}>Unassigned</option>${mOpts}</select>`:`<span style="font-size:.8rem;font-weight:600">${members.find(m=>m.id===t.assigneeId)?.name||'Unassigned'}</span>`}</div>
        <div class="mi"><div class="ml">Due Date</div><div style="font-size:.8rem;font-weight:600;color:${due?.cls==='overdue'?'#c41a2d':due?.cls==='warning'?'#c4921a':'var(--ink)'}">${due?due.text:'‚Äî'}</div></div>
        <div class="mi"><div class="ml">Assigned On</div><div style="font-size:.8rem;font-weight:600;color:var(--ink)">${t.assignedAt?new Date(t.assignedAt).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):'‚Äî'}</div></div>
      </div>
      ${t.description?`<div class="detail-desc">${esc(t.description)}</div>`:''}
      <div class="stitle">Comments (${comments.length})</div>
      <div class="comments-list">
        ${comments.length===0?'<p style="font-size:.78rem;color:var(--ink-dim);font-style:italic">No comments yet.</p>':''}
        ${comments.map(c=>{const a=members.find(m=>m.id===c.authorId);const canDel=c.authorId===currentUser?.uid||isAdmin();return`<div class="cmt">${av(a||{name:'?',color:'#999'},25)}<div class="cmtb"><div class="cmth"><span class="ca">${esc(a?.name||'Unknown')}</span><span class="ct2">${ta(c.ts)}</span>${canDel?`<button class="cdel" onclick="delComment('${t.id}','${c.id}')">Delete</button>`:''}</div><p class="cmtt">${esc(c.body)}</p></div></div>`;}).join('')}
      </div>
      <div class="cform">
        ${av(currentUserProfile||{name:'?',color:'#999'},25)}
        <div class="cwrap">
          <textarea class="input" id="ci" placeholder="Write a comment‚Ä¶ (Ctrl+Enter to post)" rows="2" onkeydown="if((event.ctrlKey||event.metaKey)&&event.key==='Enter')postComment('${t.id}')" style="min-height:50px;resize:vertical"></textarea>
          <div style="display:flex;justify-content:flex-end"><button class="btn btn-primary btn-sm" onclick="postComment('${t.id}')">Post</button></div>
        </div>
      </div>
      <div class="stitle" style="margin-top:16px">Activity</div>
      <div class="alist">${acts.map(a=>{const m=members.find(x=>x.id===a.memberId);return`<div class="ait"><div class="adot"></div><span class="atxt"><strong>${esc(m?.name||'Someone')}</strong> ${esc(a.detail)}</span><span class="atime">${ta(a.ts)}</span></div>`;}).join('')}</div>
    </div>`;
}

// ‚îÄ‚îÄ CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function qu(tid,field,val){
  const t=tasks.find(x=>x.id===tid);if(!t)return;
  const upd={};upd[field]=val||null;
  if(field==='assigneeId')upd.assignedAt=val?Date.now():null;
  if(field==='status'){upd.finishedAt=val==='done'?Date.now():null;}
  await update(ref(db,`tasks/${tid}`),upd);
  let detail='';
  if(field==='status')detail=`Status changed to ${S[val]?.label||val}`;
  else if(field==='priority')detail=`Priority changed to ${P[val]?.label||val}`;
  else if(field==='assigneeId'){const m=members.find(x=>x.id===val);detail=m?`Assigned to ${m.name}`:'Unassigned';}
  if(detail)await log(tid,currentUser.uid,detail);
}

async function postComment(tid){
  const inp=document.getElementById('ci');const body=inp?.value?.trim();if(!body)return;
  await push(ref(db,`tasks/${tid}/comments`),{authorId:currentUser.uid,body,ts:Date.now()});
  await log(tid,currentUser.uid,`Commented: "${body.slice(0,60)}"`);
}

async function delComment(tid,cid){await remove(ref(db,`tasks/${tid}/comments/${cid}`));}

async function deleteTask(tid){
  if(!confirm('Delete this task?'))return;
  await remove(ref(db,`tasks/${tid}`));
  closeDetail();toast('üóë Task deleted');
}

function openTaskModal(tid){
  if(!isAdmin()){toast('Only admins can create/edit tasks.');return;}
  const t=tid?tasks.find(x=>x.id===tid):null;
  document.getElementById('tmTitle').textContent=t?'Edit Task':'New Task';
  document.getElementById('editId').value=tid||'';
  document.getElementById('tTitle').value=t?.title||'';
  document.getElementById('tDesc').value=t?.description||'';
  document.getElementById('tStatus').value=t?.status||'todo';
  document.getElementById('tPriority').value=t?.priority||'medium';
  document.getElementById('tDue').value=t?.due||'';
  document.getElementById('tAssignee').innerHTML=`<option value="">‚Äî Unassigned ‚Äî</option>`+members.map(m=>`<option value="${m.id}" ${t?.assigneeId===m.id?'selected':''}>${esc(m.name)}</option>`).join('');
  const cfg=getEmailConfig();
  const note=document.getElementById('emailNote');
  if(cfg){note.className='info-box';note.textContent='‚úÖ EmailJS configured ‚Äî assignee will receive an email!';}
  else{note.className='warn-box';note.innerHTML='‚ö†Ô∏è EmailJS not configured. <a href="#" onclick="closeTaskModal();openEmailConfig();return false" style="color:var(--accent)">Set it up here</a> to enable email notifications.';}
  document.getElementById('taskModal').style.display='flex';
  setTimeout(()=>document.getElementById('tTitle').focus(),50);
}
function closeTaskModal(){document.getElementById('taskModal').style.display='none';}

async function saveTask(){
  const title=document.getElementById('tTitle').value.trim();
  if(!title)return alert('Please enter a title!');
  const eid=document.getElementById('editId').value;
  const assigneeId=document.getElementById('tAssignee').value||null;
  const prevTask=eid?tasks.find(x=>x.id===eid):null;
  const prevAssignee=prevTask?.assigneeId||null;
  // only update assignedAt if assignee actually changed or it's a new task
  const assignedAt=!assigneeId?null:assigneeId!==prevAssignee?Date.now():(prevTask?.assignedAt||Date.now());
  const data={title,description:document.getElementById('tDesc').value.trim(),status:document.getElementById('tStatus').value,priority:document.getElementById('tPriority').value,assigneeId,due:document.getElementById('tDue').value||null,assignedAt};

  if(eid){
    await update(ref(db,`tasks/${eid}`),data);
    await log(eid,currentUser.uid,'Task updated');
    // send email if assignee changed
    if(assigneeId&&assigneeId!==prevAssignee){
      const assignee=members.find(m=>m.id===assigneeId);
      await sendTaskEmail({...data,id:eid},assignee);
    }
  } else {
    const newId=uid();
    await set(ref(db,`tasks/${newId}`),{...data,createdBy:currentUser.uid,ts:Date.now(),comments:{}});
    await log(newId,currentUser.uid,`Task created with priority ${data.priority}`);
    // send email to assignee
    if(assigneeId){
      const assignee=members.find(m=>m.id===assigneeId);
      await sendTaskEmail({...data,id:newId},assignee);
    }
  }
  closeTaskModal();toast('‚úÖ Task saved!');
}

function renderActivity(){
  if(currentView!=='activity')return;
  const list=document.getElementById('feedList');
  // members only see their own activity
  const scopedActivity=isAdmin()?activity:activity.filter(a=>a.memberId===currentUser?.uid);
  const sub=document.getElementById('activitySubtitle');
  if(sub)sub.textContent=isAdmin()?'Everything that\'s happened across all tasks':'Your recent activity';
  if(scopedActivity.length===0){list.innerHTML='<p style="color:var(--ink-dim);font-style:italic">No activity yet.</p>';return;}
  list.innerHTML=scopedActivity.slice(0,60).map(a=>{
    const m=members.find(x=>x.id===a.memberId),t=tasks.find(x=>x.id===a.taskId);
    return`<div class="feed-item"><div style="flex-shrink:0">${av(m||{name:'?',color:'#999'},28)}</div><div class="fc"><span class="fact">${esc(m?.name||'Someone')}</span><span class="fac"> ${esc(a.detail)}</span>${t?` on <button class="ftl" onclick="switchView('tasks');openDetail('${t.id}')">${esc(t.title)}</button>`:''}</div><span class="ftime">${ta(a.ts)}</span></div>`;
  }).join('');
}

function renderTeam(){
  if(currentView!=='team')return;
  const grid=document.getElementById('teamGrid');
  if(members.length===0){grid.innerHTML='<p style="color:var(--ink-dim)">No members yet.</p>';return;}
  grid.innerHTML=members.map(m=>{
    const open=tasks.filter(t=>t.assigneeId===m.id&&t.status!=='done').length;
    const total=tasks.filter(t=>t.assigneeId===m.id).length;
    return`<div class="mc">${av(m,42)}<div style="flex:1"><div class="mn">${esc(m.name)} <span class="role-badge ${m.role==='admin'?'role-admin':'role-member'}">${m.role}</span></div><div class="me">${esc(m.email)}</div><div class="ms2">${open} open ¬∑ ${total} total tasks</div></div><button class="btn btn-ghost btn-sm" onclick="switchView('tasks');tf('assignee','${m.id}')">View Tasks</button></div>`;
  }).join('');
}

// ‚îÄ‚îÄ email config button in header (admin only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addEmailButton(){
  const hr=document.getElementById('app').querySelector('.header-right');
  if(!document.getElementById('emailConfigBtn')&&isAdmin()){
    const b=document.createElement('button');
    b.id='emailConfigBtn';b.className='btn btn-ghost btn-sm';b.textContent='üìß Email Setup';
    b.onclick=openEmailConfig;
    hr.insertBefore(b,hr.querySelector('.sync-label'));
  }
}

function clearReportFilters(){
  ['reportMemberFilter','reportStatusFilter','reportPriorityFilter'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  ['reportDateFrom','reportDateTo'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  renderReport();
}

function renderReport(){
  if(currentView!=='report')return;
  // populate member filter preserving selection
  const mf=document.getElementById('reportMemberFilter');
  const curMem=mf.value;
  mf.innerHTML='<option value="">All Members</option>'+members.map(m=>`<option value="${m.id}" ${curMem===m.id?'selected':''}>${esc(m.name)}</option>`).join('');

  const mFilter=document.getElementById('reportMemberFilter').value;
  const sFilter=document.getElementById('reportStatusFilter').value;
  const pFilter=document.getElementById('reportPriorityFilter').value;
  const dateFrom=document.getElementById('reportDateFrom').value;
  const dateTo=document.getElementById('reportDateTo').value;
  const fromTs=dateFrom?new Date(dateFrom+'T00:00:00').getTime():null;
  const toTs=dateTo?new Date(dateTo+'T23:59:59').getTime():null;

  let rows=tasks.filter(t=>t.assigneeId);
  if(mFilter)rows=rows.filter(t=>t.assigneeId===mFilter);
  if(sFilter)rows=rows.filter(t=>t.status===sFilter);
  if(pFilter)rows=rows.filter(t=>t.priority===pFilter);
  if(fromTs){rows=rows.filter(t=>{const ts=t.assignedAt||t.ts||0;return ts>=fromTs;});}
  if(toTs){rows=rows.filter(t=>{const ts=t.assignedAt||t.ts||0;return ts<=toTs;});}
  rows.sort((a,b)=>{const ma=members.find(x=>x.id===a.assigneeId)?.name||'';const mb=members.find(x=>x.id===b.assigneeId)?.name||'';return ma.localeCompare(mb)||a.ts-b.ts;});

  // summary cards
  const total=rows.length;
  const done=rows.filter(t=>t.status==='done').length;
  const delayed=rows.filter(t=>{if(!t.due)return false;const due=new Date(t.due+'T23:59:59');const fin=t.finishedAt?new Date(t.finishedAt):new Date();return fin>due&&t.status!=='done'?true:t.finishedAt&&new Date(t.finishedAt)>due;}).length;
  const inprog=rows.filter(t=>t.status==='in_progress'||t.status==='review').length;
  document.getElementById('reportSummary').innerHTML=`
    <div class="rs-card"><div class="rs-num">${total}</div><div class="rs-lbl">Total Tasks</div></div>
    <div class="rs-card"><div class="rs-num" style="color:var(--green)">${done}</div><div class="rs-lbl">Completed</div></div>
    <div class="rs-card"><div class="rs-num" style="color:#1a5fa0">${inprog}</div><div class="rs-lbl">In Progress</div></div>
    <div class="rs-card"><div class="rs-num" style="color:var(--red)">${delayed}</div><div class="rs-lbl">Delayed</div></div>
    <div class="rs-card"><div class="rs-num" style="color:#c4921a">${total-done}</div><div class="rs-lbl">Pending</div></div>`;

  const tbody=document.getElementById('reportBody');
  const empty=document.getElementById('reportEmpty');
  const table=document.getElementById('reportTable');
  if(rows.length===0){table.style.display='none';empty.style.display='flex';return;}
  table.style.display='table';empty.style.display='none';

  tbody.innerHTML=rows.map((t,i)=>{
    const m=members.find(x=>x.id===t.assigneeId);
    const p=P[t.priority]||P.medium;
    const s_=S[t.status]||S.todo;
    const assignedDate=t.assignedAt?new Date(t.assignedAt).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):t.ts?new Date(t.ts).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):'‚Äî';
    const finishedDate=t.finishedAt?new Date(t.finishedAt).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}):t.status==='done'?'Completed':'‚Äî';
    // delay days calculation
    let delayHtml='<span class="rt-delay-na">‚Äî</span>';
    if(t.due){
      const dueDate=new Date(t.due+'T23:59:59');
      const compareDate=t.finishedAt?new Date(t.finishedAt):(t.status!=='done'?new Date():null);
      if(compareDate){
        const diff=Math.ceil((compareDate-dueDate)/86400000);
        if(diff<=0)delayHtml=`<span class="rt-delay-ok">‚úì On time</span>`;
        else if(diff<=3)delayHtml=`<span class="rt-delay-warn">+${diff}d</span>`;
        else delayHtml=`<span class="rt-delay-bad">+${diff}d</span>`;
      }
    }
    return`<tr>
      <td class="rt-sno">${i+1}</td>
      <td><div class="rt-name">${av(m||{name:'?',color:'#999'},26)}<span>${esc(m?.name||'Unassigned')}</span></div></td>
      <td class="rt-task">${esc(t.title)}</td>
      <td><span class="badge" style="color:${p.color};background:${p.bg}">${p.icon} ${p.label}</span></td>
      <td class="rt-date">${assignedDate}</td>
      <td class="rt-date" style="color:${t.status==='done'?'var(--green)':'var(--ink-mid)'}">${finishedDate}</td>
      <td>${delayHtml}</td>
    </tr>`;
  }).join('');
}

function exportReportCSV(){
  const mFilter=document.getElementById('reportMemberFilter').value;
  const sFilter=document.getElementById('reportStatusFilter').value;
  const pFilter=document.getElementById('reportPriorityFilter').value;
  const dateFrom=document.getElementById('reportDateFrom').value;
  const dateTo=document.getElementById('reportDateTo').value;
  const fromTs=dateFrom?new Date(dateFrom+'T00:00:00').getTime():null;
  const toTs=dateTo?new Date(dateTo+'T23:59:59').getTime():null;
  let rows=tasks.filter(t=>t.assigneeId);
  if(mFilter)rows=rows.filter(t=>t.assigneeId===mFilter);
  if(sFilter)rows=rows.filter(t=>t.status===sFilter);
  if(pFilter)rows=rows.filter(t=>t.priority===pFilter);
  if(fromTs)rows=rows.filter(t=>{const ts=t.assignedAt||t.ts||0;return ts>=fromTs;});
  if(toTs)rows=rows.filter(t=>{const ts=t.assignedAt||t.ts||0;return ts<=toTs;});
  rows.sort((a,b)=>{const ma=members.find(x=>x.id===a.assigneeId)?.name||'';const mb=members.find(x=>x.id===b.assigneeId)?.name||'';return ma.localeCompare(mb)||a.ts-b.ts;});
  const headers=['S.No','Member Name','Task Name','Task Type (Priority)','Assigned Date','Finished Date','Delay Days'];
  const csvRows=rows.map((t,i)=>{
    const m=members.find(x=>x.id===t.assigneeId);
    const p=P[t.priority]||P.medium;
    const assignedDate=t.assignedAt?new Date(t.assignedAt).toLocaleDateString('en-IN'):t.ts?new Date(t.ts).toLocaleDateString('en-IN'):'';
    const finishedDate=t.finishedAt?new Date(t.finishedAt).toLocaleDateString('en-IN'):t.status==='done'?'Completed':'Pending';
    let delay='';
    if(t.due){
      const dueDate=new Date(t.due+'T23:59:59');
      const compareDate=t.finishedAt?new Date(t.finishedAt):(t.status!=='done'?new Date():null);
      if(compareDate){const diff=Math.ceil((compareDate-dueDate)/86400000);delay=diff<=0?'On time':'+'+diff+' days';}
    }
    return[i+1,m?.name||'Unassigned',t.title,p.label,assignedDate,finishedDate,delay].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
  });
  const csv=[headers.join(','),...csvRows].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='taskflow-report.csv';a.click();URL.revokeObjectURL(url);
  toast('‚úÖ Report exported!');
}

function switchView(view){
  currentView=view;
  const vMap={tasks:'block',activity:'flex',team:'flex',report:'flex'};
  ['tasks','activity','team','report'].forEach(v=>{const el=document.getElementById(v+'View');if(el)el.style.display=v===view?vMap[v]:'none';});
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',['tasks','activity','team','report'][i]===view));
  if(view==='activity')renderActivity();
  if(view==='team')renderTeam();
  if(view==='tasks')renderTasks();
  if(view==='report')renderReport();
}

document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeTaskModal();closeDetail();closeEmailModal();}});

// init emailjs if already configured
const savedEmail=localStorage.getItem('tf_email');
if(savedEmail){try{const c=JSON.parse(savedEmail);emailjs.init(c.pubkey);}catch(e){}}

// add email button once profile loads
const _origUpdate=updateUserHeader;
window._profileReady=()=>{if(isAdmin())addEmailButton();};
</script>
</body>
</html>
